<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.16.11"><!-- Canonical URL --><link rel="canonical" href="https://tech-lessons.in/en/blog/cache_line_hashtable/"><!-- Primary Meta Tags --><title>Cache-Line Hash Table</title><meta name="title" content="Cache-Line Hash Table"><meta name="description" content="Cache-Line Hash Table"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tech-lessons.in/en/blog/cache_line_hashtable/"><meta property="og:title" content="Cache-Line Hash Table"><meta property="og:description" content="Cache-Line Hash Table"><meta property="og:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tech-lessons.in/en/blog/cache_line_hashtable/"><meta property="twitter:title" content="Cache-Line Hash Table"><meta property="twitter:description" content="Cache-Line Hash Table"><meta property="twitter:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script><script>
	window.dataLayer = window.dataLayer || [];
	function gtag() {
		dataLayer.push(arguments);
	}
	gtag("js", new Date());

	gtag("config", "G-9KKTKFQ2CM");
</script><link rel="stylesheet" href="/_astro/about.Dq19AYy-.css"></head> <body class="bg-white text-zinc-900 min-h-screen flex flex-col md:flex-row selection:bg-black selection:text-white"> <header class="md:hidden sticky top-0 z-50 bg-slate-900 border-b border-slate-800 text-white"> <div class="flex items-center justify-between px-6 py-4"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="mobile-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Toggle menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="3" y1="12" x2="21" y2="12"></line> <line x1="3" y1="6" x2="21" y2="6"></line> <line x1="3" y1="18" x2="21" y2="18"></line> </svg> </button> </div> <!-- Mobile Menu Overlay --> <div id="mobile-menu" class="fixed inset-0 bg-slate-900 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-screen overflow-y-auto"> <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Close menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <nav class="flex flex-col p-6 gap-2"> <a href="/" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <div class="mt-auto p-6 border-t border-slate-800"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3 block mb-4">Contact</span> <div class="flex flex-col gap-2"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </div> </header> <script type="module">const t=document.getElementById("mobile-menu-btn"),n=document.getElementById("close-menu-btn"),e=document.getElementById("mobile-menu");t&&n&&e&&(t.addEventListener("click",()=>{e.classList.remove("translate-x-full")}),n.addEventListener("click",()=>{e.classList.add("translate-x-full")}),e.querySelectorAll("a").forEach(l=>{l.addEventListener("click",()=>{e.classList.add("translate-x-full")})}));</script> <aside class="hidden md:flex flex-col w-[280px] h-screen sticky top-0 border-r border-slate-800 bg-slate-900 p-8 shrink-0"> <!-- Profile --> <div class="flex flex-col items-start mb-12"> <div class="w-16 h-16 rounded-full border-2 border-slate-700 shadow-sm overflow-hidden mb-4 relative bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <h2 class="font-bold text-lg text-white leading-tight">
Sarthak Makhija
</h2> <span class="text-sm text-zinc-400">Databases & Storage Systems</span> </div> <!-- Navigation --> <nav class="flex-1 flex flex-col gap-1"> <a href="/" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <line x1="12" y1="20" x2="12" y2="10"></line> <line x1="18" y1="20" x2="18" y2="4"></line> <line x1="6" y1="20" x2="6" y2="16"></line> </svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <!-- Socials --> <div class="mt-auto pt-8 border-t border-slate-800 flex flex-col gap-4"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3">Contact</span> <div class="flex flex-col gap-1"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </aside> <div class="flex-1 flex flex-col min-w-0"> <main class="flex-1 max-w-[1280px] mx-auto px-6 py-12 md:py-20 w-full">  <article class="max-w-[1280px] mx-auto min-w-0"> <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12 items-start"> <div class="min-w-0"> <!-- Article Header --> <header class="mb-12"> <h1 class="text-[40px] md:text-[48px] font-sans font-extrabold text-black leading-[1.2] mb-6 tracking-tight"> Cache-Line Hash Table </h1> <div class="flex items-center gap-4 text-[16px] text-zinc-500 mb-8 border-b border-zinc-100 pb-8"> <time datetime="2024-04-19T00:00:00.000Z" class="text-zinc-400"> Apr 19, 2024 </time> <span>/</span> <span>CPU Cache-Line, Hash Table, CLHT, Cache-Line Hash Table, Golang, xsync</span> </div> <div class="w-full mb-12"> <img width="1020" height="510" src="/clht_title.webp" alt="" class="w-full rounded-md shadow-sm"> <p class="text-left text-zinc-500 italic mt-3 text-sm"> Background by Eva Bronzini on Pexels </p> </div> </header> <!-- Table of Contents (Mobile Only) --> <div class="lg:hidden bg-gray-50 rounded-lg p-6 mb-12 border border-zinc-100"> <h2 class="text-black font-bold font-sans text-[16px] uppercase tracking-wide mb-4">
Table of contents
</h2> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introduction" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introduction </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-cpu-cache-line-and-cache-coherency" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding CPU Cache line and Cache Coherency </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-clht-cache-line-hash-table" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding CLHT (Cache-Line Hash table) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-the-load-operation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Load Operation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-the-store-operation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Store Operation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#identifying-the-bucket" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Identifying the bucket </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#acquire-a-lock-on-the-identified-bucket" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Acquire a lock on the identified bucket </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#identify-an-empty-entry-slot" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Identify an empty entry slot </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#store-the-keyvalue-pair-in-an-empty-entry-slot" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Store the key/value pair in an empty entry slot </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#store-in-a-new-bucket-if-all-the-linearly-linked-buckets-at-the-identified-bucket-index-are-full" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Store in a new bucket, if all the linearly linked buckets at the identified bucket index are full </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-the-resize-operation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Resize Operation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#ensure-one-resize-at-a-time" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Ensure one resize at a time </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#access-the-current-table-atomically" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Access the current table atomically </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#increase-the-table-size-locally" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Increase the table size locally </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#remap-the-existing-keys" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Remap the existing keys </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#finish-resize" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Finish resize </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#mentions" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Mentions </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </div> <!-- Article Content --> <div class="prose prose-lg max-w-none text-black
            [&_h1]:font-serif [&_h1]:font-bold [&_h1]:text-black [&_h1]:text-[36px] [&_h1]:mt-10 [&_h1]:mb-4
            [&_h2]:font-serif [&_h2]:font-bold [&_h2]:text-black [&_h2]:text-[30px] [&_h2]:mt-10 [&_h2]:mb-6
            [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-black [&_h3]:text-[24px] [&_h3]:mt-10 [&_h3]:mb-4
            [&_h4]:font-sans [&_h4]:font-bold [&_h4]:text-black [&_h4]:text-[18px] [&_h4]:mt-8 [&_h4]:mb-4
            [&_p]:font-sans [&_p]:text-[1.125rem] [&_p]:leading-[1.7777778] [&_p]:text-zinc-800 [&_p]:my-[1em]
            [&_a]:underline [&_a]:decoration-zinc-400 [&_a]:transition-all
            
            /* Table Styling */
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:border [&_table]:border-zinc-200 [&_table]:rounded-lg [&_table]:overflow-hidden
            [&_th]:text-left [&_th]:p-3 [&_th]:border-b [&_th]:border-zinc-200 [&_th]:bg-zinc-50 [&_th]:font-semibold [&_th]:text-zinc-900
            [&_td]:p-3 [&_td]:border-b [&_td]:border-zinc-200 [&_td]:text-zinc-700
            [&_tr:last-child_td]:border-0
            
            [&_li]:text-[1.125rem] [&_li]:leading-[1.7777778] [&_li]:text-zinc-800 [&_li]:mb-2
            [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-6
            [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-6
            [&_img]:rounded-md [&_img]:shadow-lg [&_img]:my-8
            [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-zinc-500 [&_figcaption]:italic [&_figcaption]:mt-[-20px] [&_figcaption]:mb-8
            [&_blockquote]:relative [&_blockquote]:bg-zinc-100 [&_blockquote]:text-zinc-700 [&_blockquote]:p-8 [&_blockquote]:rounded-2xl [&_blockquote]:my-10 [&_blockquote]:not-italic [&_blockquote]:text-[1.1rem] [&_blockquote]:leading-relaxed [&_blockquote]:ml-24
            [&_blockquote::before]:content-[''] [&_blockquote::before]:absolute [&_blockquote::before]:top-8 [&_blockquote::before]:-left-3 [&_blockquote::before]:border-t-[12px] [&_blockquote::before]:border-t-transparent [&_blockquote::before]:border-b-[12px] [&_blockquote::before]:border-b-transparent [&_blockquote::before]:border-r-[16px] [&_blockquote::before]:border-r-zinc-100
            [&_blockquote::after]:content-[''] [&_blockquote::after]:absolute [&_blockquote::after]:-left-32 [&_blockquote::after]:-top-2 [&_blockquote::after]:w-28 [&_blockquote::after]:h-28 [&_blockquote::after]:bg-[url('/avatar.png')] [&_blockquote::after]:bg-contain [&_blockquote::after]:bg-no-repeat [&_blockquote::after]:bg-center [&_blockquote::after]:rounded-full [&_blockquote::after]:border-4 [&_blockquote::after]:border-white [&_blockquote::after]:shadow-md
            [&_pre]:p-6 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:my-8
            [&_code]:font-mono [&_code]:text-[14px] [&_code]:leading-relaxed"> <h3 id="introduction">Introduction</h3>
<p>In the world of multi-core processors, managing concurrent access to data structures is crucial for efficient performance. But frequent updates can trigger a hidden bottleneck: cache coherence traffic. This traffic arises when one core modifies the data another core has cached, forcing updates and invalidation across the system.</p>
<p>This article dives into a clever solution: the Cache-Line Hash Table (CLHT).  CLHTs are specifically designed to minimize this cache coherence traffic, boosting the speed of concurrent data access. We’ll explore the core ideas behind CLHTs, including:</p>
<ul>
<li><strong>One Bucket Per CPU Cache-Line</strong>: By cleverly aligning buckets with CPU cache line sizes, CLHTs minimize the number of lines written during updates.</li>
<li><strong>In-Place Updates</strong>: Instead of shuffling data around, CLHTs update key-value pairs directly within the bucket, reducing memory movement.</li>
<li><strong>Lock-Free Reads</strong>: Reads are designed to be lock-free, meaning they can proceed without acquiring locks, further enhancing performance.</li>
</ul>
<h3 id="understanding-cpu-cache-line-and-cache-coherency">Understanding CPU Cache line and Cache Coherency</h3>
<p>To execute an instruction, CPUs need to fetch the instruction and its data (John von Neumann’s design) (from RAM/caches). Accessing RAM (/DRAM) for fetching data and instruction is expensive, usually in the orders of 50-100ns. To minimize the latency cost, CPUs have caches: L1, L2, L3 and in some cases L4. While L1 and L2 caches are private to each core, L3 can be shared between cores. The size of these caches increase from L1 to L4, and so does the latency cost.</p>
<p>Let’s focus on data access.</p>
<p>Anytime a CPU executes an operation, it checks for the required data in the cache hierarchy, in the following order L1, L2, L3 and (/L4). If the data is not available in any of these caches, it is fetched from RAM and stored in these caches.</p>
<p>Let’s consider that a program needs to read the value at index <code>i</code> of an <code>uint64</code> array. When a CPU executes this instruction, it won’t fetch just the <code>8 bytes</code> of value. Instead, it will fetch a contiguous chunk of memory, on x86 systems this chunk is 64 bytes in size. This chunk is called <strong>CPU cache line</strong>. This means, all the CPU caches organize the data in form of cache lines. This approach improves efficiency by fetching multiple potentially related pieces of data in one go.</p>
<p>On multi-core processors it is possible for multiple cores to cache the same chunk of memory in their own L1 or L2 cache. This means, the same cache line can be present in different cores.</p>
<p>Continuing with our previous example of the arrray, imagine a thread <em>A</em> running on CPU 1 and other thread <em>B</em> running on CPU 2 have cached the same cache line corresponding to the array indices 0-7. Consider that thread <em>A</em> modifies the value at index 5. This means the cached copy of this cache line is stale on CPU 2.</p>
<p><strong>Cache coherency</strong> is the problem of ensuring that local caches in a multi-core processor system stay in sync. The problem is solved by a hardware device called “cache controller” which will invalidate the local copy of the cache on CPU 2 and the invalidated cache line will be refetched from RAM.</p>
<p>One of the goals behind CLHTs is to minimize this cache coherence traffic.</p>
<h3 id="understanding-clht-cache-line-hash-table">Understanding CLHT (Cache-Line Hash table)</h3>
<p>CLHT stands for cache-line hash table as it tries to put one bucket per CPU cache line. The core idea behind the design of CLHT is to minimize the amount cache coherence traffic. In concurrent data structures, <strong>cache coherence traffic</strong> is generated when a thread running on a core updates a cache line while the other remote cores hold the same cache line. In this scenario, cache coherence protocol would kick in, thus requiring the other cores to invalidate the cache line and fetch it from RAM.</p>
<p>CLHT has the following ideas:</p>
<ul>
<li>Minimize the cache coherence traffic by reducing the number of cache lines that are written in a store operation</li>
<li>Perform in-place update of key/value pairs</li>
<li>Take no locks during read (/get) operations</li>
</ul>
<p>I will be taking the example of the <a href="https://github.com/puzpuzpuz/xsync/blob/main/mapof.go">MapOf</a> implementation from <a href="https://github.com/puzpuzpuz/xsync/">xsync</a> which is a CLHT-inspired concurrent hash map.</p>
<p>The core abstraction <code>MapOf</code> contains an <a href="https://pkg.go.dev/unsafe#Pointer">unsafe pointer</a> to the <code>mapOfTable</code> struct.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> MapOf</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">K</span><span style="color:#B392F0"> comparable</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">V</span><span style="color:#B392F0"> any</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	//other fields omitted.</span></span>
<span class="line"><span style="color:#E1E4E8">	table        </span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#6A737D"> // *mapOfTable</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The abstraction <code>mapOfTable</code> contains a slice of buckets.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> entriesPerMapBucket</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">K</span><span style="color:#B392F0"> comparable</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">V</span><span style="color:#B392F0"> any</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    //other fields omitted.</span></span>
<span class="line"><span style="color:#E1E4E8">	buckets []</span><span style="color:#B392F0">bucketOfPadded</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> bucketOfPadded</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    pad [</span><span style="color:#B392F0">cacheLineSize</span><span style="color:#F97583"> -</span><span style="color:#B392F0"> unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">bucketOf</span><span style="color:#E1E4E8">{})]</span><span style="color:#F97583">byte</span></span>
<span class="line"><span style="color:#B392F0">    bucketOf</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> bucketOf</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    hashes  [</span><span style="color:#B392F0">entriesPerMapBucket</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">uint64</span></span>
<span class="line"><span style="color:#E1E4E8">    entries [</span><span style="color:#B392F0">entriesPerMapBucket</span><span style="color:#E1E4E8">]</span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#6A737D"> // *entryOf</span></span>
<span class="line"><span style="color:#E1E4E8">    next    </span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#6A737D">                      // *bucketOfPadded</span></span>
<span class="line"><span style="color:#E1E4E8">    mu      </span><span style="color:#B392F0">sync</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Mutex</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> entryOf</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">K</span><span style="color:#B392F0"> comparable</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">V</span><span style="color:#B392F0"> any</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    key   </span><span style="color:#B392F0">K</span></span>
<span class="line"><span style="color:#E1E4E8">    value </span><span style="color:#B392F0">V</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The buckets are linearly linked using the <code>next</code> field at each index. CLHT puts one bucket per CPU cache line, this simply means that the size of each bucket should be equal to the <a href="https://docs.rs/crossbeam-utils/latest/crossbeam_utils/struct.CachePadded.html">CPU cache line size</a>.</p>
<p>With <code>entriesPerMapBucket</code> as 3, the size of a single instance of <code>bucketOf</code> is 64 bytes, which is the size of CPU cache line on x86 systems.
Each instance of <code>bucketOf</code> contains three hashes and three entries.</p>
<p>Each entry is an unsafe pointer to the <code>entryOf</code> struct which contains a key/value pair.</p>
<blockquote>
<p>The abstraction <code>MapOf</code> uses unsafe pointers which are later used in atomic pointer operations, like <code>atomic.StorePointer(&#x26;b.entries[i], unsafe.Pointer(newEntry))</code>.</p>
</blockquote>
<blockquote>
<p>An unsafe pointer represents a pointer an arbitrary type.
Let’s take a quick example of converting a byte slice to string using unsafe.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> toString</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">buffer</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   unsafePointer </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">buffer)</span></span>
<span class="line"><span style="color:#E1E4E8">   stringPointer </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#F97583">string</span><span style="color:#E1E4E8">)(unsafePointer)</span></span>
<span class="line"><span style="color:#E1E4E8">   </span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">stringPointer</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This snippet creates an unsafe pointer using the address of the byte slice, casts it to a string pointer and then
dereferences it to get string. This works because both the byte slice and the string share an equivalent memory
layout and the resulting string is not larger than the input byte slice.</p>
</blockquote>
<p>The design of xsync <code>MapOf</code> is presented in the below image.</p>
<div class="align-center-exclude-width-change">
    <img src="/xsync.webp" alt="Design of xsync MapOf">
</div>
<h3 id="understanding-the-load-operation">Understanding the Load Operation</h3>
<p>The <code>Load</code> operation returns the value if the target key is present, else returns a zero value of type V.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">m </span><span style="color:#F97583">*</span><span style="color:#B392F0">MapOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Load</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> K</span><span style="color:#E1E4E8">) (</span><span style="color:#FFAB70">value</span><span style="color:#B392F0"> V</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">ok</span><span style="color:#F97583"> bool</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	table </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])(atomic.</span><span style="color:#B392F0">LoadPointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.table))</span></span>
<span class="line"><span style="color:#E1E4E8">	hash </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> shiftHash</span><span style="color:#E1E4E8">(m.</span><span style="color:#B392F0">hasher</span><span style="color:#E1E4E8">(key, table.seed))</span></span>
<span class="line"><span style="color:#E1E4E8">	bucketIndex </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uint64</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(table.buckets)</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8"> hash</span></span>
<span class="line"><span style="color:#E1E4E8">	rootBucket </span><span style="color:#F97583">:=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">table.buckets[bucketIndex]</span></span>
<span class="line"><span style="color:#E1E4E8">	</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> entriesPerMapBucket; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			h </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> atomic.</span><span style="color:#B392F0">LoadUint64</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">rootBucket.hashes[i])</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> h </span><span style="color:#F97583">==</span><span style="color:#F97583"> uint64</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> h </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> hash {</span></span>
<span class="line"><span style="color:#F97583">				continue</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">			entryPointer </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> atomic.</span><span style="color:#B392F0">LoadPointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">rootBucket.entries[i])</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> entryPointer </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">				continue</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">			entry </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">entryOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])(entryPointer)</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> entry.key </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> key {</span></span>
<span class="line"><span style="color:#F97583">				return</span><span style="color:#E1E4E8"> entry.value, </span><span style="color:#79B8FF">true</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		bucketPointer </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> atomic.</span><span style="color:#B392F0">LoadPointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">rootBucket.next)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> bucketPointer </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			return</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		rootBucket </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">bucketOfPadded</span><span style="color:#E1E4E8">)(bucketPointer)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The idea behind the <code>Load</code> operation can be summarized as:</p>
<ul>
<li>Identify the <code>bucketIndex</code> where the target key may be present. The operation <code>uint64(len(table.buckets)-1) &#x26; hash</code> is same as <code>hash % number of buckets</code>.</li>
<li>Iterate through all entries present in the bucket. There are only three entries in each bucket.</li>
<li>Skip if the hash of the target key does not match the hash at the index <code>i</code> in the bucket.</li>
<li>Atomically load the entry at the index <code>i</code> if the hash at that index matches the hash of the target key.</li>
<li>Compare the target key and the key present in the loaded entry.</li>
<li>Return if the keys match, else continue.</li>
<li>Move onto the next bucket, if present, by atomically loading the next bucket pointer.</li>
</ul>
<p>Here’s a breakdown of the takeaways:</p>
<ol>
<li><strong>Faster comparison using hashes</strong></li>
</ol>
<p>Hash comparison (comparing <code>uint64</code> bits -> 8 bytes) is faster than comparing the actual keys, if the keys are bigger than 8 bytes.
This is an optimization where the keys are only compared after the hash of the target key matches with the hash at an index <code>i</code>. There could be false positives (two keys may have the same hash), hence key comparison is eventually needed.</p>
<ol start="2">
<li><strong>No locks</strong></li>
</ol>
<p>The method <code>Load</code> does not use locks, it loads the three fields (entries, next pointer and hashes) atomically. This means, the <code>Load</code> method will always see their values either before or after the write operation.</p>
<ol start="3">
<li><strong>Cache aligned buckets</strong></li>
</ol>
<p>CLHT puts one bucket per CPU cache line. The <code>Load</code> operation loads the entire bucket (cache line) from RAM to the CPU cache(s). Since, the
entire bucket is loaded in CPU cache(s), any further comparison on entries in the bucket will not need to access RAM.</p>
<h3 id="understanding-the-store-operation">Understanding the Store Operation</h3>
<p>The method <code>Store</code> stores the key/value pair in the map.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">m </span><span style="color:#F97583">*</span><span style="color:#B392F0">MapOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Store</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> K</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">value</span><span style="color:#B392F0"> V</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	m.</span><span style="color:#B392F0">doCompute</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">		key,</span></span>
<span class="line"><span style="color:#F97583">		func</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">bool</span><span style="color:#E1E4E8">) (</span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">bool</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#E1E4E8"> value, </span><span style="color:#79B8FF">false</span></span>
<span class="line"><span style="color:#E1E4E8">		},</span></span>
<span class="line"><span style="color:#79B8FF">		false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">		false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">	)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This method calls <code>doCompute</code>, so we will take a look at that method. However, <code>doCompute</code> does multiple things. So, we will take a look at it in parts.</p>
<h4 id="identifying-the-bucket">Identifying the bucket</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#E1E4E8">table </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])(atomic.</span><span style="color:#B392F0">LoadPointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.table))</span></span>
<span class="line"><span style="color:#E1E4E8">tableLen </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(table.buckets)</span></span>
<span class="line"><span style="color:#E1E4E8">hash </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> shiftHash</span><span style="color:#E1E4E8">(m.</span><span style="color:#B392F0">hasher</span><span style="color:#E1E4E8">(key, table.seed))</span></span>
<span class="line"><span style="color:#E1E4E8">bucketIndex </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uint64</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(table.buckets)</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8"> hash</span></span></code></pre>
<p>The idea can be summarized as:</p>
<ul>
<li>Load the <code>table</code> atomically using <code>atomic.LoadPointer(&#x26;m.table)</code>. The field <code>table</code> is an unsafe pointer that refers to an instance of <code>mapOfTable</code>.</li>
<li>Identify the <code>bucketIndex</code> where the target key has to be stored. The operation <code>uint64(len(table.buckets)-1) &#x26; hash</code> is same as <code>hash % number of buckets</code>.</li>
</ul>
<blockquote>
<p>The field table is refers to an instance of <code>mapOfTable</code>. The abstraction <code>mapOfTable</code> contains a collection of buckets.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">K</span><span style="color:#B392F0"> comparable</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">V</span><span style="color:#B392F0"> any</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  //other fields omitted.</span></span>
<span class="line"><span style="color:#E1E4E8">  buckets []</span><span style="color:#B392F0">bucketOfPadded</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>To ensure that there is always the latest information of the <code>table</code> field, it is loaded atomically.
This atomic access becomes crucial because a previous resize operation might have already changed the internal
structure of the map (adding or removing buckets).
By reading atomically, we avoid any inconsistencies that could lead to errors.</p>
</blockquote>
<h4 id="acquire-a-lock-on-the-identified-bucket">Acquire a lock on the identified bucket</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#E1E4E8">rootBucket </span><span style="color:#F97583">:=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">table.buckets[bucketIndex]</span></span>
<span class="line"><span style="color:#E1E4E8">rootBucket.mu.</span><span style="color:#B392F0">Lock</span><span style="color:#E1E4E8">()</span></span></code></pre>
<p>To prevent multiple goroutines from writing to the same bucket simultaneously, each bucket has a lock. This lock, of the type <code>sync.Mutex</code> in Go, is acquired
within the <code>doCompute</code> method. This ensures that only one goroutine can modify a particular bucket at any given time.</p>
<h4 id="identify-an-empty-entry-slot">Identify an empty entry slot</h4>
<p>This involves finding an empty entry slot in an existing bucket.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> entriesPerMapBucket; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    hashValue </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> atomic.</span><span style="color:#B392F0">LoadUint64</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">currentBucket.hashes[i])</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> hashValue </span><span style="color:#F97583">==</span><span style="color:#F97583"> uint64</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> emptyb </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            emptyb </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> currentBucket</span></span>
<span class="line"><span style="color:#E1E4E8">            emptyidx </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> i</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        continue</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> hashValue </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> hash {</span></span>
<span class="line"><span style="color:#E1E4E8">        hintNonEmpty</span><span style="color:#F97583">++</span></span>
<span class="line"><span style="color:#F97583">        continue</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    entry </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">entryOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])(currentBucket.entries[i])</span></span>
<span class="line"><span style="color:#E1E4E8">    hintNonEmpty</span><span style="color:#F97583">++</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The idea can be summarized as:</p>
<ul>
<li>Iterate through all entries present in the bucket. There are only three entries in each bucket.</li>
<li>Check if the hashValue at index <code>i</code> is zero. Zero hash value signifies an empty entry slot.</li>
<li>If the hashValue at index <code>i</code> is zero, capture the current bucket and the index. This is where the new entry will be stored, if there is no next bucket.</li>
</ul>
<h4 id="store-the-keyvalue-pair-in-an-empty-entry-slot">Store the key/value pair in an empty entry slot</h4>
<p>This involves storing the key/value pair in the existing bucket at an empty entry slot.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> currentBucket.next </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> emptyb </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">        // Insertion into an existing bucket.</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#E1E4E8"> zeroedV </span><span style="color:#B392F0">V</span></span>
<span class="line"><span style="color:#E1E4E8">        newValue, del </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> valueFn</span><span style="color:#E1E4E8">(zeroedV, </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#E1E4E8">        newe </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">entryOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])</span></span>
<span class="line"><span style="color:#E1E4E8">        newe.key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> key</span></span>
<span class="line"><span style="color:#E1E4E8">        newe.value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> newValue</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        // First we update the hash, then the entry.</span></span>
<span class="line"><span style="color:#E1E4E8">        atomic.</span><span style="color:#B392F0">StoreUint64</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">emptyb.hashes[emptyidx], hash)</span></span>
<span class="line"><span style="color:#E1E4E8">        atomic.</span><span style="color:#B392F0">StorePointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">emptyb.entries[emptyidx], unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(newe))</span></span>
<span class="line"><span style="color:#E1E4E8">        rootBucket.mu.</span><span style="color:#B392F0">Unlock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        table.</span><span style="color:#B392F0">addSize</span><span style="color:#E1E4E8">(bucketIndex, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> newValue, computeOnly</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}	</span></span></code></pre>
<p>The idea can be summarized as:</p>
<ul>
<li>Check if there is a next bucket. If there is none and an empty entry slot has been identified, write the new entry at the identified index in the existing bucket.</li>
<li>Create a new instance of <code>entryOf</code> and set the key and value.</li>
<li>Atomically store the hash of the key in the identified entry index using <code>atomic.StoreUint64(&#x26;emptyb.hashes[emptyidx], hash)</code>.</li>
<li>Atomically store the entry pointer in the identified entry index using <code>atomic.StorePointer(&#x26;emptyb.entries[emptyidx], unsafe.Pointer(newe))</code>.</li>
<li>Release the lock</li>
</ul>
<h4 id="store-in-a-new-bucket-if-all-the-linearly-linked-buckets-at-the-identified-bucket-index-are-full">Store in a new bucket, if all the linearly linked buckets at the identified bucket index are full</h4>
<p>Store the key/value pair in a new bucket and link the new bucket atomically.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> currentBucket.next </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // Insertion into a new bucket.</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> zeroedV </span><span style="color:#B392F0">V</span></span>
<span class="line"><span style="color:#E1E4E8">    newValue, del </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> valueFn</span><span style="color:#E1E4E8">(zeroedV, </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Create and append the bucket.</span></span>
<span class="line"><span style="color:#E1E4E8">    newb </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">bucketOfPadded</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    newb.hashes[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hash</span></span>
<span class="line"><span style="color:#E1E4E8">    newe </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">entryOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])</span></span>
<span class="line"><span style="color:#E1E4E8">    newe.key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> key</span></span>
<span class="line"><span style="color:#E1E4E8">    newe.value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> newValue</span></span>
<span class="line"><span style="color:#E1E4E8">    newb.entries[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(newe)</span></span>
<span class="line"><span style="color:#E1E4E8">    atomic.</span><span style="color:#B392F0">StorePointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">currentBucket.next, unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(newb))</span></span>
<span class="line"><span style="color:#E1E4E8">    rootBucket.mu.</span><span style="color:#B392F0">Unlock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    table.</span><span style="color:#B392F0">addSize</span><span style="color:#E1E4E8">(bucketIndex, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> newValue, computeOnly</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The idea can be summarized as:</p>
<ul>
<li>Check if there is a next bucket. If there is none and no empty slot has been identified, create a new bucket.</li>
<li>Create a new instance of <code>entryOf</code> and set the key and value.</li>
<li>Store the new entry in the 0th index of the newly created bucket.</li>
<li>Atomically link the new bucket using <code>atomic.StorePointer(&#x26;currentBucket.next, unsafe.Pointer(newb))</code></li>
<li>Release the lock</li>
</ul>
<p>The <code>Store</code> operation also checks if a <code>resize</code> operation is in progress.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> m.</span><span style="color:#B392F0">resizeInProgress</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">    // Resize is in progress. Wait, then go for another attempt.</span></span>
<span class="line"><span style="color:#E1E4E8">    rootBucket.mu.</span><span style="color:#B392F0">Unlock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    m.</span><span style="color:#B392F0">waitForResize</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    goto</span><span style="color:#E1E4E8"> compute_attempt</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> m.</span><span style="color:#B392F0">newerTableExists</span><span style="color:#E1E4E8">(table) {</span></span>
<span class="line"><span style="color:#6A737D">    // Someone resized the table. Go for another attempt.</span></span>
<span class="line"><span style="color:#E1E4E8">    rootBucket.mu.</span><span style="color:#B392F0">Unlock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    goto</span><span style="color:#E1E4E8"> compute_attempt</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">m </span><span style="color:#F97583">*</span><span style="color:#B392F0">MapOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">resizeInProgress</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">bool</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#E1E4E8"> atomic.</span><span style="color:#B392F0">LoadInt64</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.resizing) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">m </span><span style="color:#F97583">*</span><span style="color:#B392F0">MapOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">newerTableExists</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">table</span><span style="color:#F97583"> *</span><span style="color:#B392F0">mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">bool</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	curTablePtr </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> atomic.</span><span style="color:#B392F0">LoadPointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.table)</span></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(curTablePtr) </span><span style="color:#F97583">!=</span><span style="color:#F97583"> uintptr</span><span style="color:#E1E4E8">(unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(table))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This code ensures data consistency during writes even when the map is being resized. Here’s how it works:</p>
<ul>
<li><strong>Resize in progress</strong></li>
</ul>
<p>If the <code>doCompute</code> operation detects a resize happening, it waits for the resize to finish. Then, it starts the entire operation from scratch to ensure it’s working with the latest structure of the map.</p>
<ul>
<li><strong>Resize after invocation</strong></li>
</ul>
<p>If a resize happens after the <code>doCompute</code> operation has already begun (but wasn’t ongoing at the start), the code recognizes this potential inconsistency. It releases the lock it might be holding and starts the entire operation again.
This guarantees the operation uses the most recent map structure.</p>
<p>Here’s a breakdown of the takeaways from the <code>Store</code> operation:</p>
<ol>
<li><strong>Concurrent Safety with Bucket Locks</strong>:</li>
</ol>
<p>Each bucket has its own lock, to control writes. This lock (<code>sync.Mutex</code> in Go) is acquired in the <code>doCompute</code> method.
This ensures only one goroutine can modify a particular bucket at a time, preventing conflicts when multiple goroutines try to write to the same bucket at once.</p>
<ol start="2">
<li><strong>Balancing Buckets and Contention</strong>:</li>
</ol>
<p>If you have a large number of goroutines (like 9000) writing to the map, increasing the number of buckets can improve performance.
Think of buckets as separate lines at a store checkout. More buckets mean fewer goroutines waiting in line (contention) for the same bucket.
The ideal number of buckets should be determined through performance tests (benchmarks) to find the right balance.</p>
<ol start="3">
<li><strong>Atomic Operations for Consistency</strong>:</li>
</ol>
<p>Inside a bucket, the <code>Store</code> method updates three parts (next pointer, entry, and hash). These fields are written atomically.
This ensures that no goroutine sees these parts in an inconsistent state.</p>
<blockquote>
<p>Consider two goroutines, one is doing the <code>Store</code> operation and the other is doing the <code>Load</code> operation on the same key that the store goroutine is trying to put.</p>
<p>The goroutine performing the <code>Store</code> operation finds an empty
slot and updates the hash and then the entry by executing <code>atomic.StoreUint64(&#x26;emptyb.hashes[emptyidx], hash)</code> and
<code>atomic.StorePointer(&#x26;emptyb.entries[emptyidx], unsafe.Pointer(newe))</code>.</p>
<p>It is possible for the goroutine performing the <code>Load</code> operation to see the updated hash because the hash might have been written by the store goroutine at an index <code>i</code>, but the value might not have been written yet.
So, the load goroutine will not see the value despite seeing the updated hash. It will return with the empty value. This is still the expected behavior.</p>
</blockquote>
<p>The complete method is available <a href="https://github.com/puzpuzpuz/xsync/blob/main/mapof.go#L258">here</a>.</p>
<p>One of the key benefits of CLHT is its minimal impact on CPU cache lines during writes (store operations). This is because each store operation only modifies a single bucket. Regardless of whether it updates an existing bucket or creates a new one, only a single cache line of data is written.</p>
<h3 id="understanding-the-resize-operation">Understanding the Resize Operation</h3>
<p>Let’s take a look at the <code>resize</code> operation which can increase or decrease the number of buckets in the map. In this section, we’ll delve deeper into how the resize operation handles map growth.</p>
<h4 id="ensure-one-resize-at-a-time">Ensure one resize at a time</h4>
<p>There can be only one <code>resize</code> running at a time.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">atomic.</span><span style="color:#B392F0">CompareAndSwapInt64</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.resizing, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // Someone else started resize. Wait for it to finish.</span></span>
<span class="line"><span style="color:#E1E4E8">    m.</span><span style="color:#B392F0">waitForResize</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    return</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This method checks to see if an existing <code>resize</code> operation is running. <code>CompareAndSwapInt64</code> will compare the value of the field <code>resizing</code> with 0. The zero value for the field <code>resizing</code> signifies that there is no resize operation in progress.</p>
<p>If <code>resizing</code> is 0, it will be set to 1 and the <code>resize</code> operation will proceed. Else, <code>CompareAndSwapInt64</code> will fail and the goroutine will wait for the ongoing <code>resize</code> operation to finish and return.</p>
<h4 id="access-the-current-table-atomically">Access the current table atomically</h4>
<p>Consider that there is no resize operation in progress.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#E1E4E8">table </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])(atomic.</span><span style="color:#B392F0">LoadPointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.table))</span></span>
<span class="line"><span style="color:#E1E4E8">tableLen </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(table.buckets)</span></span></code></pre>
<p>The <code>table</code> field is an unsafe pointer that refers to <code>mapOfTable</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> MapOf</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">K</span><span style="color:#B392F0"> comparable</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">V</span><span style="color:#B392F0"> any</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">	table        </span><span style="color:#B392F0">unsafe</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Pointer</span><span style="color:#6A737D"> // *mapOfTable</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The method accesses the <code>table</code> field to find the total number of buckets present in the table (/map). The field is accessed atomically to ensure that the consistent view of the <code>table</code> is obtained. This atomic access becomes crucial because a previous resize operation might have already changed the internal structure of the map (adding or removing buckets). By reading atomically, we avoid any inconsistencies that could lead to errors.</p>
<h4 id="increase-the-table-size-locally">Increase the table size locally</h4>
<p>The next step is to increase the table size. We already know that the field <code>table</code> needs to be operated on atomically. This means unless the new table (/method local table) is ready, this field is not touched.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> newTable </span><span style="color:#F97583">*</span><span style="color:#B392F0">mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">	</span></span>
<span class="line"><span style="color:#F97583">case</span><span style="color:#E1E4E8"> mapGrowHint:</span></span>
<span class="line"><span style="color:#6A737D">    // Grow the table with factor of 2.</span></span>
<span class="line"><span style="color:#E1E4E8">    atomic.</span><span style="color:#B392F0">AddInt64</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.totalGrowths, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    newTable </span><span style="color:#F97583">=</span><span style="color:#B392F0"> newMapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">](tableLen </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>To grow the table, a new method local table is created with twice the size of the existing table.</p>
<h4 id="remap-the-existing-keys">Remap the existing keys</h4>
<p>The next step is to go through all the buckets in the existing table and map all the keys to the new structure.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> tableLen; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    //remap the keys of the existing bucket at index i into the new table.</span></span>
<span class="line"><span style="color:#E1E4E8">    copied </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> copyBucketOf</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">table.buckets[i], newTable, m.hasher)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> copyBucketOf</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">K</span><span style="color:#B392F0"> comparable</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">V</span><span style="color:#B392F0"> any</span><span style="color:#E1E4E8">](</span></span>
<span class="line"><span style="color:#FFAB70">	b</span><span style="color:#F97583"> *</span><span style="color:#B392F0">bucketOfPadded</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">	destTable</span><span style="color:#F97583"> *</span><span style="color:#B392F0">mapOfTable</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#FFAB70">	hasher</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">uint64</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">uint64</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">) (</span><span style="color:#FFAB70">copied</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	rootb </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> b</span></span>
<span class="line"><span style="color:#E1E4E8">	rootb.mu.</span><span style="color:#B392F0">Lock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> entriesPerMapBucket; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8"> b.entries[i] </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">				e </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">entryOf</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">])(b.entries[i])</span></span>
<span class="line"><span style="color:#E1E4E8">				hash </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> shiftHash</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">hasher</span><span style="color:#E1E4E8">(e.key, destTable.seed))</span></span>
<span class="line"><span style="color:#E1E4E8">				bidx </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uint64</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(destTable.buckets)</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8"> hash</span></span>
<span class="line"><span style="color:#E1E4E8">				destb </span><span style="color:#F97583">:=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">destTable.buckets[bidx]</span></span>
<span class="line"><span style="color:#B392F0">				appendToBucketOf</span><span style="color:#E1E4E8">(hash, b.entries[i], destb)</span></span>
<span class="line"><span style="color:#E1E4E8">				copied</span><span style="color:#F97583">++</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> b.next </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			rootb.mu.</span><span style="color:#B392F0">Unlock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">			return</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">*</span><span style="color:#B392F0">bucketOfPadded</span><span style="color:#E1E4E8">)(b.next)</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The idea behind <code>copyBucketOf</code> can be summarized as:</p>
<ul>
<li>Acquire a lock on the current bucket.</li>
<li>Iterate through the entire bucket (chained bucket(s)).</li>
<li>Calculate the hash of each entry in the linearly linked buckets.</li>
<li>Identify the bucket index based on the new table structure: <code>uint64(len(destTable.buckets)-1) &#x26; hash</code></li>
<li>Add the entry (or entry pointer) to an empty slot in the existing bucket or append a new bucket.</li>
<li>Release the lock for the bucket if the <code>next</code> pointer of the current bucket is <code>nil</code>.</li>
</ul>
<h4 id="finish-resize">Finish resize</h4>
<p>The last step is to mark the resizing done.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A737D">// Publish the new table and wake up all waiters.</span></span>
<span class="line"><span style="color:#E1E4E8">atomic.</span><span style="color:#B392F0">StorePointer</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.table, unsafe.</span><span style="color:#B392F0">Pointer</span><span style="color:#E1E4E8">(newTable))</span></span>
<span class="line"><span style="color:#E1E4E8">m.resizeMu.</span><span style="color:#B392F0">Lock</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">atomic.</span><span style="color:#B392F0">StoreInt64</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">m.resizing, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">m.resizeCond.</span><span style="color:#B392F0">Broadcast</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">m.resizeMu.</span><span style="color:#B392F0">Unlock</span><span style="color:#E1E4E8">()</span></span></code></pre>
<p>The idea can be summarized as:</p>
<ul>
<li>Atomically store the pointer to the <code>newTable</code> in the map.</li>
<li>Mark resizing done by atomically storing zero in the <code>resizing</code> field.</li>
<li>Notify waiters (other goroutines) of the completion of resize operation.</li>
</ul>
<h3 id="conclusion">Conclusion</h3>
<p>Imagine a machine with 128 cores, where a thread on core 1 needs to update data. This update involves three cache lines, and unfortunately, all these lines are also cached by every other core.</p>
<p>In a traditional approach, this update triggers a chain reaction:</p>
<p><strong>Heavy Bus Traffic</strong></p>
<p>Core 1 writes the updated lines, causing a lot of traffic on the CPU bus, a shared pathway for communication.</p>
<p><strong>Cache Invalidation</strong></p>
<p>Since other cores have copies of these lines, cache coherence protocol kicks in. This protocol invalidates the outdated copies in other cores’ caches.</p>
<p><strong>Reloading from RAM</strong></p>
<p>Invalidated cores are forced to fetch the latest data from main memory (RAM), further increasing traffic and potentially slowing down the system.</p>
<p><em>This process, known as cache coherence traffic, can become a significant bottleneck in multi-core systems with frequent writes.</em></p>
<p>Cache-Line Hash Tables (CLHT) offer a clever solution for managing concurrent data access in multi-core processors. By keeping one bucket per CPU cache line, CLHT minimizes the disruptive effects of cache coherence traffic during write operations. With CLHT, updates primarily modify a single bucket, ensuring only one cache line is written at a time.</p>
<h3 id="mentions">Mentions</h3>
<ul>
<li><a href="https://bard.google.com/chat">Google Bard</a> helped with the article.</li>
</ul>
<h3 id="references">References</h3>
<ul>
<li><a href="https://github.com/puzpuzpuz/xsync">xsync</a></li>
<li><a href="https://infoscience.epfl.ch/record/203822">Designing ASCY-compliant Concurrent Search Data Structures</a></li>
<li><a href="https://surfingcomplexity.blog/2022/11/25/cache-invalidation-really-is-one-of-the-hardest-things-in-computer-science/">Cache invalidation really is one of the hardest problems in computer science</a></li>
</ul> </div> <!-- Tags Section --> <div class="mt-12 pt-8 border-t border-zinc-100"> <div class="flex flex-wrap gap-3"> <div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> CPU Cache-Line </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Hash Table </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> CLHT </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Cache-Line Hash Table </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Golang </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> xsync </div> </div> </div> <!-- Related Essays --> <div class="mt-12 pt-8 border-t border-zinc-100"> <h2 class="text-2xl font-bold font-sans mb-6 text-black">
More from Tech Lessons
</h2> <div class="grid gap-6 md:grid-cols-2"> <a href="/en/blog/many_flavors_of_networking_io/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Many flavors of Networking IO </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2024-05-22T00:00:00.000Z" class="text-zinc-400"> May 22, 2024 </time> </div> </a><a href="/en/blog/serializable_snapshot_isolation/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> A guide to Serializable Snapshot Isolation in Key/Value storage engine </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2024-03-22T00:00:00.000Z" class="text-zinc-400"> Mar 22, 2024 </time> </div> </a><a href="/en/blog/invoking_c_from_go/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Invoking C Code from Golang </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2021-12-21T00:00:00.000Z" class="text-zinc-400"> Dec 21, 2021 </time> </div> </a> </div> </div> <!-- Giscus Comments --> <div class="mt-16 pt-8 border-t border-zinc-100"> <script src="https://giscus.app/client.js" data-repo="SarthakMakhija/tech-lessons-comments" data-repo-id="R_kgDOJHu3mA" data-category="Announcements" data-category-id="DIC_kwDOJHu3mM4CUxhS" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script> </div> </div> <!-- Sidebar TOC (Desktop Only) --> <aside class="hidden lg:block sticky top-24 pt-8 max-h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar"> <div class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 font-sans">
On this page
</div> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introduction" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introduction </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-cpu-cache-line-and-cache-coherency" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding CPU Cache line and Cache Coherency </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-clht-cache-line-hash-table" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding CLHT (Cache-Line Hash table) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-the-load-operation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Load Operation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-the-store-operation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Store Operation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#identifying-the-bucket" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Identifying the bucket </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#acquire-a-lock-on-the-identified-bucket" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Acquire a lock on the identified bucket </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#identify-an-empty-entry-slot" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Identify an empty entry slot </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#store-the-keyvalue-pair-in-an-empty-entry-slot" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Store the key/value pair in an empty entry slot </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#store-in-a-new-bucket-if-all-the-linearly-linked-buckets-at-the-identified-bucket-index-are-full" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Store in a new bucket, if all the linearly linked buckets at the identified bucket index are full </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-the-resize-operation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Resize Operation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#ensure-one-resize-at-a-time" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Ensure one resize at a time </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#access-the-current-table-atomically" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Access the current table atomically </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#increase-the-table-size-locally" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Increase the table size locally </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#remap-the-existing-keys" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Remap the existing keys </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#finish-resize" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Finish resize </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#mentions" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Mentions </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </aside> </div> </article>  </main> <footer class="border-t border-slate-800 bg-slate-900 py-8 text-center text-sm text-zinc-500"> <div class="container mx-auto px-4">
tech-lessons.in &copy; 2020 / Powered by <a href="https://astro.build" target="_blank" class="hover:text-zinc-300 transition-colors">Astro</a> </div> </footer> </div> <!-- Subtle gradient glow at the bottom/edges (optional, keeping it really subtle) --> <div class="fixed inset-0 pointer-events-none z-[-1] bg-[radial-gradient(circle_at_50%_120%,rgba(120,119,198,0.1),rgba(255,255,255,0))]"></div> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.Ci7t3JeA.js"></script> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(t=>{const e=document.createElement("button");e.className="copy-code-button",e.innerHTML=`
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
							<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
						</svg>
					`,e.ariaLabel="Copy code";const r=document.createElement("div");r.className="code-block-wrapper relative group",t.parentNode&&(t.parentNode.insertBefore(r,t),r.appendChild(t),r.appendChild(e)),e.addEventListener("click",async()=>{const o=t.querySelector("code")?.innerText||t.innerText;try{await navigator.clipboard.writeText(o),e.innerHTML=`
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
							`,setTimeout(()=>{e.innerHTML=`
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								`},2e3)}catch(n){console.error("Failed to copy:",n)}})})});</script>  </body> </html>