<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.16.11"><!-- Canonical URL --><link rel="canonical" href="https://tech-lessons.in/en/blog/bitcask/"><!-- Primary Meta Tags --><title>Bitcask - A Log-Structured Hash Table</title><meta name="title" content="Bitcask - A Log-Structured Hash Table"><meta name="description" content="Bitcask - A Log-Structured Hash Table"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tech-lessons.in/en/blog/bitcask/"><meta property="og:title" content="Bitcask - A Log-Structured Hash Table"><meta property="og:description" content="Bitcask - A Log-Structured Hash Table"><meta property="og:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tech-lessons.in/en/blog/bitcask/"><meta property="twitter:title" content="Bitcask - A Log-Structured Hash Table"><meta property="twitter:description" content="Bitcask - A Log-Structured Hash Table"><meta property="twitter:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script><script>
	window.dataLayer = window.dataLayer || [];
	function gtag() {
		dataLayer.push(arguments);
	}
	gtag("js", new Date());

	gtag("config", "G-9KKTKFQ2CM");
</script><link rel="stylesheet" href="/_astro/about.Dq19AYy-.css"></head> <body class="bg-white text-zinc-900 min-h-screen flex flex-col md:flex-row selection:bg-black selection:text-white"> <header class="md:hidden sticky top-0 z-50 bg-slate-900 border-b border-slate-800 text-white"> <div class="flex items-center justify-between px-6 py-4"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="mobile-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Toggle menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="3" y1="12" x2="21" y2="12"></line> <line x1="3" y1="6" x2="21" y2="6"></line> <line x1="3" y1="18" x2="21" y2="18"></line> </svg> </button> </div> <!-- Mobile Menu Overlay --> <div id="mobile-menu" class="fixed inset-0 bg-slate-900 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-screen overflow-y-auto"> <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Close menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <nav class="flex flex-col p-6 gap-2"> <a href="/" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <div class="mt-auto p-6 border-t border-slate-800"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3 block mb-4">Contact</span> <div class="flex flex-col gap-2"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </div> </header> <script type="module">const t=document.getElementById("mobile-menu-btn"),n=document.getElementById("close-menu-btn"),e=document.getElementById("mobile-menu");t&&n&&e&&(t.addEventListener("click",()=>{e.classList.remove("translate-x-full")}),n.addEventListener("click",()=>{e.classList.add("translate-x-full")}),e.querySelectorAll("a").forEach(l=>{l.addEventListener("click",()=>{e.classList.add("translate-x-full")})}));</script> <aside class="hidden md:flex flex-col w-[280px] h-screen sticky top-0 border-r border-slate-800 bg-slate-900 p-8 shrink-0"> <!-- Profile --> <div class="flex flex-col items-start mb-12"> <div class="w-16 h-16 rounded-full border-2 border-slate-700 shadow-sm overflow-hidden mb-4 relative bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <h2 class="font-bold text-lg text-white leading-tight">
Sarthak Makhija
</h2> <span class="text-sm text-zinc-400">Databases & Storage Systems</span> </div> <!-- Navigation --> <nav class="flex-1 flex flex-col gap-1"> <a href="/" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <line x1="12" y1="20" x2="12" y2="10"></line> <line x1="18" y1="20" x2="18" y2="4"></line> <line x1="6" y1="20" x2="6" y2="16"></line> </svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <!-- Socials --> <div class="mt-auto pt-8 border-t border-slate-800 flex flex-col gap-4"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3">Contact</span> <div class="flex flex-col gap-1"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </aside> <div class="flex-1 flex flex-col min-w-0"> <main class="flex-1 max-w-[1280px] mx-auto px-6 py-12 md:py-20 w-full">  <article class="max-w-[1280px] mx-auto min-w-0"> <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12 items-start"> <div class="min-w-0"> <!-- Article Header --> <header class="mb-12"> <h1 class="text-[40px] md:text-[48px] font-sans font-extrabold text-black leading-[1.2] mb-6 tracking-tight"> Bitcask - A Log-Structured Hash Table </h1> <div class="flex items-center gap-4 text-[16px] text-zinc-500 mb-8 border-b border-zinc-100 pb-8"> <time datetime="2023-05-04T00:00:00.000Z" class="text-zinc-400"> May 4, 2023 </time> <span>/</span> <span>Bitcask, Storage engine, Log Structured</span> </div> <div class="w-full mb-12"> <img width="1020" height="510" src="/bitcask_title.webp" alt="" class="w-full rounded-md shadow-sm"> <p class="text-left text-zinc-500 italic mt-3 text-sm"> Background by Suzy Hazelwood on Pexels </p> </div> </header> <!-- Table of Contents (Mobile Only) --> <div class="lg:hidden bg-gray-50 rounded-lg p-6 mb-12 border border-zinc-100"> <h2 class="text-black font-bold font-sans text-[16px] uppercase tracking-wide mb-4">
Table of contents
</h2> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#bitcask-components" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Bitcask components </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#append-only-data-files" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Append-only data files </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#keydir" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> KeyDir </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#bitcask-write-optimized-storage-engine" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Bitcask: Write-optimized storage engine </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#bitcask-read-optimized-storage-engine" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Bitcask: Read-optimized storage engine </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#operations" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Operations </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#put-putkey-value" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Put: put(key, value) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#update-updatekey-value" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Update: update(key, value) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#delete-deletekey" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Delete: delete(key) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#get-getkey" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Get: get(key) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#merge-and-compaction" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Merge and compaction </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#hint-file" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Hint file </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </div> <!-- Article Content --> <div class="prose prose-lg max-w-none text-black
            [&_h1]:font-serif [&_h1]:font-bold [&_h1]:text-black [&_h1]:text-[36px] [&_h1]:mt-10 [&_h1]:mb-4
            [&_h2]:font-serif [&_h2]:font-bold [&_h2]:text-black [&_h2]:text-[30px] [&_h2]:mt-10 [&_h2]:mb-6
            [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-black [&_h3]:text-[24px] [&_h3]:mt-10 [&_h3]:mb-4
            [&_h4]:font-sans [&_h4]:font-bold [&_h4]:text-black [&_h4]:text-[18px] [&_h4]:mt-8 [&_h4]:mb-4
            [&_p]:font-sans [&_p]:text-[1.125rem] [&_p]:leading-[1.7777778] [&_p]:text-zinc-800 [&_p]:my-[1em]
            [&_a]:underline [&_a]:decoration-zinc-400 [&_a]:transition-all
            
            /* Table Styling */
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:border [&_table]:border-zinc-200 [&_table]:rounded-lg [&_table]:overflow-hidden
            [&_th]:text-left [&_th]:p-3 [&_th]:border-b [&_th]:border-zinc-200 [&_th]:bg-zinc-50 [&_th]:font-semibold [&_th]:text-zinc-900
            [&_td]:p-3 [&_td]:border-b [&_td]:border-zinc-200 [&_td]:text-zinc-700
            [&_tr:last-child_td]:border-0
            
            [&_li]:text-[1.125rem] [&_li]:leading-[1.7777778] [&_li]:text-zinc-800 [&_li]:mb-2
            [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-6
            [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-6
            [&_img]:rounded-md [&_img]:shadow-lg [&_img]:my-8
            [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-zinc-500 [&_figcaption]:italic [&_figcaption]:mt-[-20px] [&_figcaption]:mb-8
            [&_blockquote]:relative [&_blockquote]:bg-zinc-100 [&_blockquote]:text-zinc-700 [&_blockquote]:p-8 [&_blockquote]:rounded-2xl [&_blockquote]:my-10 [&_blockquote]:not-italic [&_blockquote]:text-[1.1rem] [&_blockquote]:leading-relaxed [&_blockquote]:ml-24
            [&_blockquote::before]:content-[''] [&_blockquote::before]:absolute [&_blockquote::before]:top-8 [&_blockquote::before]:-left-3 [&_blockquote::before]:border-t-[12px] [&_blockquote::before]:border-t-transparent [&_blockquote::before]:border-b-[12px] [&_blockquote::before]:border-b-transparent [&_blockquote::before]:border-r-[16px] [&_blockquote::before]:border-r-zinc-100
            [&_blockquote::after]:content-[''] [&_blockquote::after]:absolute [&_blockquote::after]:-left-32 [&_blockquote::after]:-top-2 [&_blockquote::after]:w-28 [&_blockquote::after]:h-28 [&_blockquote::after]:bg-[url('/avatar.png')] [&_blockquote::after]:bg-contain [&_blockquote::after]:bg-no-repeat [&_blockquote::after]:bg-center [&_blockquote::after]:rounded-full [&_blockquote::after]:border-4 [&_blockquote::after]:border-white [&_blockquote::after]:shadow-md
            [&_pre]:p-6 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:my-8
            [&_code]:font-mono [&_code]:text-[14px] [&_code]:leading-relaxed"> <p>Bitcask is an embeddable key/value storage engine that is defined as a “Log-Structured Hash Table” in the paper that introduced it. Bitcask follows a simple model: all the
key/value pairs are written to <em>append-only files</em>, and an in-memory data structure contains a mapping between each key and the position of the value in the data file.</p>
<p>Let’s understand the different components of Bitcask.</p>
<h3 id="bitcask-components">Bitcask components</h3>
<p>Bitcask is a straightforward model to understand. It consists of two components:</p>
<ol>
<li>Append-only data files</li>
<li>In-memory structure called <code>KeyDir</code> that maps each key to its value position in the data file</li>
</ol>
<p>Let’s understand both these components.</p>
<h4 id="append-only-data-files">Append-only data files</h4>
<p>A bitcask instance consists of multiple data files on a disk. At any moment, only one file is active for writing. When that file meets a size threshold, it will be closed, and a new active file will be created.
Once a file is closed, it is considered immutable and will never be opened for writing again.</p>
<figure>
    <img class="align-center-exclude-width-change" src="/bitcask_data_files.webp"> 
</figure>
<p>The active file is written by appending, which means sequential writes are performed on disk.
The format that is written for each key/value entry is simple:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>┌─────┬───────────┬──────────┬────────────┐───────┐───────┐</span></span>
<span class="line"><span>│ CRC │ timestamp │ key_size │ value_size │ key   │value  │</span></span>
<span class="line"><span>└─────┴───────────┴──────────┴────────────┘───────┘───────┘</span></span></code></pre>
<p>Every write involves appending a new entry to the active file. Even deletion is an append operation that involves writing a particular tombstone value.
Thus, a Bitcask data file is a linear sequence of these entries.</p>
<h4 id="keydir">KeyDir</h4>
<p><code>KeyDir</code> is simply a hash table that maps every key in Bitcask to a fixed-size structure giving the file, offset, and size of the most recently written entry for that key.</p>
<figure>
    <img class="align-center-exclude-width-change" src="/bitcask_keydir.webp"> 
</figure>
<p>Let’s understand why Bitcask is both write and read-optimized.</p>
<h3 id="bitcask-write-optimized-storage-engine">Bitcask: Write-optimized storage engine</h3>
<p>In Bitcask, each write results in a new entry being appended to a file. To do this, the underlying file is opened in the <em>APPEND</em> mode, and each entry is written to an increasing offset in the file.
Thus, Bitcask performs sequential writes to the disk.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> NewStore</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">filePath</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">Store</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">   writer, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> os.</span><span style="color:#B392F0">OpenFile</span><span style="color:#E1E4E8">(filePath, os.O_WRONLY</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">os.O_APPEND, </span><span style="color:#79B8FF">0644</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">Store</span><span style="color:#E1E4E8">{writer: writer}, </span><span style="color:#79B8FF">nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">store </span><span style="color:#F97583">*</span><span style="color:#B392F0">Store</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">bytes</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   bytesWritten, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> store.writer.</span><span style="color:#B392F0">Write</span><span style="color:#E1E4E8">(bytes)</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> bytesWritten </span><span style="color:#F97583">&#x3C;</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(bytes) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> errors.</span><span style="color:#B392F0">New</span><span style="color:#E1E4E8">(fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not append </span><span style="color:#79B8FF">%v</span><span style="color:#9ECBFF"> bytes"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(bytes)))</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The image below highlights the throughput difference between sequential and random writes on an NVMe SSD; the difference would be much higher on an HDD.</p>
<figure>
    <img class="align-center" src="/sequential-random-write.png"> 
    <figcaption class="figcaption">Sequential write throughput > Random write throughput</figcaption>
</figure>
<p>Bitcask is write-optimized because it performs sequential writes to disk.</p>
<h3 id="bitcask-read-optimized-storage-engine">Bitcask: Read-optimized storage engine</h3>
<p>Bitcask maintains all the keys in RAM in a data structure called <code>KeyDir</code>. A <code>KeyDir</code> is simply a hash table that maps every key in Bitcask to a fixed-size structure giving the file, offset, and size of the most recently written entry for that key.</p>
<p>One can imagine KeyDir to have the following structure:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> KeyDirectory</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">Key</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">BitCaskKey</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   entryByKey </span><span style="color:#F97583">map</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">*</span><span style="color:#B392F0">Entry</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> Entry</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   FileId      </span><span style="color:#F97583">uint64</span></span>
<span class="line"><span style="color:#E1E4E8">   Offset      </span><span style="color:#F97583">int64</span></span>
<span class="line"><span style="color:#E1E4E8">   EntryLength </span><span style="color:#F97583">uint32</span></span>
<span class="line"><span style="color:#E1E4E8">   Timestamp   </span><span style="color:#F97583">uint32</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>To read the value for a key a lookup operation is performed in the <code>KeyDir</code> to get the datafile and the value offset within it.
Once the <code>Entry</code> corresponding to the key is found in the <code>KeyDir</code>, a read operation is performed in the file identified by the <code>Entry.FileId</code>. This read operation involves performing a <code>Seek</code> to the offset defined by <code>Entry.Offset</code> in the file and then reading the entire byte slice <code>([]byte)</code> identified by the <code>Entry.EntryLength</code>.
The correctness of the value retrieved is checked against the CRC stored and the value is then returned to the client.</p>
<p>This operation is fast as it involves performing a single disk seek. It can be made faster by using <a href="https://en.wikipedia.org/wiki/Readahead">read-ahead</a> system call.</p>
<p>The read operation can be represented with the following code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">kv </span><span style="color:#F97583">*</span><span style="color:#B392F0">KVStore</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Get</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">) ([]</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">   entry, ok </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> kv.keyDirectory.</span><span style="color:#B392F0">Get</span><span style="color:#E1E4E8">(key)                                                       (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> ok {</span></span>
<span class="line"><span style="color:#E1E4E8">      storedEntry, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> kv.segments.</span><span style="color:#B392F0">Read</span><span style="color:#E1E4E8">(entry.FileId, entry.Offset, entry.EntryLength)     (</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">         return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> storedEntry.Value, </span><span style="color:#79B8FF">nil</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, errors.</span><span style="color:#B392F0">New</span><span style="color:#E1E4E8">(fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Key </span><span style="color:#79B8FF">%v</span><span style="color:#9ECBFF"> does not exist"</span><span style="color:#E1E4E8">, key))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Step 1 performs a lookup in the <code>KeyDir</code>, and if an entry is present in the hash table, a disk read is performed in the file identified by the <code>entry.FileId</code> at an offset identified by <code>entry.Offset</code>.</p>
<h3 id="operations">Operations</h3>
<p>Let’s understand various operations supported by Bitcask.</p>
<h4 id="put-putkey-value">Put: <code>put(key, value)</code></h4>
<p>Every put operation appends the key/value pair to the active data file. Once the append operation to the data file is done, a new entry is created in the <code>KeyDir</code>
that maps the key to a fixed structure which contains the active <code>fileId</code>, <code>value size</code>, <code>value position</code> and <code>timestamp</code>.</p>
<p>The approach can be implemented as:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">kv </span><span style="color:#F97583">*</span><span style="color:#B392F0">KVStore</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Put</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   appendEntryResponse, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> kv.segments.</span><span style="color:#B392F0">Append</span><span style="color:#E1E4E8">(key, value)                            (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">   kv.keyDirectory.</span><span style="color:#B392F0">Put</span><span style="color:#E1E4E8">(key, </span><span style="color:#B392F0">NewEntryFrom</span><span style="color:#E1E4E8">(appendEntryResponse))                           (</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<ol>
<li><code>kv.segments.Append(key, value)</code> appends the key/value pair to the active segment(/data file)</li>
<li><code>kv.keyDirectory.Put(key, NewEntryFrom(appendEntryResponse))</code> creates a new entry in the <code>KeyDirectory</code></li>
</ol>
<blockquote>
<p>My implementation uses the term Segment instead of Datafile and KeyDirectory instead of KeyDir.</p>
</blockquote>
<p><strong>Appending to the active segment</strong></p>
<p>Let’s look at <code>kv.segments.Append</code>.</p>
<p>Before the key/value pair can be appended to the active segment file, the size of the active segment is checked against the maximum allowed size for a segment.
If the active segment size has crossed the size threshold, it is rolled over (3). Rollover of the active segment involves creating a new active segment and adding the current active segment to
the collection of inactive segments.</p>
<p>The key/value pair is then appended to the active segment. (4)</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> Segments</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">Key</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">BitCaskKey</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   activeSegment       </span><span style="color:#F97583">*</span><span style="color:#B392F0">Segment</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">   inactiveSegments    </span><span style="color:#F97583">map</span><span style="color:#E1E4E8">[</span><span style="color:#F97583">uint64</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">*</span><span style="color:#B392F0">Segment</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">   maxSegmentSizeBytes </span><span style="color:#F97583">uint64</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> AppendEntryResponse</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   FileId      </span><span style="color:#F97583">uint64</span></span>
<span class="line"><span style="color:#E1E4E8">   Offset      </span><span style="color:#F97583">int64</span></span>
<span class="line"><span style="color:#E1E4E8">   EntryLength </span><span style="color:#F97583">uint32</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">segments </span><span style="color:#F97583">*</span><span style="color:#B392F0">Segments</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Append</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">AppendEntryResponse</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> segments.</span><span style="color:#B392F0">maybeRolloverActiveSegment</span><span style="color:#E1E4E8">(); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {                           (</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">)            </span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#E1E4E8"> segments.activeSegment.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">NewEntry</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">](key, value, segments.clock))         (</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><strong>Encoding</strong></p>
<p>The entry needs to be encoded to append it to the active segment.</p>
<p>Encoding is converting the key/value pair to a byte slice that can be written to the disk.
The encoding scheme consists of the following structure:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>┌───────────┬──────────┬────────────┬─────┬───────┐</span></span>
<span class="line"><span>│ timestamp │ key_size │ value_size │ key │ value │</span></span>
<span class="line"><span>└───────────┴──────────┴────────────┴─────┴───────┘</span></span></code></pre>
<p><code>timestamp</code>, <code>key_size</code>, <code>value_size</code> consist of 32 bits each. The value ([]byte) consists of the value provided by the user and a byte for tombstone, that
is used to signify if the key/value pair is deleted.</p>
<blockquote>
<p>My implementation does not store CRC.</p>
</blockquote>
<p>The encoding operation can be represented as:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> Entry</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">Key</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Serializable</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   key       </span><span style="color:#B392F0">Key</span></span>
<span class="line"><span style="color:#E1E4E8">   value     </span><span style="color:#B392F0">valueReference</span></span>
<span class="line"><span style="color:#E1E4E8">   timestamp </span><span style="color:#F97583">uint32</span></span>
<span class="line"><span style="color:#E1E4E8">   clock     </span><span style="color:#B392F0">clock</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Clock</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> valueReference</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   value     []</span><span style="color:#F97583">byte</span></span>
<span class="line"><span style="color:#E1E4E8">   tombstone </span><span style="color:#F97583">byte</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">entry </span><span style="color:#F97583">*</span><span style="color:#B392F0">Entry</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">encode</span><span style="color:#E1E4E8">() []</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   serializedKey </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> entry.key.</span><span style="color:#B392F0">Serialize</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">   keySize, valueSize </span><span style="color:#F97583">:=</span><span style="color:#F97583"> uint32</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(serializedKey)), </span><span style="color:#F97583">uint32</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">(entry.value.value))</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">tombstoneMarkerSize</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">   encoded </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">, reservedTimestampSize</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">reservedKeySize</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">reservedValueSize</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">keySize</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">valueSize)</span></span>
<span class="line"><span style="color:#F97583">   var</span><span style="color:#E1E4E8"> offset </span><span style="color:#F97583">uint32</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">   littleEndian.</span><span style="color:#B392F0">PutUint32</span><span style="color:#E1E4E8">(encoded, </span><span style="color:#F97583">uint32</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">(entry.clock.</span><span style="color:#B392F0">Now</span><span style="color:#E1E4E8">())))</span></span>
<span class="line"><span style="color:#E1E4E8">   offset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> offset </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> reservedTimestampSize</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">   littleEndian.</span><span style="color:#B392F0">PutUint32</span><span style="color:#E1E4E8">(encoded[offset:], keySize)</span></span>
<span class="line"><span style="color:#E1E4E8">   offset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> offset </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> reservedKeySize</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">   littleEndian.</span><span style="color:#B392F0">PutUint32</span><span style="color:#E1E4E8">(encoded[offset:], valueSize)</span></span>
<span class="line"><span style="color:#E1E4E8">   offset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> offset </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> reservedValueSize</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">   copy</span><span style="color:#E1E4E8">(encoded[offset:], serializedKey)</span></span>
<span class="line"><span style="color:#E1E4E8">   offset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> offset </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> keySize</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">   copy</span><span style="color:#E1E4E8">(encoded[offset:], </span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(entry.value.value, entry.value.tombstone))</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#E1E4E8"> encoded</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<blockquote>
<p>The little-endian system stores the least-significant byte at the smallest address.</p>
</blockquote>
<p><strong>Putting in the KeyDirectory</strong></p>
<p>Let’s look at the last step of put operation, <code>kv.keyDirectory.Put</code>.</p>
<p>After the append operation is done, a new entry is created and inserted into the hashmap.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> KeyDirectory</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">Key</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">BitCaskKey</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   entryByKey </span><span style="color:#F97583">map</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">*</span><span style="color:#B392F0">Entry</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">keyDirectory </span><span style="color:#F97583">*</span><span style="color:#B392F0">KeyDirectory</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Put</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">value</span><span style="color:#F97583"> *</span><span style="color:#B392F0">Entry</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">   keyDirectory.entryByKey[key] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h4 id="update-updatekey-value">Update: <code>update(key, value)</code></h4>
<p>The update operation is similar to the put operation. It appends the key/value pair to the active segment file and updates the existing entry in the <code>KeyDirectory</code>
with the new position and possibly with the new <code>fileId</code>.</p>
<p>All the key/value storage engines that rely on append-only log files can have the same key with different values across different data files. To remove old entries,
merge and compaction process has to be introduced to merge data files and produce a set of data files containing only the latest versions of each present key.</p>
<h4 id="delete-deletekey">Delete: <code>delete(key)</code></h4>
<p>Delete operation appends a new entry to the active segment with a tombstone marker to signify deletion. Once the entry is appended to the active segment, an in-place delete is performed in the <code>KeyDirectory</code> to remove the key.</p>
<p>The approach can be represented with the following code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">kv </span><span style="color:#F97583">*</span><span style="color:#B392F0">KVStore</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Delete</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> kv.segments.</span><span style="color:#B392F0">AppendDeleted</span><span style="color:#E1E4E8">(key); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {                               (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">   kv.keyDirectory.</span><span style="color:#B392F0">Delete</span><span style="color:#E1E4E8">(key)                                                             (</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">segments </span><span style="color:#F97583">*</span><span style="color:#B392F0">Segments</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">AppendDeleted</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">AppendEntryResponse</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> segments.</span><span style="color:#B392F0">maybeRolloverActiveSegment</span><span style="color:#E1E4E8">(); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {                           (</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#E1E4E8"> segments.activeSegment.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">NewDeletedEntry</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">](key, segments.clock))         (</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> NewDeletedEntry</span><span style="color:#E1E4E8">[</span><span style="color:#FFAB70">Key</span><span style="color:#B392F0"> config</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Serializable</span><span style="color:#E1E4E8">](</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">clock</span><span style="color:#B392F0"> clock</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Clock</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#B392F0">Entry</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">Entry</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]{</span></span>
<span class="line"><span style="color:#E1E4E8">      key:       key,</span></span>
<span class="line"><span style="color:#E1E4E8">      value:     </span><span style="color:#B392F0">valueReference</span><span style="color:#E1E4E8">{value: []</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">{}, tombstone: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">},</span></span>
<span class="line"><span style="color:#E1E4E8">      timestamp: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      clock:     clock,</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The above code can be summarized as:</p>
<ol>
<li>The <code>Delete</code> method of KVStore calls the <code>AppendDeleted</code> of <code>Segments</code></li>
<li>The <code>AppendDeleted</code> method rolls over the active segment if the size of the active segment has crossed the segment size threshold</li>
<li>The <code>AppendDeleted</code> method creates an <code>Entry</code> with the <code>tombstone</code> byte set to 1 to indicate the deletion</li>
<li>After the entry is appended to the active segment, the key is deleted from the <code>KeyDirectory</code></li>
</ol>
<p>Because the delete operation is append-only, the merge and compaction process removes the deleted entries from the segment files and retains only the non-deleted keys.</p>
<blockquote>
<p>My implementation of delete maintains a separate tombstone byte to indicate the deletion. However, Bitcask paper mentions appending a particular tombstone value.</p>
</blockquote>
<h4 id="get-getkey">Get: <code>get(key)</code></h4>
<p>To read the value for a key, a lookup operation is performed in the <code>KeyDir</code> to get the datafile and the value offset within it.
Once the <code>Entry</code> corresponding to the key is found in the <code>KeyDir</code>, a read operation is performed in the file identified by the <code>Entry.FileId</code>. This read operation involves performing a <code>Seek</code> to the offset defined by <code>Entry.Offset</code> in the file and then reading the entire byte slice <code>([]byte)</code> identified by the <code>Entry.EntryLength</code>.</p>
<p>The read operation can be represented with the following code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">kv </span><span style="color:#F97583">*</span><span style="color:#B392F0">KVStore</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Get</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">) ([]</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">   entry, ok </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> kv.keyDirectory.</span><span style="color:#B392F0">Get</span><span style="color:#E1E4E8">(key)                                                     (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> ok {</span></span>
<span class="line"><span style="color:#E1E4E8">      storedEntry, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> kv.segments.</span><span style="color:#B392F0">Read</span><span style="color:#E1E4E8">(entry.FileId, entry.Offset, entry.EntryLength)   </span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">         return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> storedEntry.Value, </span><span style="color:#79B8FF">nil</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, errors.</span><span style="color:#B392F0">New</span><span style="color:#E1E4E8">(fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Key </span><span style="color:#79B8FF">%v</span><span style="color:#9ECBFF"> does not exist"</span><span style="color:#E1E4E8">, key))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">segments </span><span style="color:#F97583">*</span><span style="color:#B392F0">Segments</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">Read</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">fileId</span><span style="color:#F97583"> uint64</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">offset</span><span style="color:#F97583"> int64</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">size</span><span style="color:#F97583"> uint32</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">StoredEntry</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> fileId </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> segments.activeSegment.fileId {                                              (</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> segments.activeSegment.</span><span style="color:#B392F0">read</span><span style="color:#E1E4E8">(offset, size)</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">   segment, ok </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> segments.inactiveSegments[fileId]                                          (</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">) </span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> ok {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> segment.</span><span style="color:#B392F0">read</span><span style="color:#E1E4E8">(offset, size)</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, errors.</span><span style="color:#B392F0">New</span><span style="color:#E1E4E8">(fmt.</span><span style="color:#B392F0">Sprintf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Invalid file id </span><span style="color:#79B8FF">%v</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, fileId))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">segment </span><span style="color:#F97583">*</span><span style="color:#B392F0">Segment</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">read</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">offset</span><span style="color:#F97583"> int64</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">size</span><span style="color:#F97583"> uint32</span><span style="color:#E1E4E8">) (</span><span style="color:#F97583">*</span><span style="color:#B392F0">StoredEntry</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">error</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">   bytes, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> segment.store.</span><span style="color:#B392F0">read</span><span style="color:#E1E4E8">(offset, size)                                            (</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8">, err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">   storedEntry </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> decode</span><span style="color:#E1E4E8">(bytes)                                                              (</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#E1E4E8"> storedEntry, </span><span style="color:#79B8FF">nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The above code can be summarized as:</p>
<ol>
<li>Perform a lookup in the <code>KeyDirectory</code> and get an entry containing the <code>fileId</code>, <code>entry position</code> and <code>entry size</code></li>
<li>Read from the active segment if the <code>fileId</code> matches the active segment’s <code>fileId</code></li>
<li>Read from the inactive segment if the <code>fileId</code> matches one of the inactive segment’s <code>fileId</code></li>
<li>Perform a <code>File.Read()</code> and get a byte slice</li>
<li><code>decode</code> the read bytes to get the actual entry</li>
</ol>
<h3 id="merge-and-compaction">Merge and compaction</h3>
<p>Any storage engine model built on top of append-only data files like LSM or bitcask may use up much disk space over time, since new values are appended to the files without touching
the old ones. Therefore, a process for compaction that is referred to as “merging” is required. The merge process iterates over all non-active (i.e. immutable) files in a Bitcask instance and produces a set of data files containing only
the “live” or the latest versions of each present key.</p>
<figure>
    <img class="align-center-exclude-width-change" src="/bitcask_merge.webp"> 
</figure>
<p>Merge process needs to read all the immutable data files in memory, keep the live and the latest version of each key, and write the merged state
back to disk in form of new immutable data files.</p>
<p>After the merged state is written back to the disk, the in-memory state of the keys need an update because the keys now exist in a different data file.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">worker </span><span style="color:#F97583">*</span><span style="color:#B392F0">Worker</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">beginMerge</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">   var</span><span style="color:#E1E4E8"> fileIds []</span><span style="color:#F97583">uint64</span></span>
<span class="line"><span style="color:#F97583">   var</span><span style="color:#E1E4E8"> segments [][]</span><span style="color:#F97583">*</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">MappedStoredEntry</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">   fileIds, segments, err </span></span>
<span class="line"><span style="color:#F97583">              :=</span><span style="color:#E1E4E8"> worker.kvStore.</span><span style="color:#B392F0">ReadAllInactiveSegments</span><span style="color:#E1E4E8">(worker.config.</span><span style="color:#B392F0">KeyMapper</span><span style="color:#E1E4E8">())    (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> nil</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(segments) </span><span style="color:#F97583">>=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      mergedState </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> NewMergedState</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]()</span></span>
<span class="line"><span style="color:#E1E4E8">      mergedState.</span><span style="color:#B392F0">takeAll</span><span style="color:#E1E4E8">(segments[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">])                                                </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">      for</span><span style="color:#E1E4E8"> index </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">; index </span><span style="color:#F97583">&#x3C;</span><span style="color:#B392F0"> len</span><span style="color:#E1E4E8">(segments); index</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">         mergedState.</span><span style="color:#B392F0">mergeWith</span><span style="color:#E1E4E8">(segments[index])                                      (</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">      _ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> worker.kvStore.</span><span style="color:#B392F0">WriteBack</span><span style="color:#E1E4E8">(fileIds, mergedState.valueByKey)</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">kv </span><span style="color:#F97583">*</span><span style="color:#B392F0">KVStore</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#B392F0">WriteBack</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">fileIds</span><span style="color:#E1E4E8"> []</span><span style="color:#F97583">uint64</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">changes</span><span style="color:#F97583"> map</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">*</span><span style="color:#B392F0">appendOnlyLog</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">MappedStoredEntry</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">error</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   writeBackResponses, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> kv.segments.</span><span style="color:#B392F0">WriteBack</span><span style="color:#E1E4E8">(changes)                            (</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> err</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">   kv.keyDirectory.</span><span style="color:#B392F0">BulkUpdate</span><span style="color:#E1E4E8">(writeBackResponses)                                       (</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">   kv.segments.</span><span style="color:#B392F0">Remove</span><span style="color:#E1E4E8">(fileIds)                                                          (</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">) </span></span>
<span class="line"><span style="color:#F97583">   return</span><span style="color:#79B8FF"> nil</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The above code can be summarized as:</p>
<ol>
<li>Read all the inactive segments in the RAM</li>
<li>Perform the merge operation. <code>MergeState</code> maintains a hashmap to keep only one version of each key. The timestamp is used to decide the latest version of a key</li>
<li>Write back the merged state to new immutable data files on the disk</li>
<li>Update the <code>KeyDirectory</code> to ensure that the keys point to the updated data file</li>
<li>Remove old data files from the disk</li>
</ol>
<h3 id="hint-file">Hint file</h3>
<p>The crash recovery for a Bitcask instance will require reading all the data files and reloading the state of <code>KeyDir</code>. This process is expensive because it needs to read large data files. Bitcask proposes <strong>hint files</strong>
to speed up the recovery process (or the boot process).</p>
<p>When the merge begins, it creates a hint file next to each data file. Hint files are like the data files but instead of the values, they contain keys and the position and size of the values within the corresponding data file.
Hint files are smaller than data files because they don’t contain values. Hence, recovery is done from hint files instead of data files.</p>
<h3 id="conclusion">Conclusion</h3>
<p>Bitcask has a relatively simple data structure compared to <a href="/blog/wisckey_ssd_conscious_key_value_store">LSM</a>, and it offers some great positives:</p>
<ol>
<li><strong>High write throughput</strong>: it performs sequential disk writes, offering high write throughput.</li>
<li><strong>Low latency per item read or written</strong>: all the operations require a single disk seek.</li>
<li><strong>Ease of backup and restore</strong>: since the data files are immutable, backup can be taken by copying the directory. Restoration requires nothing more than placing the data files in the desired directory.</li>
<li><strong>Crash friendliness</strong>: As the data files and the commit log are the same things in Bitcask, recovery is trivial.</li>
<li>A relatively simple model to understand.</li>
</ol>
<p>Bitcask model has a set of challenges:</p>
<ol>
<li><strong>High memory usage</strong>: Bitcask stores all the keys in RAM. Thereby the memory usage is high. However, if the keys can be partitioned the problem can be reduced to some extent.</li>
<li><strong>Huge number of open OS file handles</strong>: Get operation in Bitcask can happen from both the active and inactive segment files, and there could be large number of inactive segment files in a single Bitcask instance.
To perform a read from an inactive segment, we might want to keep the file pointer of the inactive segment file open. This can result in too many open OS file handles.</li>
</ol>
<h3 id="code">Code</h3>
<p>The code for this article is available <a href="https://github.com/SarthakMakhija/bitcask">here</a>.</p>
<h3 id="references">References</h3>
<ul>
<li><a href="https://riak.com/assets/bitcask-intro.pdf">Bitcask paper</a></li>
<li><a href="https://arpitbhayani.me/blogs/bitcask">Bitcask article by Arpit Bhayani</a></li>
</ul> </div> <!-- Tags Section --> <div class="mt-12 pt-8 border-t border-zinc-100"> <div class="flex flex-wrap gap-3"> <div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Bitcask </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Storage engine </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Log Structured </div> </div> </div> <!-- Related Essays --> <div class="mt-12 pt-8 border-t border-zinc-100"> <h2 class="text-2xl font-bold font-sans mb-6 text-black">
More from Tech Lessons
</h2> <div class="grid gap-6 md:grid-cols-2"> <a href="/en/blog/wisckey_ssd_conscious_key_value_store/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> WiscKey: Separating Keys from Values in SSD-Conscious Storage </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2023-03-10T00:00:00.000Z" class="text-zinc-400"> Mar 10, 2023 </time> </div> </a><a href="/en/blog/bloom_filter/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Bloom filter </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2023-02-25T00:00:00.000Z" class="text-zinc-400"> Feb 25, 2023 </time> </div> </a><a href="/en/blog/persistent_memory/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Persistent memory - Introduction </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2022-04-28T00:00:00.000Z" class="text-zinc-400"> Apr 28, 2022 </time> </div> </a> </div> </div> <!-- Giscus Comments --> <div class="mt-16 pt-8 border-t border-zinc-100"> <script src="https://giscus.app/client.js" data-repo="SarthakMakhija/tech-lessons-comments" data-repo-id="R_kgDOJHu3mA" data-category="Announcements" data-category-id="DIC_kwDOJHu3mM4CUxhS" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script> </div> </div> <!-- Sidebar TOC (Desktop Only) --> <aside class="hidden lg:block sticky top-24 pt-8 max-h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar"> <div class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 font-sans">
On this page
</div> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#bitcask-components" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Bitcask components </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#append-only-data-files" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Append-only data files </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#keydir" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> KeyDir </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#bitcask-write-optimized-storage-engine" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Bitcask: Write-optimized storage engine </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#bitcask-read-optimized-storage-engine" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Bitcask: Read-optimized storage engine </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#operations" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Operations </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#put-putkey-value" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Put: put(key, value) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#update-updatekey-value" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Update: update(key, value) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#delete-deletekey" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Delete: delete(key) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#get-getkey" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Get: get(key) </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#merge-and-compaction" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Merge and compaction </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#hint-file" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Hint file </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </aside> </div> </article>  </main> <footer class="border-t border-slate-800 bg-slate-900 py-8 text-center text-sm text-zinc-500"> <div class="container mx-auto px-4">
tech-lessons.in &copy; 2020 / Powered by <a href="https://astro.build" target="_blank" class="hover:text-zinc-300 transition-colors">Astro</a> </div> </footer> </div> <!-- Subtle gradient glow at the bottom/edges (optional, keeping it really subtle) --> <div class="fixed inset-0 pointer-events-none z-[-1] bg-[radial-gradient(circle_at_50%_120%,rgba(120,119,198,0.1),rgba(255,255,255,0))]"></div> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.Ci7t3JeA.js"></script> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(t=>{const e=document.createElement("button");e.className="copy-code-button",e.innerHTML=`
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
							<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
						</svg>
					`,e.ariaLabel="Copy code";const r=document.createElement("div");r.className="code-block-wrapper relative group",t.parentNode&&(t.parentNode.insertBefore(r,t),r.appendChild(t),r.appendChild(e)),e.addEventListener("click",async()=>{const o=t.querySelector("code")?.innerText||t.innerText;try{await navigator.clipboard.writeText(o),e.innerHTML=`
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
							`,setTimeout(()=>{e.innerHTML=`
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								`},2e3)}catch(n){console.error("Failed to copy:",n)}})})});</script>  </body> </html>