<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.16.11"><!-- Canonical URL --><link rel="canonical" href="https://tech-lessons.in/en/blog/designing_lfu_cache/"><!-- Primary Meta Tags --><title>Designing an in-memory LFU cache</title><meta name="title" content="Designing an in-memory LFU cache"><meta name="description" content="Designing an in-memory LFU cache"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tech-lessons.in/en/blog/designing_lfu_cache/"><meta property="og:title" content="Designing an in-memory LFU cache"><meta property="og:description" content="Designing an in-memory LFU cache"><meta property="og:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tech-lessons.in/en/blog/designing_lfu_cache/"><meta property="twitter:title" content="Designing an in-memory LFU cache"><meta property="twitter:description" content="Designing an in-memory LFU cache"><meta property="twitter:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script><script>
	window.dataLayer = window.dataLayer || [];
	function gtag() {
		dataLayer.push(arguments);
	}
	gtag("js", new Date());

	gtag("config", "G-9KKTKFQ2CM");
</script><link rel="stylesheet" href="/_astro/about.Dq19AYy-.css"></head> <body class="bg-white text-zinc-900 min-h-screen flex flex-col md:flex-row selection:bg-black selection:text-white"> <header class="md:hidden sticky top-0 z-50 bg-slate-900 border-b border-slate-800 text-white"> <div class="flex items-center justify-between px-6 py-4"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="mobile-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Toggle menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="3" y1="12" x2="21" y2="12"></line> <line x1="3" y1="6" x2="21" y2="6"></line> <line x1="3" y1="18" x2="21" y2="18"></line> </svg> </button> </div> <!-- Mobile Menu Overlay --> <div id="mobile-menu" class="fixed inset-0 bg-slate-900 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-screen overflow-y-auto"> <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Close menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <nav class="flex flex-col p-6 gap-2"> <a href="/" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <div class="mt-auto p-6 border-t border-slate-800"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3 block mb-4">Contact</span> <div class="flex flex-col gap-2"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </div> </header> <script type="module">const t=document.getElementById("mobile-menu-btn"),n=document.getElementById("close-menu-btn"),e=document.getElementById("mobile-menu");t&&n&&e&&(t.addEventListener("click",()=>{e.classList.remove("translate-x-full")}),n.addEventListener("click",()=>{e.classList.add("translate-x-full")}),e.querySelectorAll("a").forEach(l=>{l.addEventListener("click",()=>{e.classList.add("translate-x-full")})}));</script> <aside class="hidden md:flex flex-col w-[280px] h-screen sticky top-0 border-r border-slate-800 bg-slate-900 p-8 shrink-0"> <!-- Profile --> <div class="flex flex-col items-start mb-12"> <div class="w-16 h-16 rounded-full border-2 border-slate-700 shadow-sm overflow-hidden mb-4 relative bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <h2 class="font-bold text-lg text-white leading-tight">
Sarthak Makhija
</h2> <span class="text-sm text-zinc-400">Databases & Storage Systems</span> </div> <!-- Navigation --> <nav class="flex-1 flex flex-col gap-1"> <a href="/" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <line x1="12" y1="20" x2="12" y2="10"></line> <line x1="18" y1="20" x2="18" y2="4"></line> <line x1="6" y1="20" x2="6" y2="16"></line> </svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <!-- Socials --> <div class="mt-auto pt-8 border-t border-slate-800 flex flex-col gap-4"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3">Contact</span> <div class="flex flex-col gap-1"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </aside> <div class="flex-1 flex flex-col min-w-0"> <main class="flex-1 max-w-[1280px] mx-auto px-6 py-12 md:py-20 w-full">  <article class="max-w-[1280px] mx-auto min-w-0"> <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12 items-start"> <div class="min-w-0"> <!-- Article Header --> <header class="mb-12"> <h1 class="text-[40px] md:text-[48px] font-sans font-extrabold text-black leading-[1.2] mb-6 tracking-tight"> Designing an in-memory LFU cache </h1> <div class="flex items-center gap-4 text-[16px] text-zinc-500 mb-8 border-b border-zinc-100 pb-8"> <time datetime="2023-05-26T00:00:00.000Z" class="text-zinc-400"> May 26, 2023 </time> <span>/</span> <span>Cache, TinyLFU, CacheD, Rust</span> </div> <div class="w-full mb-12"> <img width="1020" height="510" src="/lfu-cache-title.webp" alt="" class="w-full rounded-md shadow-sm"> <p class="text-left text-zinc-500 italic mt-3 text-sm"> Background by Drift Shutterbug on Pexels </p> </div> </header> <!-- Table of Contents (Mobile Only) --> <div class="lg:hidden bg-gray-50 rounded-lg p-6 mb-12 border border-zinc-100"> <h2 class="text-black font-bold font-sans text-[16px] uppercase tracking-wide mb-4">
Table of contents
</h2> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#lfu-cache" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> LFU cache </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#measuring-access-frequency" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Measuring access frequency </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#storing-keyvalue-mapping" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Storing key/value mapping </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#making-the-cache-memory-bound" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Making the cache memory bound </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#admission-and-eviction-policy" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Admission and eviction policy </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introducing-bp-wrapper" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introducing BP-Wrapper </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#get" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Get </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#put" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Put </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#measuring-metrics" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Measuring metrics </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#false-sharing" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> False sharing </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#measuring-cache-hit-ratio" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Measuring cache-hit ratio </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#distribution-of-elements" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Distribution of elements </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#relevant-research-papers" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Relevant research papers </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </div> <!-- Article Content --> <div class="prose prose-lg max-w-none text-black
            [&_h1]:font-serif [&_h1]:font-bold [&_h1]:text-black [&_h1]:text-[36px] [&_h1]:mt-10 [&_h1]:mb-4
            [&_h2]:font-serif [&_h2]:font-bold [&_h2]:text-black [&_h2]:text-[30px] [&_h2]:mt-10 [&_h2]:mb-6
            [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-black [&_h3]:text-[24px] [&_h3]:mt-10 [&_h3]:mb-4
            [&_h4]:font-sans [&_h4]:font-bold [&_h4]:text-black [&_h4]:text-[18px] [&_h4]:mt-8 [&_h4]:mb-4
            [&_p]:font-sans [&_p]:text-[1.125rem] [&_p]:leading-[1.7777778] [&_p]:text-zinc-800 [&_p]:my-[1em]
            [&_a]:underline [&_a]:decoration-zinc-400 [&_a]:transition-all
            
            /* Table Styling */
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:border [&_table]:border-zinc-200 [&_table]:rounded-lg [&_table]:overflow-hidden
            [&_th]:text-left [&_th]:p-3 [&_th]:border-b [&_th]:border-zinc-200 [&_th]:bg-zinc-50 [&_th]:font-semibold [&_th]:text-zinc-900
            [&_td]:p-3 [&_td]:border-b [&_td]:border-zinc-200 [&_td]:text-zinc-700
            [&_tr:last-child_td]:border-0
            
            [&_li]:text-[1.125rem] [&_li]:leading-[1.7777778] [&_li]:text-zinc-800 [&_li]:mb-2
            [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-6
            [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-6
            [&_img]:rounded-md [&_img]:shadow-lg [&_img]:my-8
            [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-zinc-500 [&_figcaption]:italic [&_figcaption]:mt-[-20px] [&_figcaption]:mb-8
            [&_blockquote]:relative [&_blockquote]:bg-zinc-100 [&_blockquote]:text-zinc-700 [&_blockquote]:p-8 [&_blockquote]:rounded-2xl [&_blockquote]:my-10 [&_blockquote]:not-italic [&_blockquote]:text-[1.1rem] [&_blockquote]:leading-relaxed [&_blockquote]:ml-24
            [&_blockquote::before]:content-[''] [&_blockquote::before]:absolute [&_blockquote::before]:top-8 [&_blockquote::before]:-left-3 [&_blockquote::before]:border-t-[12px] [&_blockquote::before]:border-t-transparent [&_blockquote::before]:border-b-[12px] [&_blockquote::before]:border-b-transparent [&_blockquote::before]:border-r-[16px] [&_blockquote::before]:border-r-zinc-100
            [&_blockquote::after]:content-[''] [&_blockquote::after]:absolute [&_blockquote::after]:-left-32 [&_blockquote::after]:-top-2 [&_blockquote::after]:w-28 [&_blockquote::after]:h-28 [&_blockquote::after]:bg-[url('/avatar.png')] [&_blockquote::after]:bg-contain [&_blockquote::after]:bg-no-repeat [&_blockquote::after]:bg-center [&_blockquote::after]:rounded-full [&_blockquote::after]:border-4 [&_blockquote::after]:border-white [&_blockquote::after]:shadow-md
            [&_pre]:p-6 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:my-8
            [&_code]:font-mono [&_code]:text-[14px] [&_code]:leading-relaxed"> <p>I had been working on building an in-memory LFU cache (least frequently used cache) and now that it is done, I thought of writing about the building blocks of an LFU cache. This article shares the building blocks of an LFU cache along with the ideas from two research papers: <a href="https://arxiv.org/pdf/1512.00727">TinyLFU</a> and <a href="https://ieeexplore.ieee.org/document/4812418">BP-Wrapper</a></p>
<p><a href="https://github.com/SarthakMakhija/cached">CacheD</a> is the name of my cache, and it is inspired by <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>.
I know <strong>CacheD</strong> is a very creative name. Thank you.</p>
<p>Let’s get started.</p>
<h3 id="lfu-cache">LFU cache</h3>
<p>According to <a href="https://en.wikipedia.org/wiki/Least_frequently_used">Wikipedia</a>: Least Frequently Used (LFU) is a type of cache algorithm used to manage memory within a computer. The standard characteristics of this method involve the system <em>keeping track of the number of times a block is referenced in memory</em>. When the <em>cache is full</em> and requires more room the system will <em>purge</em> the item with the <em>lowest reference frequency</em>.</p>
<p>Let’s now understand the building blocks of an LFU cache, starting with a way to measure the access frequency.</p>
<h3 id="measuring-access-frequency">Measuring access frequency</h3>
<p>All LFU caches need to maintain the access frequency for each key.
Storing the access frequency in a <code>HashMap</code>-like data structure would mean that the space used to store the frequency is directly proportional to the number of keys in the cache.
<mark class="author-highlight">This is an opportunity to use a probabilistic data structure like <a href="https://tech-lessons.in/blog/count_min_sketch/">count-min sketch</a> and make a trade-off between the accuracy of the access frequency and the space used to store the frequency.</mark></p>
<blockquote>
<p>Count-min sketch (CM sketch) is a probabilistic data structure that estimates the frequency of events in a data stream.
It relies on hash functions to map events to frequencies, but unlike a hash table, it uses only <strong>sublinear space</strong> at the expense of over-counting some events due to hash collisions. The count–min sketch was invented in 2003 by Graham Cormode and S. Muthu Muthukrishnan.</p>
</blockquote>
<p><strong>CacheD</strong> uses count-min sketch inside the abstraction <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/lfu/frequency_counter.rs">FrequencyCounter</a> to store the frequency for each key.</p>
<p>Count-min sketch is represented as a D*W matrix, where D is the total number of hash functions (or depth) and W is the width or the number of counters per hash function.</p>
<div class="align-center">
    <img src="/countminsketch.png">
</div>
<p>The matrix is initialized with zero at the beginning. A count-min sketch can be represented with the following structure:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[repr(transparent)]</span></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> Row</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> ROWS</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 4</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> FrequencyCounter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    matrix</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">Row</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">ROWS</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    seeds</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u64</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">ROWS</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//initialize the matrix</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> matrix</span><span style="color:#E1E4E8">(total_counters</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TotalCounters</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">Row</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">ROWS</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> total_counters </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (total_counters </span><span style="color:#F97583">/</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#B392F0"> usize</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> rows </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#79B8FF">0</span><span style="color:#F97583">..</span><span style="color:#79B8FF">ROWS</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">_index</span><span style="color:#F97583">|</span><span style="color:#B392F0"> Row</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">; total_counters]))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">collect</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Row</span><span style="color:#E1E4E8">>>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    rows</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We still need to decide on the number of counters. What should the number of counters be to get the closest access frequency estimate?</p>
<p>We can start with a simple theory. If an LFU cache contains N keys, we can keep N counters per hash function in the count-min sketch. However, we need to consider
hash conflicts.</p>
<p>Let’s understand the logic of incrementing the access frequency of a key with the following pseudocode.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">fn</span><span style="color:#B392F0"> increment_access_for</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, key</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Key</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">        // 1) Iterate through all the rows (row = 0 to depth = D)</span></span>
<span class="line"><span style="color:#6A737D">        // 2) Get the hash of the incoming key</span></span>
<span class="line"><span style="color:#6A737D">        // 3) Perform `hash % self.total_counters` to identify the column index (with width = W)</span></span>
<span class="line"><span style="color:#6A737D">        // 4) Increment the value at the identified column in the row R(i)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<p>Keeping the counters (imagine them as the number of columns) the same as the number of keys in the cache would mean a higher error rate in the access frequency estimate (because of hash conflicts).</p>
<p><mark class="author-highlight">To keep the estimates from wavering (/overestimating) too much because of hash conflicts, we need to have <code>counters = K times the number of keys</code>. Any choice of K is an attempt at reducing the hash conflict
of keys in each row.</mark></p>
<p><strong>CacheD</strong> proposes <code>K = 10</code> and does <a href="https://github.com/SarthakMakhija/cached/blob/main/benches/benchmarks/frequency_counter.rs">performance benchmarks</a> with <code>K = 2</code> and <code>K = 10</code>.</p>
<p>We have a way of measuring the access frequency of each key. Let’s understand a way to store the key/value mapping.</p>
<h3 id="storing-keyvalue-mapping">Storing key/value mapping</h3>
<p>We need a way to store the value by key. This is done by the <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/store/mod.rs">Store</a> abstraction in Cached.
<code>Store</code> uses <a href="https://docs.rs/dashmap/latest/dashmap/">DashMap</a>, a concurrent associative array/hashmap.</p>
<p><code>DashMap</code> maintains an array named <code>shards</code>; each element is a <code>RwLock</code> to a <code>HashMap</code>. The <code>put</code> operation for a key identifies the <code>shard_index</code>, acquires a <code>write lock</code>
against that shard and writes to the <code>HashMap</code> in the identified shard.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> DashMap</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> RandomState</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    shards</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Box</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">RwLock</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">HashMap</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">>>]>,</span></span>
<span class="line"><span style="color:#6A737D">    //code omitted</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We are build our key/value mapping on top of <code>DashMap</code>. The following code represents <code>Store</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> Store</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> Key</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Hash</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Eq</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    store</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DashMap</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">StoredValue</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">>>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> StoredValue</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    value</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Value</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    key_id</span><span style="color:#F97583">:</span><span style="color:#B392F0"> KeyId</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    expire_after</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ExpireAfter</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) is_soft_deleted</span><span style="color:#F97583">:</span><span style="color:#B392F0"> bool</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>There is another decision to be made here.</p>
<p>How should we return the value to the clients as a part of the <code>get</code> operation?</p>
<ul>
<li>Option 1: return a reference of the value</li>
<li>Option 2: force the clients to provide a cloneable value as a part of the <code>put</code> operation and return <code>Some&#x3C;Value></code> by cloning the value, if it exists for the key</li>
<li>Option 3: provide both options</li>
</ul>
<p>Let’s look at Option 1 first. To return a reference to the value, we need to look into the <code>get</code> method of <code>DashMap</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> get</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Q</span><span style="color:#E1E4E8">>(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">, key</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">Q</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Ref</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">>></span></span>
<span class="line"><span style="color:#F97583">where</span></span>
<span class="line"><span style="color:#B392F0">    K</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Borrow</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Q</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#B392F0">    Q</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Hash</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Eq</span><span style="color:#F97583"> +</span><span style="color:#F97583"> ?</span><span style="color:#B392F0">Sized</span><span style="color:#E1E4E8">, { </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">_get</span><span style="color:#E1E4E8">(key) }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> Ref</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> RandomState</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    _guard</span><span style="color:#F97583">:</span><span style="color:#B392F0"> RwLockReadGuard</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">HashMap</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">K</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">V</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">S</span><span style="color:#E1E4E8">>>,</span></span>
<span class="line"><span style="color:#E1E4E8">    k</span><span style="color:#F97583">:</span><span style="color:#F97583"> *const</span><span style="color:#79B8FF"> K</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    v</span><span style="color:#F97583">:</span><span style="color:#F97583"> *const</span><span style="color:#79B8FF"> V</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> type</span><span style="color:#B392F0"> RwLockReadGuard</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> lock_api</span><span style="color:#F97583">::</span><span style="color:#B392F0">RwLockReadGuard</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">RawRwLock</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//part of lock_api</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> RwLockReadGuard</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">R</span><span style="color:#F97583">:</span><span style="color:#B392F0"> RawRwLock</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">T</span><span style="color:#F97583">:</span><span style="color:#F97583"> ?</span><span style="color:#B392F0">Sized</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    rwlock</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#B392F0"> RwLock</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">R</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    marker</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PhantomData</span><span style="color:#E1E4E8">&#x3C;(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">R</span><span style="color:#F97583">::</span><span style="color:#B392F0">GuardMarker</span><span style="color:#E1E4E8">)>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<ul>
<li>The <code>get</code> method of <code>DashMap</code> returns an <code>Option&#x3C;Ref&#x3C;'a, K, V, S>></code>.</li>
<li><code>Ref</code> is a publicly available struct with a lifetime annotation <code>'a</code>, which is tied to the lifetime of <code>RwLockReadGuard</code>.</li>
<li>The lifetime of <code>RwLockReadGuard</code> of <code>DashMap</code> is tied to the lifetime of <code>lock_api::RwLockReadGuard</code>.</li>
<li>The lifetime of <code>RwLockReadGuard</code> is tied to the lifetime of <code>RwLock</code></li>
</ul>
<p>This means <mark class="author-highlight">if we decide to return a reference to the value for a key, we are actually returning <code>DashMap's Ref</code> and also <em>holding a lock</em> against the <em>shard</em> that the key belongs to.</mark></p>
<p>The <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/store/mod.rs">Store</a> abstraction in <strong>CacheD</strong> provides <code>get_ref</code> method that returns an instance of <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/store/key_value_ref.rs">KeyValueRef</a> which wraps <code>DashMap's Ref</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_ref</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, key</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">KeyValueRef</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">_</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">StoredValue</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">>>> {</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> KeyValueRef</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> Key</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Eq</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Hash</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    key_value_ref</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Ref</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>At the same time, <code>Store</code> provides <code>get</code> method if the value is cloneable, which returns an <code>Option&#x3C;Value></code>. This behavior will cause <code>DashMap</code> to hold the lock against the shard
while the value is being read, clone the value, return the value to the client, and drop the lock. This is a tradeoff (of sorts) in both the methods: <code>get_ref</code> and <code>get</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">Store</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> Key</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Hash</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Eq</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">          Value</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Clone</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">fn</span><span style="color:#B392F0"> get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, key</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Value</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> maybe_value </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">store</span><span style="color:#F97583">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(key);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> mapped_value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> maybe_value</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">stored_value</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> stored_value</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_alive</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">clock))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">key_value_ref</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> { key_value_ref</span><span style="color:#F97583">.</span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">() }); </span><span style="color:#6A737D">//clone the value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        mapped_value</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Let’s bring another requirement: “memory bound cache”.</p>
<h3 id="making-the-cache-memory-bound">Making the cache memory bound</h3>
<p>We want to design a cache that uses a fixed amount of memory determined by some configuration parameter.</p>
<p>This requirement brings in two concepts:</p>
<ol>
<li>Every key/value pair should take some size, and we should be able to determine the total size used by the cache.</li>
<li>We must ensure the total cache size does not exceed the specified limit.</li>
</ol>
<blockquote>
<p><strong>CacheD</strong> uses the term “weight” to denote the space (/size).</p>
</blockquote>
<p>Let’s understand the first point.</p>
<p>To associate weight with each key/value pair, we can provide a variant of the <code>put</code> method that takes <code>weight</code> as a parameter along with <code>key</code> and <code>value</code>.
<a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/cached.rs">Cached</a> provides a method <code>put_with_weight()</code> that allows the clients to specify the weight associated with each key/value pair.</p>
<p>Another option is to auto-calculate the weight for each key/value pair. To calculate the weight, we should be able to calculate the size of each key/value pair
using functions like <code>std::mem::size_of_val()</code> or <code>std::mem::size_of()</code> and adding to that the size of any additional metadata, like <code>expiry: Duration</code>, that might be stored
for each key/value pair.</p>
<p>The weight calculation in <strong>CacheD</strong> is available <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/config/weight_calculation.rs">here</a>.</p>
<p>Now that we have calculated the weight of each key/value pair, we should maintain the weight of each key and the total weight used by the cache.</p>
<p><strong>CacheD</strong> uses <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/policy/cache_weight.rs">CacheWeight</a> as an abstraction to maintain the weight of each key in the cache, and it also keeps the total weight used by the cache.
The weight of each key is maintained via the <code>WeightedKey</code> abstraction that contains the <code>key</code>, <code>key_hash</code> and its <code>weight</code>.
Every <code>put</code> increases the <em>cache weight</em>, every delete reduces the <em>cache weight</em>, and every update probably changes the <em>cache weight</em>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> CacheWeight</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> Key</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Hash</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Eq</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Send</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Sync</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Clone</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> '</span><span style="color:#B392F0">static</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    max_weight</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Weight</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    weight_used</span><span style="color:#F97583">:</span><span style="color:#B392F0"> RwLock</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Weight</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    key_weights</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DashMap</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">KeyId</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">WeightedKey</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">>>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We have the weight associated with each key/value pair.</p>
<h3 id="admission-and-eviction-policy">Admission and eviction policy</h3>
<p>Our cache is a memory-bound cache, and this poses an exciting challenge.</p>
<p><em>Should we admit the incoming key/value pair after the cache has reached its weight? If yes, which keys should be evicted to create the space because we can not let
the total cache weight increase beyond some threshold?</em></p>
<p>This is where the paper <a href="https://arxiv.org/pdf/1512.00727">TinyLFU</a> comes into the picture. <mark class="author-highlight">The main idea is to only let in a new key/value pair if its access estimate exceeds that of the item being evicted. This means that the incoming key/value pair should be more valuable to the cache than some existing key/value pairs, thereby improving the hit ratio.</mark></p>
<p>Let’s look at the approach:</p>
<p><strong>Approach</strong>:</p>
<ol>
<li>Get an estimate of the access frequency of the incoming key. The incoming key has not been accessed yet, but we <em>might</em> get some access count
because of hash conflicts since we rely on the probabilistic data structure <a href="https://tech-lessons.in/blog/count_min_sketch/">count-min sketch</a>
to maintain the access frequencies of the keys.</li>
<li>Get a sample of the existing keys (from <code>CacheWeight</code>) that consists of <code>keyId</code>, its <code>weight</code> and <code>its access frequency</code>. <em>Sample size can be configurable.</em></li>
<li>Pick the key with the smallest access frequency from the sample. Let’s call this key <em>K1</em>.</li>
<li>If the access frequency of the incoming key is less than the access frequency of the key <em>K1</em>, then reject the incoming key because
its access frequency is less than the smallest access frequency in the sample.</li>
<li>Else, <code>delete</code> the key <em>K1</em> and create the space in the cache. The space created will be equal to the <code>weight of K1</code>.</li>
<li>Repeat the process until either the incoming key is rejected or enough space to accommodate the incoming key is created in the cache.</li>
</ol>
<p>This approach is called “Sampled LFU”.
<strong>CacheD</strong> uses <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/policy/admission_policy.rs">AdmissionPolicy</a> abstraction to decide whether an incoming key/value pair should be admitted.</p>
<p>There is still one more case to consider. What if there is a key with high access frequency, and it has been a while since it has been seen. Will it never get evicted?</p>
<p>This point is around the recency of key access. The <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/lfu/tiny_lfu.rs">TinyLFU</a> abstraction ensures the recency of key access by the <code>reset</code> method.
We have used <code>count-min sketch</code> to maintain each key’s access frequency; every time a key is accessed, the frequency counter is incremented.
After N key increments, the counters get halved. So, a key that has not been seen for a while would also have its counter reset to half of the original value;
thereby providing a chance to the new incoming keys to get in. *<a href="https://arxiv.org/pdf/1512.00727">TinyLFU paper section: Freshness Mechanism</a></p>
<blockquote>
<p>The abstraction <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/lfu/tiny_lfu.rs">TinyLFU</a> has a <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/lfu/frequency_counter.rs">FrequencyCounter</a> and a <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/lfu/doorkeeper.rs">DoorKeeper</a>.
DoorKeeper is implemented using a <a href="https://tech-lessons.in/blog/bloom_filter/">Bloom filter</a>. Before increasing the access frequency of a key in <code>FrequencyCounter</code>,
a check is done in the <code>DoorKeeper</code> to see if the key is present. Only if the key is present in the <code>DoorKeeper</code>, its access count is incremented.
This ensures that <code>FrequencyCounter</code> does not have a long tail of keys that are not seen more than once.</p>
</blockquote>
<p>Our cache is concurrent, so let’s understand how to deal with contention.</p>
<h3 id="introducing-bp-wrapper">Introducing BP-Wrapper</h3>
<p>We have already seen <code>Store</code> and <code>count-min sketch</code> based <code>FrequencyCounter</code>. Technically, both are shared data structures prone to <a href="https://stackoverflow.com/questions/1970345/what-is-thread-contention">contention</a>.</p>
<p>Let’s understand this with an example. Imagine there is a <code>get</code> request for an existing key “topic”. The key has been accessed, so we should increment the access counter for the key.
<code>FrequencyCounter</code> is a shared data structure, so an option to increment the access counter is to take a lock on the entire data structure and then increment the
count. If multiple threads try to increase the access count for the same or different keys, all these threads would be contending for a single write lock on <code>FrequencyCounter</code>.</p>
<p>This is where the paper <a href="https://ieeexplore.ieee.org/document/4812418">BP-Wrapper</a> comes in. This paper suggests two ways of dealing with contention <em>prefetching</em> and <em>batching</em>.</p>
<p><strong>CacheD</strong> uses <em>batching</em> with <code>get</code> and <code>put</code> operations.</p>
<h4 id="get">Get</h4>
<p>A <code>get</code> operation returns the value for a key if it exists. It queries the <code>Store</code> and gets the value. The next step in <code>get</code> is to increase the access count for the key. This is where
the idea of <em>batching</em> comes in. All the <em>gets</em> are batched in a ring-buffer-like abstraction called <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/pool.rs">Pool</a>. <code>Pool</code>
is a collection of <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/pool.rs">Buffer</a> and each <code>Buffer</code> is a collection of hashes of the keys.</p>
<p>Any time a key is accessed, it is added to a buffer within the <code>Pool</code>. When a buffer is full, it is drained. Draining involves sending the entire <code>Vec&#x3C;KeyHash></code> to a <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/buffer_event.rs">BufferConsumer</a>.
<code>BufferConsumer</code> is implemented using a single thread that receives the buffer content from a <a href="https://crates.io/crates/crossbeam-channel">channel</a>. The <code>BufferConsumer</code> on receiving the buffer content applies it to the <code>FrequencyCounter</code>, thereby incrementing the frequency access of the entire set of keys.
The channel size is kept small to reduce contention and the memory footprint of collecting the buffer in memory. If the channel is full, the buffer content is dropped.</p>
<p><a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/policy/admission_policy.rs">AdmissionPolicy</a> plays the role of <code>BufferConsumer</code> in <strong>CacheD</strong>.</p>
<blockquote>
<p>The current implementation of <strong>CacheD</strong> uses a fine-grained lock over each buffer: <code>buffers: Vec&#x3C;RwLock&#x3C;Buffer&#x3C;Consumer>>></code>. The next release may change this implementation.</p>
</blockquote>
<h4 id="put">Put</h4>
<p>The idea with <code>get</code> was to buffer the accesses and apply them to the <code>FrequencyCounter</code> when the buffer gets full. We can not use the same idea with <code>put</code> because we want
to serve the <code>put</code> operations as soon as possible. However, batching is still relevant with <code>put</code> (or any other write) operations.</p>
<p>The idea is to treat every write operation (<code>put</code>, <code>update</code>, <code>delete</code>) as a command, send it to a <a href="https://doc.rust-lang.org/std/sync/mpsc/">mpsc channel</a> and have a single thread receive
commands from the channel and execute them one after the other.</p>
<p><strong>CacheD</strong> follows the same idea. Every write operation goes as a <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/command/mod.rs">Command</a> to the
<a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/command/command_executor.rs">CommandExecutor</a>. <code>CommandExecutor</code> is implemented as a single thread
that receives commands from a <a href="https://crates.io/crates/crossbeam-channel">crossbeam-channel</a>. Every time a command is received, it is executed by this single thread of execution.</p>
<p>This design choice has obvious implications.</p>
<ul>
<li>There is no guarantee that a <code>put</code> operation will happen successfully because it may be rejected by the <code>AdmissionPolicy</code> as described in the section <a href="#admission-and-eviction-policy">Admission and eviction policy</a></li>
<li>All the write operations are processed at a later point in time</li>
</ul>
<p>The solution to both these points lies in providing the right feedback to the clients. <strong>CacheD</strong> provides <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/command/acknowledgement.rs">CommandAcknowledgementHandle</a> as an abstraction that implements the <a href="https://doc.rust-lang.org/std/future/trait.Future.html">Future</a> trait.
Every write operation is returned an instance of <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/command/command_executor.rs">CommandSendResult</a> that wraps
<code>CommandAcknowledgement</code>, which provides a <code>handle()</code> method to return a <code>CommandAcknowledgementHandle</code> to the clients.</p>
<p>Clients can perform <code>await</code> on the <code>CommandAcknowledgementHandle</code> and get the <a href="https://github.com/SarthakMakhija/cached/blob/main/src/cache/command/mod.rs">CommandStatus</a>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[tokio</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">main]</span></span>
<span class="line"><span style="color:#F97583"> async</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> cached </span><span style="color:#F97583">=</span><span style="color:#B392F0"> CacheD</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ConfigBuilder</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> status </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cached</span><span style="color:#F97583">.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"topic"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"microservices"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">handle</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.await</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    assert_eq!</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">CommandStatus</span><span style="color:#F97583">::</span><span style="color:#B392F0">Accepted</span><span style="color:#E1E4E8">, status);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We have most of the building blocks for our cache; let’s now jump to the metrics collection in the cache.</p>
<h3 id="measuring-metrics">Measuring metrics</h3>
<p>At the end of the day, we would like to know how our cache is behaving. We want to collect counter-based metrics like <em>CacheHits</em>, <em>CacheMisses</em>, <em>KeysAdded</em>, <em>KeysDeleted</em> etc.</p>
<p>Let’s assume there are 16 such metrics that we want to collect. To do that, we can design a simple <code>ConcurrentStatsCounter</code> that can maintain an array of 16 entries, and
each array element is of type <code>AtomicU64</code>. Whenever an event happens, like a key getting added to the cache, we increment its corresponding counter.<br>
This approach can be represented with the following code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> TOTAL_STATS</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[repr(</span><span style="color:#B392F0">usize</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#E1E4E8">#[non_exhaustive]</span></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Copy</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Hash</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> StatsType</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">   KeysAdded</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">   KeysDeleted</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6A737D">   //+ others</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> ConcurrentStatsCounter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   entries</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">AtomicU64</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">TOTAL_STATS</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">fn</span><span style="color:#B392F0"> add_key</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) { </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">StatsType</span><span style="color:#F97583">::</span><span style="color:#B392F0">KeysAdded</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> add</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, stats_type</span><span style="color:#F97583">:</span><span style="color:#B392F0"> StatsType</span><span style="color:#E1E4E8">, count</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u64</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">   self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">entries[stats_type </span><span style="color:#F97583">as</span><span style="color:#B392F0"> usize</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">fetch_add</span><span style="color:#E1E4E8">(count, </span><span style="color:#B392F0">Ordering</span><span style="color:#F97583">::</span><span style="color:#B392F0">AcqRel</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The approach looks excellent. However, we need to understand the concept of <code>false sharing</code> before concluding on the approach’s greatness.</p>
<h4 id="false-sharing">False sharing</h4>
<p>The memory in the <em>L1</em>, <em>L2</em>, <em>L3</em> and <em>L4</em> processor cache is organized in units called “cache lines”.
<mark class="author-highlight">The cache line is the smallest data transfer unit between the main memory and the processor cache.</mark> If the cache line size is 64 bytes, then a contiguous block
of 64 bytes will be transferred from RAM to the processor cache for processing. The size of cache lines varies based on the type of the processor.
For example, on <em>x86-64</em>, <em>aarch64</em>, and <em>powerpc64</em>, <a href="https://docs.rs/crossbeam/0.8.2/crossbeam/utils/struct.CachePadded.html">cache line is 128 bytes</a>.</p>
<blockquote>
<p>Updating an atomic value invalidates the whole cache line it belongs to.</p>
</blockquote>
<p>Let’s go back to our code now. Let’s assume that the cache line size is 64 bytes. We have an array of <code>AtomicU64</code>; each <code>AtomicU64</code> takes <em>8 bytes</em> of memory. Our
cache line size is <em>64 bytes</em>, that means eight <code>AtomicU64</code> values will lie in one cache line.</p>
<p>Let’s imagine that <em>thread1</em> running on core-1 will update the atomic value at <em>index 0</em> and <em>thread2</em> running on core-2 will update the atomic value at <em>index 1</em>.
We know that these atomic values lie on the same cache line, and “updating an atomic value invalidates the whole cache line it belongs to”. Invalidating a cache line
will result in fetching that chunk of memory from RAM again.</p>
<p>Consider that <em>thread1</em> running on core-1 updates the atomic value at <em>index 0</em>, invalidating the entire cache line that this value belongs to. Now, <em>thread2</em> running on core-2 needs to update the value at <em>index 1</em>, but the entire cache line is invalidated. So, the cache line (64 bytes) needs to be fetched from RAM.
Reading/Writing from/to RAM is in the order of <a href="https://kt.academy/article/pmem-intro">80-100 ns</a> compared to the same from <em>L1</em>, <em>L2</em>, <em>L3</em> and <em>L4</em> cache, which is in the order of 1-10 ns.</p>
<p><em>thread2</em> running on core-2 updates the atomic value at <em>index 1</em> after the cache line is fetched. This update invalidates the entire cache line again and forces another fetch of the cache line from RAM. This fetch/re-fetch/re-re-fetch of the cache line is courtesy of “false sharing”.</p>
<blockquote>
<p>We are using “atomics” to ensure that each thread updates its value atomically, and because these values are on the
same cache line, both the threads running on different cores end up <strong>sharing</strong> the same cache line for <strong>writing</strong>. This increases latency
because of the repeated fetch of the cache line(s) from RAM. This is called “false sharing”. Imagine the extent of the problem with 128 cores.</p>
</blockquote>
<p><mark class="author-highlight">The way to deal with “false sharing” is to pad the values so that each <code>AtomicU64</code> lies on its cache line.</mark> One option is to pad the values manually, and the other is to use a library that can help with padding. <strong>CacheD</strong> uses <a href="https://docs.rs/crossbeam/0.8.2/crossbeam/utils/struct.CachePadded.html">CachePadded</a> to pad the values.</p>
<p>With the introduction of <code>CachePadded</code>, this is how the code looks like:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> TOTAL_STATS</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[repr(</span><span style="color:#B392F0">usize</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#E1E4E8">#[non_exhaustive]</span></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Copy</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Hash</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> StatsType</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">   KeysAdded</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">   KeysDeleted</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6A737D">   //+ others</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[repr(transparent)]</span></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#6A737D">//introduce a new abstraction that wraps AtomicU64 inside CachePadded</span></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> Counter</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">CachePadded</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">AtomicU64</span><span style="color:#E1E4E8">>);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">//entries now contains Counters instead of AtomicU64</span></span>
<span class="line"><span style="color:#6A737D">//each Counter is a CachePadded AtomicU64</span></span>
<span class="line"><span style="color:#6A737D">//therefore, each AtomicU64 is now placed on its own cache line</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> ConcurrentStatsCounter</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">   entries</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">Counter</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">TOTAL_STATS</span><span style="color:#E1E4E8">],   </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">fn</span><span style="color:#B392F0"> add_key</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) { </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">StatsType</span><span style="color:#F97583">::</span><span style="color:#B392F0">KeysAdded</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> add</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, stats_type</span><span style="color:#F97583">:</span><span style="color:#B392F0"> StatsType</span><span style="color:#E1E4E8">, count</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u64</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">   //fetch_add is now available in Counter</span></span>
<span class="line"><span style="color:#79B8FF">   self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">entries[stats_type </span><span style="color:#F97583">as</span><span style="color:#B392F0"> usize</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#79B8FF">0.</span><span style="color:#B392F0">fetch_add</span><span style="color:#E1E4E8">(count, </span><span style="color:#B392F0">Ordering</span><span style="color:#F97583">::</span><span style="color:#B392F0">AcqRel</span><span style="color:#E1E4E8">); </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We are done with all the building blocks :). Great job. Let’s understand a way to measure the cache-hit ratio.</p>
<h3 id="measuring-cache-hit-ratio">Measuring cache-hit ratio</h3>
<p>Hit ratio is defined by the following formula:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#B392F0">Hit</span><span style="color:#E1E4E8"> ratio </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> number of hits</span><span style="color:#F97583">/</span><span style="color:#E1E4E8">(number of hits </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> number of misses) </span></span>
<span class="line"><span style="color:#E1E4E8">or </span></span>
<span class="line"><span style="color:#B392F0">Hit</span><span style="color:#E1E4E8"> ratio </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> percentage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (number of hits</span><span style="color:#F97583">/</span><span style="color:#E1E4E8">(number of hits </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> number of misses)) </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 100</span></span></code></pre>
<p>Let’s understand the problem better. We need the following:</p>
<ol>
<li>A distribution of elements of type <code>T</code>. We will be performing <code>get</code> and <code>put</code> operations using the elements of this distribution. The distribution:
<ul>
<li>should consist of values (/elements) within the specified range</li>
<li>should have some way of defining the repetition of elements (some elements should occur M times, some should occur P times, while some should occur just one time)</li>
</ul>
</li>
<li>For each element, perform a <code>get</code> operation in the cache
<ul>
<li>This results in measuring the hits and misses</li>
</ul>
</li>
<li>If the element is not present, perform a <code>put</code> operation in the cache
<ul>
<li>This results in adding a new element from the distribution in the cache</li>
</ul>
</li>
</ol>
<h4 id="distribution-of-elements">Distribution of elements</h4>
<p>The distribution of elements is a collection of N elements of type <code>T</code> that will be loaded in the cache via <code>put</code> operation and the elements from this distribution
will be queried from the cache via <code>get</code> operation. This distribution should be able to repeat elements based on some logic.</p>
<p>Let’s take a look at <a href="https://en.wikipedia.org/wiki/Zipf&#x27;s_law">Zipf’s law</a>.</p>
<blockquote>
<p>Zipf’s law often holds, approximately, when a list of measured values is sorted in decreasing order. It states that the value of the nth entry is inversely proportional to n.
The best known instance of Zipf’s law applies to the frequency table of words in a text or corpus of natural language.
Namely, it is usually found that the most common word occurs approximately twice as often as the next common one, three times as often as the third most common, and so on. For example, in the Brown Corpus of American English text, the word “the” is the most frequently occurring word, and by itself accounts for nearly 7% of all word occurrences (69,971 out of slightly over 1 million). True to Zipf’s Law, the second-place word “of” accounts for slightly over 3.5% of words (36,411 occurrences), followed by “and” (28,852).
(<a href="https://en.wikipedia.org/wiki/Zipf&#x27;s_law">Referenced from</a>).</p>
</blockquote>
<p>If the words are ranked according to their frequencies in a large collection, then the frequency will decline as the rank increases, so a small number of items appear very often, and a large number rarely occur. (<a href="https://www.techtarget.com/whatis/definition/Zipfs-Law">Reference</a>).</p>
<p>This idea matches what we want. We can use the Zipf distribution to check cache hits because it will cause some elements to appear frequently while others will appear rarely. In the rust ecosystem, the crate <a href="https://docs.rs/rand_distr/0.4.3/rand_distr/struct.Zipf.html">rand_distr</a>
provides the Zipf distribution.</p>
<p>We have the distribution part sorted out. Now, we can write a benchmark that loads K elements of the distribution in a cache with weight W. All we need to do is identify K and W.</p>
<p>The idea is to have a large enough distribution sample, and <strong>CacheD</strong> uses a distribution size of <em>16 * 100_000</em>, which means the Zipf distribution will contain <em>16 * 100_000</em>
elements with the biggest value as <em>16 * 100_000</em>. So, our K = <em>16 * 100_000</em>.</p>
<p>Each key/value pair that is being loaded is of type <code>u64</code>, and the weight of a single key/value pair is <em>40 bytes</em>.</p>
<p>We want the cache weight to be less than the total weight of the incoming elements to simulate <a href="#admission-and-eviction-policy">rejections</a>. We keep the cache weight to be <em>1/16</em>th of the total weight of the incoming elements.
That means the cache weight (W) = <em>100_000 * 40 bytes</em>. That’s it; we are now ready to run the <a href="https://github.com/SarthakMakhija/cached/blob/main/benches/benchmarks/cache_hits.rs">benchmark</a>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#6A737D">/// Defines the total number of key/value pairs that may be loaded in the cache</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> CAPACITY</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 100_000</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/// Defines the total number of counters used to measure the access frequency.</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> COUNTERS</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TotalCounters</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">CAPACITY</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#B392F0"> TotalCounters</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/// Defines the total size of the cache.</span></span>
<span class="line"><span style="color:#6A737D">/// It is kept to CAPACITY * 40 because the benchmark inserts keys and values with weight 40.</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> WEIGHT</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Weight</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">CAPACITY</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 40</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#B392F0"> Weight</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/// Defines the total sample size that is used for generating Zipf distribution.</span></span>
<span class="line"><span style="color:#6A737D">/// Here, ITEMS is 16 times the CAPACITY to provide a larger sample for Zipf distribution.</span></span>
<span class="line"><span style="color:#6A737D">/// W/C = 16, W denotes the sample size, and C is the cache size</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> ITEMS</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> CAPACITY</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> cache_hits_single_threaded_exponent_1_001</span><span style="color:#E1E4E8">(criterion</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;mut</span><span style="color:#B392F0"> Criterion</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">   criterion</span><span style="color:#F97583">.</span><span style="color:#B392F0">bench_function</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Cached.get()"</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">|</span><span style="color:#E1E4E8">bencher</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      let</span><span style="color:#E1E4E8"> runtime </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Builder</span><span style="color:#F97583">::</span><span style="color:#B392F0">new_multi_thread</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">              .</span><span style="color:#B392F0">worker_threads</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">              .</span><span style="color:#B392F0">enable_all</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">              .</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">              .</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">      bencher</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_async</span><span style="color:#E1E4E8">(runtime)</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter_custom</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">iterations</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">         async</span><span style="color:#F97583"> move</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> cached </span><span style="color:#F97583">=</span><span style="color:#B392F0"> CacheD</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ConfigBuilder</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">COUNTERS</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">CAPACITY</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">WEIGHT</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> distribution </span><span style="color:#F97583">=</span><span style="color:#B392F0"> distribution_with_exponent</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">ITEMS</span><span style="color:#F97583"> as</span><span style="color:#B392F0"> u64</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">ITEMS</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1.001</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">//Zipf exponent</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> hit_miss_recorder </span><span style="color:#F97583">=</span><span style="color:#B392F0"> HitsMissRecorder</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> index </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> start </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Instant</span><span style="color:#F97583">::</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            for</span><span style="color:#E1E4E8"> _ </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583">..</span><span style="color:#79B8FF">CAPACITY</span><span style="color:#F97583">*</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">               let</span><span style="color:#E1E4E8"> option </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cached</span><span style="color:#F97583">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">distribution[index]);</span></span>
<span class="line"><span style="color:#F97583">               if</span><span style="color:#E1E4E8"> option</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_some</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">                  hit_miss_recorder</span><span style="color:#F97583">.</span><span style="color:#B392F0">record_hit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">               } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                  hit_miss_recorder</span><span style="color:#F97583">.</span><span style="color:#B392F0">record_miss</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">               }</span></span>
<span class="line"><span style="color:#E1E4E8">               cached</span><span style="color:#F97583">.</span><span style="color:#B392F0">put_with_weight</span><span style="color:#E1E4E8">(distribution[index], distribution[index], </span><span style="color:#79B8FF">40</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">handle</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.await</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">               index </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">            cached</span><span style="color:#F97583">.</span><span style="color:#B392F0">shutdown</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">            println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} %"</span><span style="color:#E1E4E8">, hit_miss_recorder</span><span style="color:#F97583">.</span><span style="color:#B392F0">ratio</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">            start</span><span style="color:#F97583">.</span><span style="color:#B392F0">elapsed</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">         }</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">   });</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The result for cache-hits in <strong>CacheD</strong> is available <a href="https://github.com/SarthakMakhija/cached#measuring-cache-hit-ratio">here</a>.</p>
<p>That’s it. We have all the building blocks needed to build an in-memory LFU cache.</p>
<h3 id="code">Code</h3>
<p>The source code of <strong>CacheD</strong> is available <a href="https://github.com/SarthakMakhija/cached">here</a> and the crate is available <a href="https://crates.io/crates/tinylfu-cached">here</a>.</p>
<h3 id="relevant-research-papers">Relevant research papers</h3>
<ul>
<li><a href="https://arxiv.org/pdf/1512.00727">TinyLFU</a></li>
<li><a href="https://ieeexplore.ieee.org/document/4812418">BP-Wrapper</a></li>
</ul>
<h3 id="references">References</h3>
<ul>
<li><a href="https://github.com/dgraph-io/ristretto">Ristretto</a></li>
<li><a href="https://en.wikipedia.org/wiki/Zipf&#x27;s_law">Zipf’s law wikipedia</a></li>
<li><a href="https://www.techtarget.com/whatis/definition/Zipfs-Law">Zipf’s law techtarget</a></li>
</ul> </div> <!-- Tags Section --> <div class="mt-12 pt-8 border-t border-zinc-100"> <div class="flex flex-wrap gap-3"> <div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Cache </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> TinyLFU </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> CacheD </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Rust </div> </div> </div> <!-- Related Essays --> <div class="mt-12 pt-8 border-t border-zinc-100"> <h2 class="text-2xl font-bold font-sans mb-6 text-black">
More from Tech Lessons
</h2> <div class="grid gap-6 md:grid-cols-2"> <a href="/en/blog/diving_into_rust/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Diving into Rust by building an assertions crate </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2024-01-24T00:00:00.000Z" class="text-zinc-400"> Jan 24, 2024 </time> </div> </a> </div> </div> <!-- Giscus Comments --> <div class="mt-16 pt-8 border-t border-zinc-100"> <script src="https://giscus.app/client.js" data-repo="SarthakMakhija/tech-lessons-comments" data-repo-id="R_kgDOJHu3mA" data-category="Announcements" data-category-id="DIC_kwDOJHu3mM4CUxhS" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script> </div> </div> <!-- Sidebar TOC (Desktop Only) --> <aside class="hidden lg:block sticky top-24 pt-8 max-h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar"> <div class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 font-sans">
On this page
</div> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#lfu-cache" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> LFU cache </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#measuring-access-frequency" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Measuring access frequency </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#storing-keyvalue-mapping" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Storing key/value mapping </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#making-the-cache-memory-bound" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Making the cache memory bound </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#admission-and-eviction-policy" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Admission and eviction policy </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introducing-bp-wrapper" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introducing BP-Wrapper </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#get" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Get </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#put" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Put </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#measuring-metrics" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Measuring metrics </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#false-sharing" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> False sharing </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#measuring-cache-hit-ratio" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Measuring cache-hit ratio </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#distribution-of-elements" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Distribution of elements </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#relevant-research-papers" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Relevant research papers </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </aside> </div> </article>  </main> <footer class="border-t border-slate-800 bg-slate-900 py-8 text-center text-sm text-zinc-500"> <div class="container mx-auto px-4">
tech-lessons.in &copy; 2020 / Powered by <a href="https://astro.build" target="_blank" class="hover:text-zinc-300 transition-colors">Astro</a> </div> </footer> </div> <!-- Subtle gradient glow at the bottom/edges (optional, keeping it really subtle) --> <div class="fixed inset-0 pointer-events-none z-[-1] bg-[radial-gradient(circle_at_50%_120%,rgba(120,119,198,0.1),rgba(255,255,255,0))]"></div> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.Ci7t3JeA.js"></script> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(t=>{const e=document.createElement("button");e.className="copy-code-button",e.innerHTML=`
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
							<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
						</svg>
					`,e.ariaLabel="Copy code";const r=document.createElement("div");r.className="code-block-wrapper relative group",t.parentNode&&(t.parentNode.insertBefore(r,t),r.appendChild(t),r.appendChild(e)),e.addEventListener("click",async()=>{const o=t.querySelector("code")?.innerText||t.innerText;try{await navigator.clipboard.writeText(o),e.innerHTML=`
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
							`,setTimeout(()=>{e.innerHTML=`
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								`},2e3)}catch(n){console.error("Failed to copy:",n)}})})});</script>  </body> </html>