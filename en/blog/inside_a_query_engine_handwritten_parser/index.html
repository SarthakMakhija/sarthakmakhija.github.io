<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.16.11"><!-- Canonical URL --><link rel="canonical" href="https://tech-lessons.in/en/blog/inside_a_query_engine_handwritten_parser/"><!-- Primary Meta Tags --><title>Inside a Query Engine (Part 3): Handwritten Parser</title><meta name="title" content="Inside a Query Engine (Part 3): Handwritten Parser"><meta name="description" content="Inside a Query Engine (Part 3): Handwritten Parser"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tech-lessons.in/en/blog/inside_a_query_engine_handwritten_parser/"><meta property="og:title" content="Inside a Query Engine (Part 3): Handwritten Parser"><meta property="og:description" content="Inside a Query Engine (Part 3): Handwritten Parser"><meta property="og:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tech-lessons.in/en/blog/inside_a_query_engine_handwritten_parser/"><meta property="twitter:title" content="Inside a Query Engine (Part 3): Handwritten Parser"><meta property="twitter:description" content="Inside a Query Engine (Part 3): Handwritten Parser"><meta property="twitter:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script><script>
	window.dataLayer = window.dataLayer || [];
	function gtag() {
		dataLayer.push(arguments);
	}
	gtag("js", new Date());

	gtag("config", "G-9KKTKFQ2CM");
</script><link rel="stylesheet" href="/_astro/about.Dq19AYy-.css"></head> <body class="bg-white text-zinc-900 min-h-screen flex flex-col md:flex-row selection:bg-black selection:text-white"> <header class="md:hidden sticky top-0 z-50 bg-slate-900 border-b border-slate-800 text-white"> <div class="flex items-center justify-between px-6 py-4"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="mobile-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Toggle menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="3" y1="12" x2="21" y2="12"></line> <line x1="3" y1="6" x2="21" y2="6"></line> <line x1="3" y1="18" x2="21" y2="18"></line> </svg> </button> </div> <!-- Mobile Menu Overlay --> <div id="mobile-menu" class="fixed inset-0 bg-slate-900 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-screen overflow-y-auto"> <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Close menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <nav class="flex flex-col p-6 gap-2"> <a href="/" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <div class="mt-auto p-6 border-t border-slate-800"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3 block mb-4">Contact</span> <div class="flex flex-col gap-2"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </div> </header> <script type="module">const t=document.getElementById("mobile-menu-btn"),n=document.getElementById("close-menu-btn"),e=document.getElementById("mobile-menu");t&&n&&e&&(t.addEventListener("click",()=>{e.classList.remove("translate-x-full")}),n.addEventListener("click",()=>{e.classList.add("translate-x-full")}),e.querySelectorAll("a").forEach(l=>{l.addEventListener("click",()=>{e.classList.add("translate-x-full")})}));</script> <aside class="hidden md:flex flex-col w-[280px] h-screen sticky top-0 border-r border-slate-800 bg-slate-900 p-8 shrink-0"> <!-- Profile --> <div class="flex flex-col items-start mb-12"> <div class="w-16 h-16 rounded-full border-2 border-slate-700 shadow-sm overflow-hidden mb-4 relative bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <h2 class="font-bold text-lg text-white leading-tight">
Sarthak Makhija
</h2> <span class="text-sm text-zinc-400">Databases & Storage Systems</span> </div> <!-- Navigation --> <nav class="flex-1 flex flex-col gap-1"> <a href="/" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <line x1="12" y1="20" x2="12" y2="10"></line> <line x1="18" y1="20" x2="18" y2="4"></line> <line x1="6" y1="20" x2="6" y2="16"></line> </svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <!-- Socials --> <div class="mt-auto pt-8 border-t border-slate-800 flex flex-col gap-4"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3">Contact</span> <div class="flex flex-col gap-1"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </aside> <div class="flex-1 flex flex-col min-w-0"> <main class="flex-1 max-w-[1280px] mx-auto px-6 py-12 md:py-20 w-full">  <article class="max-w-[1280px] mx-auto min-w-0"> <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12 items-start"> <div class="min-w-0"> <!-- Article Header --> <header class="mb-12"> <h1 class="text-[40px] md:text-[48px] font-sans font-extrabold text-black leading-[1.2] mb-6 tracking-tight"> Inside a Query Engine (Part 3): Handwritten Parser </h1> <div class="flex items-center gap-4 text-[16px] text-zinc-500 mb-8 border-b border-zinc-100 pb-8"> <time datetime="2026-02-23T00:00:00.000Z" class="text-zinc-400"> Feb 23, 2026 </time> <span>/</span> <span>Query, Parser, Rust, Recursive Descent</span> </div>  </header> <!-- Table of Contents (Mobile Only) --> <div class="lg:hidden bg-gray-50 rounded-lg p-6 mb-12 border border-zinc-100"> <h2 class="text-black font-bold font-sans text-[16px] uppercase tracking-wide mb-4">
Table of contents
</h2> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#the-parsers-boundary-syntax-vs-semantics" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Parser’s Boundary: Syntax vs. Semantics </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#parser-errors-when-syntax-fails" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Parser Errors: When Syntax Fails </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#mapping-grammar-to-code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Mapping Grammar to Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-engine-under-the-hood-the-tokencursor" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Engine Under the Hood: The TokenCursor </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#handling-optionality-maybe-vs-expect" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Handling Optionality: Maybe vs. Expect </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#deconstructing-parse_select" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Deconstructing parse_select </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#the-sentinel-why-eof-matters" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Sentinel: Why EOF Matters </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </div> <!-- Article Content --> <div class="prose prose-lg max-w-none text-black
            [&_h1]:font-serif [&_h1]:font-bold [&_h1]:text-black [&_h1]:text-[36px] [&_h1]:mt-10 [&_h1]:mb-4
            [&_h2]:font-serif [&_h2]:font-bold [&_h2]:text-black [&_h2]:text-[30px] [&_h2]:mt-10 [&_h2]:mb-6
            [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-black [&_h3]:text-[24px] [&_h3]:mt-10 [&_h3]:mb-4
            [&_h4]:font-sans [&_h4]:font-bold [&_h4]:text-black [&_h4]:text-[18px] [&_h4]:mt-8 [&_h4]:mb-4
            [&_p]:font-sans [&_p]:text-[1.125rem] [&_p]:leading-[1.7777778] [&_p]:text-zinc-800 [&_p]:my-[1em]
            [&_a]:underline [&_a]:decoration-zinc-400 [&_a]:transition-all
            
            /* Table Styling */
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:border [&_table]:border-zinc-200 [&_table]:rounded-lg [&_table]:overflow-hidden
            [&_th]:text-left [&_th]:p-3 [&_th]:border-b [&_th]:border-zinc-200 [&_th]:bg-zinc-50 [&_th]:font-semibold [&_th]:text-zinc-900
            [&_td]:p-3 [&_td]:border-b [&_td]:border-zinc-200 [&_td]:text-zinc-700
            [&_tr:last-child_td]:border-0
            
            [&_li]:text-[1.125rem] [&_li]:leading-[1.7777778] [&_li]:text-zinc-800 [&_li]:mb-2
            [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-6
            [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-6
            [&_img]:rounded-md [&_img]:shadow-lg [&_img]:my-8
            [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-zinc-500 [&_figcaption]:italic [&_figcaption]:mt-[-20px] [&_figcaption]:mb-8
            [&_blockquote]:relative [&_blockquote]:bg-zinc-100 [&_blockquote]:text-zinc-700 [&_blockquote]:p-8 [&_blockquote]:rounded-2xl [&_blockquote]:my-10 [&_blockquote]:not-italic [&_blockquote]:text-[1.1rem] [&_blockquote]:leading-relaxed [&_blockquote]:ml-24
            [&_blockquote::before]:content-[''] [&_blockquote::before]:absolute [&_blockquote::before]:top-8 [&_blockquote::before]:-left-3 [&_blockquote::before]:border-t-[12px] [&_blockquote::before]:border-t-transparent [&_blockquote::before]:border-b-[12px] [&_blockquote::before]:border-b-transparent [&_blockquote::before]:border-r-[16px] [&_blockquote::before]:border-r-zinc-100
            [&_blockquote::after]:content-[''] [&_blockquote::after]:absolute [&_blockquote::after]:-left-32 [&_blockquote::after]:-top-2 [&_blockquote::after]:w-28 [&_blockquote::after]:h-28 [&_blockquote::after]:bg-[url('/avatar.png')] [&_blockquote::after]:bg-contain [&_blockquote::after]:bg-no-repeat [&_blockquote::after]:bg-center [&_blockquote::after]:rounded-full [&_blockquote::after]:border-4 [&_blockquote::after]:border-white [&_blockquote::after]:shadow-md
            [&_pre]:p-6 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:my-8
            [&_code]:font-mono [&_code]:text-[14px] [&_code]:leading-relaxed"> <p>In the <a href="/en/blog/inside_a_query_engine_thinking_in_grammar/">previous essay</a>, we designed our language using EBNF and defined the structure of our Abstract Syntax Tree (AST). Now, it’s time to breathe life into those rules. In this part, we will build a <strong>Handwritten Recursive Descent Parser</strong> in Rust to transform a stream of tokens into an AST.</p>
<p>The outcome of the parsing phase is the <strong>AST</strong> (Abstract Syntax Tree), a tree representation of the query that the engine can actually work with. Within the parser’s domain, we speak in the vocabulary of language structure: statements, clauses, projections, and table sources.</p>
<h3 id="the-parsers-boundary-syntax-vs-semantics">The Parser’s Boundary: Syntax vs. Semantics</h3>
<p>One of the most important design principles in query engines is knowing what the parser <strong>should not</strong> know.</p>
<p>A parser is a <strong>syntactic</strong> validator, not a <strong>semantic</strong> one. It knows <em>how</em> a query should look, but it has no idea if the query is actually executable in the real world. Specifically, a parser does not know:</p>
<ul>
<li><strong>Catalog Information</strong>: It doesn’t know if a table named <code>employees</code> actually exists.</li>
<li><strong>Schema Validation</strong>: It doesn’t know if a column exists or if you are trying to compare an integer to a string.</li>
<li><strong>Permissions</strong>: It doesn’t know if you have the right to access that data.</li>
</ul>
<p>These checks belong to a later stage called <strong>Semantic Analysis</strong> or <strong>Binding</strong>. Keeping the parser purely syntactic makes it fast, reusable, and easy to test.</p>
<h3 id="parser-errors-when-syntax-fails">Parser Errors: When Syntax Fails</h3>
<p>When a query doesn’t follow the grammar, the parser must fail gracefully with a descriptive error. In <a href="https://github.com/SarthakMakhija/relop">Relop</a>, we model these using a robust <a href="https://github.com/SarthakMakhija/relop/blob/main/src/query/parser/error.rs">ParseError</a> enum:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> ParseError</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    /// Encountered an unsupported token when starting a statement (e.g., "UPDATE")</span></span>
<span class="line"><span style="color:#B392F0">    UnsupportedToken</span><span style="color:#E1E4E8"> { expected</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">, found</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    /// Encountered a token that doesn't match the expected rule (e.g., "SELECT 1" instead of "SELECT *")</span></span>
<span class="line"><span style="color:#B392F0">    UnexpectedToken</span><span style="color:#E1E4E8"> { expected</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">, found</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    /// The input string ended while the parser was still expecting more tokens</span></span>
<span class="line"><span style="color:#B392F0">    UnexpectedEndOfInput</span><span style="color:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    /// Specialized errors for specific literal logic</span></span>
<span class="line"><span style="color:#B392F0">    LimitOutOfRange</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    ZeroLimit</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    /// Indicates that no tokens were available to parse.</span></span>
<span class="line"><span style="color:#B392F0">    NoTokens</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>For example, if a user types <code>SELECT *</code>, the parser will produce an <code>UnexpectedEndOfInput</code> error because it was expecting <code>FROM</code> after the projection, according to the grammar.</p>
<h3 id="mapping-grammar-to-code">Mapping Grammar to Code</h3>
<p>The beauty of a <strong>Recursive Descent Parser</strong> is that it mirrors the grammar almost one-to-one. This one-to-one mapping is the defining characteristic of recursive descent.</p>
<p>Consider our simplified grammar and its translation, <a href="https://github.com/SarthakMakhija/relop/commit/dbe8c3e2a9411d217f4f25da629b0fc5e5e0da4d">dbe8c3e2a9411d217f4f25da629b0fc5e5e0da4d</a>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>select = "SELECT" "*" "FROM" identifier [";"] ;</span></span></code></pre>
<p>Our implementation uses a <code>TokenCursor</code> to navigate the stream of tokens and helper methods like <code>expect_keyword</code> and <code>maybe_semicolon</code> to handle the logic of building AST:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#B392F0"> Parser</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> parse_select</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Ast</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"select"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_star</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"from"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> table_name </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_identifier</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#B392F0">maybe_semicolon</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">        Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Ast</span><span style="color:#F97583">::</span><span style="color:#B392F0">Select</span><span style="color:#E1E4E8"> { table_name })</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> expect_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">, keyword</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;(), </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">        match</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">            Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">matches</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">TokenType</span><span style="color:#F97583">::</span><span style="color:#B392F0">Keyword</span><span style="color:#E1E4E8">, keyword) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(()),</span></span>
<span class="line"><span style="color:#B392F0">            Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedToken</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                expected</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> keyword</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                found</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">lexeme</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            }),</span></span>
<span class="line"><span style="color:#B392F0">            None</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedEndOfInput</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> expect_star</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;(), </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">        match</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">            Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_star</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(()),</span></span>
<span class="line"><span style="color:#B392F0">            Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedToken</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                expected</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> "*"</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                found</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">lexeme</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            }),</span></span>
<span class="line"><span style="color:#B392F0">            None</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedEndOfInput</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> expect_identifier</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">        match</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">            Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_identifier</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(token</span><span style="color:#F97583">.</span><span style="color:#B392F0">lexeme</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">()),</span></span>
<span class="line"><span style="color:#B392F0">            Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedToken</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                expected</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> "identifier"</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                found</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">lexeme</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            }),</span></span>
<span class="line"><span style="color:#B392F0">            None</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedEndOfInput</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> maybe_semicolon</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> let</span><span style="color:#B392F0"> Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">peek</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_semicolon</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#79B8FF">                self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h4 id="the-engine-under-the-hood-the-tokencursor">The Engine Under the Hood: The TokenCursor</h4>
<p>For the parser to navigate the stream of tokens, it needs an internal “engine.” In Relop, this is the <code>TokenCursor</code>. It maintains the state of our progress through the token list.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> TokenCursor</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    stream</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TokenStream</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    index</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> TokenStream</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    tokens</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Token</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> Token</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    lexeme</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    token_type</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TokenType</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The cursor provides two fundamental primitives that drive the entire parsing process:</p>
<ol>
<li><strong>Lookahead with <code>peek()</code></strong>: This allows the parser to see the current token without consuming it. This is how we decide which “branch” of the grammar to follow. By looking at the first token, we can distinguish between a <code>SELECT</code>, a <code>SHOW</code>, or a <code>DESCRIBE</code> statement.</li>
<li><strong>Consumption with <code>next()</code></strong>: Once the parser validates that a token satisfies a rule, it calls <code>next()</code> to advance the pointer. This represents “making progress” in the query.</li>
</ol>
<h4 id="handling-optionality-maybe-vs-expect">Handling Optionality: Maybe vs. Expect</h4>
<p>Handwritten parsers excel at handling the nuances of optional grammar. We use two distinct patterns:</p>
<ul>
<li><strong>The “Expect” Pattern</strong>: Used for required tokens (like <code>SELECT</code> or <code>FROM</code>). If the token isn’t there, the parser stops and returns an error immediately.</li>
<li><strong>The “Maybe” Pattern</strong>: Used for optional components like the semicolon ([<code>;</code>]). The parser checks if the token exists; if it does, it consumes it; if not, it simply moves on without complaining.</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> maybe_semicolon</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> let</span><span style="color:#B392F0"> Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">peek</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_semicolon</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#79B8FF">            self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">(); </span><span style="color:#6A737D">// Consume it if it's there</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // Just return if it's not</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h4 id="deconstructing-parse_select">Deconstructing <code>parse_select</code></h4>
<p>The <code>parse_select</code> method is a perfect example of how the parser enforces a strict sequence:</p>
<ol>
<li><strong>Keyword Check</strong>: It first ensures the query starts with <code>SELECT</code>.</li>
<li><strong>Projection</strong>: It then calls a specialized <code>expect_star()</code> method to find the <code>*</code>.</li>
<li><strong>Source Identification</strong>: It expects the <code>FROM</code> keyword, then extracts the table name using <code>expect_identifier()</code>.</li>
<li><strong>Optional Cleanup</strong>: Finally, it calls <code>maybe_semicolon()</code> to handle the trailing symbol if present.</li>
</ol>
<p>By stripping away the “sugar,” we create a clean model that focuses entirely on the <strong>intent</strong> of the user.</p>
<h3 id="the-sentinel-why-eof-matters">The Sentinel: Why EOF Matters</h3>
<p>You might have noticed the call to <code>self.expect_end_of_stream()</code> in the main <code>parse</code> method. This checks for the <strong>EOF (End of Stream)</strong> token.</p>
<p>In query parsing, the EOF token is the “sentinel” that ensures the <strong>entire</strong> input was consumed. Without enforcing EOF, the parser may successfully match only a prefix of the input, silently ignoring trailing tokens. Eg; a query like <code>SELECT * FROM table garbage_at_the_end</code> would be considered valid by the parser because it would stop successfully after parsing the table name, leaving the “garbage” unexamined.</p>
<p>The EOF token ensures that we haven’t just matched a <em>prefix</em> of the user’s input, but that the <em>whole</em> string satisfies our grammar.</p>
<p>The complete <code>Parser</code> is available <a href="https://github.com/SarthakMakhija/relop/blob/main/src/query/parser/mod.rs#L18">here</a>.</p>
<h3 id="conclusion">Conclusion</h3>
<p>A handwritten parser provides precise control over error handling, structure, and performance. By mapping our EBNF rules to simple, predictable Rust methods, we’ve transformed the stream of tokens into a structured syntactic model (the AST) that our engine can understand.</p>
<p>In the next part, we’ll tackle the most challenging part of parsing: <a href="/en/blog/inside_a_query_engine_expressions_and_precedence">Expressions and Precedence</a>.</p>
<h3 id="references">References</h3>
<ul>
<li><a href="https://craftinginterpreters.com/contents.html">Crafting Interpreters</a>
<ul>
<li>Chapters 4,5,6</li>
</ul>
</li>
</ul> </div> <!-- Tags Section --> <div class="mt-12 pt-8 border-t border-zinc-100"> <div class="flex flex-wrap gap-3"> <div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Query </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Parser </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Rust </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Recursive Descent </div> </div> </div> <!-- Related Essays --> <div class="mt-12 pt-8 border-t border-zinc-100"> <h2 class="text-2xl font-bold font-sans mb-6 text-black">
More from Tech Lessons
</h2> <div class="grid gap-6 md:grid-cols-2"> <a href="/en/blog/diving_into_rust/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Diving into Rust by building an assertions crate </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2024-01-24T00:00:00.000Z" class="text-zinc-400"> Jan 24, 2024 </time> </div> </a><a href="/en/blog/designing_lfu_cache/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Designing an in-memory LFU cache </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2023-05-26T00:00:00.000Z" class="text-zinc-400"> May 26, 2023 </time> </div> </a> </div> </div> <!-- Giscus Comments --> <div class="mt-16 pt-8 border-t border-zinc-100"> <script src="https://giscus.app/client.js" data-repo="SarthakMakhija/tech-lessons-comments" data-repo-id="R_kgDOJHu3mA" data-category="Announcements" data-category-id="DIC_kwDOJHu3mM4CUxhS" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script> </div> </div> <!-- Sidebar TOC (Desktop Only) --> <aside class="hidden lg:block sticky top-24 pt-8 max-h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar"> <div class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 font-sans">
On this page
</div> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#the-parsers-boundary-syntax-vs-semantics" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Parser’s Boundary: Syntax vs. Semantics </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#parser-errors-when-syntax-fails" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Parser Errors: When Syntax Fails </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#mapping-grammar-to-code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Mapping Grammar to Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-engine-under-the-hood-the-tokencursor" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Engine Under the Hood: The TokenCursor </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#handling-optionality-maybe-vs-expect" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Handling Optionality: Maybe vs. Expect </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#deconstructing-parse_select" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Deconstructing parse_select </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#the-sentinel-why-eof-matters" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Sentinel: Why EOF Matters </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </aside> </div> </article>  </main> <footer class="border-t border-slate-800 bg-slate-900 py-8 text-center text-sm text-zinc-500"> <div class="container mx-auto px-4">
tech-lessons.in &copy; 2020 / Powered by <a href="https://astro.build" target="_blank" class="hover:text-zinc-300 transition-colors">Astro</a> </div> </footer> </div> <!-- Subtle gradient glow at the bottom/edges (optional, keeping it really subtle) --> <div class="fixed inset-0 pointer-events-none z-[-1] bg-[radial-gradient(circle_at_50%_120%,rgba(120,119,198,0.1),rgba(255,255,255,0))]"></div> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.Ci7t3JeA.js"></script> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(t=>{const e=document.createElement("button");e.className="copy-code-button",e.innerHTML=`
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
							<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
						</svg>
					`,e.ariaLabel="Copy code";const r=document.createElement("div");r.className="code-block-wrapper relative group",t.parentNode&&(t.parentNode.insertBefore(r,t),r.appendChild(t),r.appendChild(e)),e.addEventListener("click",async()=>{const o=t.querySelector("code")?.innerText||t.innerText;try{await navigator.clipboard.writeText(o),e.innerHTML=`
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
							`,setTimeout(()=>{e.innerHTML=`
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								`},2e3)}catch(n){console.error("Failed to copy:",n)}})})});</script>  </body> </html>