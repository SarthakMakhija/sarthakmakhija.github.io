<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.16.11"><!-- Canonical URL --><link rel="canonical" href="https://tech-lessons.in/en/blog/inside_a_query_engine_expressions_and_precedence/"><!-- Primary Meta Tags --><title>Inside a Query Engine (Part 4): Expressions and Precedence</title><meta name="title" content="Inside a Query Engine (Part 4): Expressions and Precedence"><meta name="description" content="Inside a Query Engine (Part 4): Expressions and Precedence"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tech-lessons.in/en/blog/inside_a_query_engine_expressions_and_precedence/"><meta property="og:title" content="Inside a Query Engine (Part 4): Expressions and Precedence"><meta property="og:description" content="Inside a Query Engine (Part 4): Expressions and Precedence"><meta property="og:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tech-lessons.in/en/blog/inside_a_query_engine_expressions_and_precedence/"><meta property="twitter:title" content="Inside a Query Engine (Part 4): Expressions and Precedence"><meta property="twitter:description" content="Inside a Query Engine (Part 4): Expressions and Precedence"><meta property="twitter:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script><script>
	window.dataLayer = window.dataLayer || [];
	function gtag() {
		dataLayer.push(arguments);
	}
	gtag("js", new Date());

	gtag("config", "G-9KKTKFQ2CM");
</script><link rel="stylesheet" href="/_astro/about.Dq19AYy-.css"></head> <body class="bg-white text-zinc-900 min-h-screen flex flex-col md:flex-row selection:bg-black selection:text-white"> <header class="md:hidden sticky top-0 z-50 bg-slate-900 border-b border-slate-800 text-white"> <div class="flex items-center justify-between px-6 py-4"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="mobile-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Toggle menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="3" y1="12" x2="21" y2="12"></line> <line x1="3" y1="6" x2="21" y2="6"></line> <line x1="3" y1="18" x2="21" y2="18"></line> </svg> </button> </div> <!-- Mobile Menu Overlay --> <div id="mobile-menu" class="fixed inset-0 bg-slate-900 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-screen overflow-y-auto"> <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Close menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <nav class="flex flex-col p-6 gap-2"> <a href="/" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <div class="mt-auto p-6 border-t border-slate-800"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3 block mb-4">Contact</span> <div class="flex flex-col gap-2"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </div> </header> <script type="module">const t=document.getElementById("mobile-menu-btn"),n=document.getElementById("close-menu-btn"),e=document.getElementById("mobile-menu");t&&n&&e&&(t.addEventListener("click",()=>{e.classList.remove("translate-x-full")}),n.addEventListener("click",()=>{e.classList.add("translate-x-full")}),e.querySelectorAll("a").forEach(l=>{l.addEventListener("click",()=>{e.classList.add("translate-x-full")})}));</script> <aside class="hidden md:flex flex-col w-[280px] h-screen sticky top-0 border-r border-slate-800 bg-slate-900 p-8 shrink-0"> <!-- Profile --> <div class="flex flex-col items-start mb-12"> <div class="w-16 h-16 rounded-full border-2 border-slate-700 shadow-sm overflow-hidden mb-4 relative bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <h2 class="font-bold text-lg text-white leading-tight">
Sarthak Makhija
</h2> <span class="text-sm text-zinc-400">Databases & Storage Systems</span> </div> <!-- Navigation --> <nav class="flex-1 flex flex-col gap-1"> <a href="/" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <line x1="12" y1="20" x2="12" y2="10"></line> <line x1="18" y1="20" x2="18" y2="4"></line> <line x1="6" y1="20" x2="6" y2="16"></line> </svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <!-- Socials --> <div class="mt-auto pt-8 border-t border-slate-800 flex flex-col gap-4"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3">Contact</span> <div class="flex flex-col gap-1"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </aside> <div class="flex-1 flex flex-col min-w-0"> <main class="flex-1 max-w-[1280px] mx-auto px-6 py-12 md:py-20 w-full">  <article class="max-w-[1280px] mx-auto min-w-0"> <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12 items-start"> <div class="min-w-0"> <!-- Article Header --> <header class="mb-12"> <h1 class="text-[40px] md:text-[48px] font-sans font-extrabold text-black leading-[1.2] mb-6 tracking-tight"> Inside a Query Engine (Part 4): Expressions and Precedence </h1> <div class="flex items-center gap-4 text-[16px] text-zinc-500 mb-8 border-b border-zinc-100 pb-8"> <time datetime="2026-02-23T00:00:00.000Z" class="text-zinc-400"> Feb 23, 2026 </time> <span>/</span> <span>Query, Expressions, Precedence, Parsing, AST</span> </div>  </header> <!-- Table of Contents (Mobile Only) --> <div class="lg:hidden bg-gray-50 rounded-lg p-6 mb-12 border border-zinc-100"> <h2 class="text-black font-bold font-sans text-[16px] uppercase tracking-wide mb-4">
Table of contents
</h2> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#why-and-and-or-are-complicated" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Why AND and OR are Complicated </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#the-building-blocks-a-simple-starting-point" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Building Blocks: A Simple Starting Point </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#understanding-the-baseline-parser" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Baseline Parser </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#step-1-adding-and" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 1: Adding AND </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#overview-of-the-code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Overview of the code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#step-2-introducing-or-and-precedence" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 2: Introducing OR and Precedence </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#how-to-think-about-precedence" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> How to Think About Precedence </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#walkthrough-the-precedence-ladder" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Walkthrough: The Precedence Ladder </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#deriving-the-recursive-ast" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Deriving the Recursive AST </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#step-1-the-and-component" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 1: The AND Component </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#step-2-the-or-component" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 2: The OR Component </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#step-3-the-substitution" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 3: The Substitution </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-breakthrough-why-recursion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Breakthrough: Why Recursion? </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#step-3-adding-parentheses" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 3: Adding Parentheses </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-challenge-the-unit-mismatch" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Challenge: The Unit Mismatch </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#a-failed-attempt-the-naive-fix" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> A Failed Attempt: The Naive Fix </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-breakthrough-defining-a-primary-unit" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Breakthrough: Defining a “Primary” Unit </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-recursive-magic" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Recursive Magic </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#from-grammar-to-code-the-implementation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> From Grammar to Code: The Implementation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#how-to-think-about-this-code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> How to Think About This Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </div> <!-- Article Content --> <div class="prose prose-lg max-w-none text-black
            [&_h1]:font-serif [&_h1]:font-bold [&_h1]:text-black [&_h1]:text-[36px] [&_h1]:mt-10 [&_h1]:mb-4
            [&_h2]:font-serif [&_h2]:font-bold [&_h2]:text-black [&_h2]:text-[30px] [&_h2]:mt-10 [&_h2]:mb-6
            [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-black [&_h3]:text-[24px] [&_h3]:mt-10 [&_h3]:mb-4
            [&_h4]:font-sans [&_h4]:font-bold [&_h4]:text-black [&_h4]:text-[18px] [&_h4]:mt-8 [&_h4]:mb-4
            [&_p]:font-sans [&_p]:text-[1.125rem] [&_p]:leading-[1.7777778] [&_p]:text-zinc-800 [&_p]:my-[1em]
            [&_a]:underline [&_a]:decoration-zinc-400 [&_a]:transition-all
            
            /* Table Styling */
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:border [&_table]:border-zinc-200 [&_table]:rounded-lg [&_table]:overflow-hidden
            [&_th]:text-left [&_th]:p-3 [&_th]:border-b [&_th]:border-zinc-200 [&_th]:bg-zinc-50 [&_th]:font-semibold [&_th]:text-zinc-900
            [&_td]:p-3 [&_td]:border-b [&_td]:border-zinc-200 [&_td]:text-zinc-700
            [&_tr:last-child_td]:border-0
            
            [&_li]:text-[1.125rem] [&_li]:leading-[1.7777778] [&_li]:text-zinc-800 [&_li]:mb-2
            [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-6
            [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-6
            [&_img]:rounded-md [&_img]:shadow-lg [&_img]:my-8
            [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-zinc-500 [&_figcaption]:italic [&_figcaption]:mt-[-20px] [&_figcaption]:mb-8
            [&_blockquote]:relative [&_blockquote]:bg-zinc-100 [&_blockquote]:text-zinc-700 [&_blockquote]:p-8 [&_blockquote]:rounded-2xl [&_blockquote]:my-10 [&_blockquote]:not-italic [&_blockquote]:text-[1.1rem] [&_blockquote]:leading-relaxed [&_blockquote]:ml-24
            [&_blockquote::before]:content-[''] [&_blockquote::before]:absolute [&_blockquote::before]:top-8 [&_blockquote::before]:-left-3 [&_blockquote::before]:border-t-[12px] [&_blockquote::before]:border-t-transparent [&_blockquote::before]:border-b-[12px] [&_blockquote::before]:border-b-transparent [&_blockquote::before]:border-r-[16px] [&_blockquote::before]:border-r-zinc-100
            [&_blockquote::after]:content-[''] [&_blockquote::after]:absolute [&_blockquote::after]:-left-32 [&_blockquote::after]:-top-2 [&_blockquote::after]:w-28 [&_blockquote::after]:h-28 [&_blockquote::after]:bg-[url('/avatar.png')] [&_blockquote::after]:bg-contain [&_blockquote::after]:bg-no-repeat [&_blockquote::after]:bg-center [&_blockquote::after]:rounded-full [&_blockquote::after]:border-4 [&_blockquote::after]:border-white [&_blockquote::after]:shadow-md
            [&_pre]:p-6 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:my-8
            [&_code]:font-mono [&_code]:text-[14px] [&_code]:leading-relaxed"> <p>In the previous parts of this series, we built a <a href="/en/blog/inside_a_query_engine_handwritten_parser/">Handwritten Parser</a> capable of understanding basic <code>SELECT</code> statements. But real-world queries are rarely that simple. Users want to filter data using complex logic: <code>WHERE (age > 25 OR salary > 50000) AND status = 'active'</code>.</p>
<p>Supporting this requires us to tackle the most challenging part of parsing: <strong>Expressions, Precedence, and Parentheses</strong>.</p>
<h3 id="why-and-and-or-are-complicated">Why AND and OR are Complicated</h3>
<p>At first glance, adding <code>AND</code> and <code>OR</code> seems like just adding more keywords. However, they introduce the problem of <strong>precedence</strong>. Just like in math, where <code>2 + 3 * 4</code> is <code>14</code> (not <code>20</code>), in SQL, <code>AND</code> usually has higher precedence than <code>OR</code>.</p>
<p>If we don’t encode this precedence into our grammar, the parser won’t know whether <code>A OR B AND C</code> means <code>(A OR B) AND C</code> or <code>A OR (B AND C)</code>.</p>
<h3 id="the-building-blocks-a-simple-starting-point">The Building Blocks: A Simple Starting Point</h3>
<p>Before we dive into expressions, let’s look at the basic grammar for a <code>SELECT</code> query. This is our foundation:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>select</span></span>
<span class="line"><span>    = "SELECT" projection "FROM" identifier [where] [";"] ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>projection</span></span>
<span class="line"><span>    = "*"</span></span>
<span class="line"><span>    | identifier ("," identifier)* ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>where</span></span>
<span class="line"><span>    = "WHERE" clause ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>clause</span></span>
<span class="line"><span>    = identifier operator literal ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>operator</span></span>
<span class="line"><span>    = "=" | ">" | "&#x3C;" | ">=" | "&#x3C;=" | "!=" ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>identifier</span></span>
<span class="line"><span>    = IDENTIFIER ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>literal</span></span>
<span class="line"><span>    = LITERAL ;</span></span></code></pre>
<p>In this version, the <code>WHERE</code> clause is extremely limited. It only supports a single comparison (e.g., <code>id = 1</code>).</p>
<p>Here is how the implementation looks:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> parse_select</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Ast</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#79B8FF">    self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"select"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> projection </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_projection</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">    self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"from"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> table_name </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_identifier</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> where_clause </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">maybe_where_clause</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> order_by </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">maybe_order_by</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> limit </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">maybe_limit</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> _ </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">eat_if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">token</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_semicolon</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Ast</span><span style="color:#F97583">::</span><span style="color:#B392F0">Select</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        table_name</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> table_name</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">        projection,</span></span>
<span class="line"><span style="color:#E1E4E8">        where_clause,</span></span>
<span class="line"><span style="color:#E1E4E8">        order_by,</span></span>
<span class="line"><span style="color:#E1E4E8">        limit,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> maybe_where_clause</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WhereClause</span><span style="color:#E1E4E8">>, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> is_where_clause </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">eat_if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">token</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"where"</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> is_where_clause {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> where_clause </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_clause</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(where_clause));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">None</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> expect_clause</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WhereClause</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> column_name </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_identifier</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> operator </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_operator</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> literal </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_literal</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">WhereClause</span><span style="color:#F97583">::</span><span style="color:#B392F0">Comparison</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        column_name,</span></span>
<span class="line"><span style="color:#E1E4E8">        operator,</span></span>
<span class="line"><span style="color:#E1E4E8">        literal,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> expect_operator</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Operator</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    match</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">        Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Operator</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_token</span><span style="color:#E1E4E8">(token),</span></span>
<span class="line"><span style="color:#B392F0">        None</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedEndOfInput</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> expect_literal</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Literal</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    match</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">cursor</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">        Some</span><span style="color:#E1E4E8">(token) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Literal</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_token</span><span style="color:#E1E4E8">(token),</span></span>
<span class="line"><span style="color:#B392F0">        None</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> Err</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">ParseError</span><span style="color:#F97583">::</span><span style="color:#B392F0">UnexpectedEndOfInput</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h4 id="understanding-the-baseline-parser">Understanding the Baseline Parser</h4>
<p>This code reflects a direct translation of our simple grammar. Each function, like <code>expect_projection</code> or <code>expect_keyword</code>, corresponds to a specific rule.</p>
<p>At this stage:</p>
<ul>
<li><strong><code>parse_select</code></strong> acts as the orchestrator, calling sub-parsers in the exact sequence expected by the SQL syntax.</li>
<li><strong><code>maybe_where_clause</code></strong> shows the “Maybe” pattern, it checks for the <code>WHERE</code> keyword and, if missing, returns <code>Ok(None)</code> instead of erroring.</li>
<li><strong><code>expect_clause</code></strong> is completely linear. It expects exactly one identifier, one operator, and one literal. There is no concept of nesting or grouping yet.</li>
</ul>
<p>The code for the complete parser corresponding to the above grammar is <a href="https://github.com/SarthakMakhija/relop/commit/57c1b6424d8cdc32c61bc7b41d53d1fb8fd272dc">here</a>. (Note: This was the <code>Parser</code> during the early stages of development.)</p>
<h3 id="step-1-adding-and">Step 1: Adding AND</h3>
<p>Let’s expand the <code>WHERE</code> clause to support multiple conditions joined by <code>AND</code>. Surprisingly, the grammar remains relatively simple and linear:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>where</span></span>
<span class="line"><span>    = "WHERE" clause ("AND" clause)*</span></span>
<span class="line"><span></span></span>
<span class="line"><span>clause</span></span>
<span class="line"><span>    = identifier operator literal</span></span>
<span class="line"><span></span></span>
<span class="line"><span>operator</span></span>
<span class="line"><span>    = "=" | ">" | "&#x3C;" | ">=" | "&#x3C;=" | "!=" | "LIKE"</span></span></code></pre>
<p>Here, <code>WHERE</code> starts with one <code>clause</code>, followed by any number (zero or more) of <code>"AND" clause</code> pairs. This works well for a flat list of conditions, but it doesn’t allow for grouping or alternative logic.</p>
<h4 id="overview-of-the-code">Overview of the code</h4>
<p>At this stage, the parser handles <code>AND</code> logic using a simple “collect” loop. It first expects a single condition and then iteratively looks for more <code>AND &#x3C;condition></code> pairs.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> maybe_where_clause</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WhereClause</span><span style="color:#E1E4E8">>, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> is_where_clause </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">eat_if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">token</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"where"</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> is_where_clause {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> conditions </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_conditions</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> conditions</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">WhereClause</span><span style="color:#F97583">::</span><span style="color:#B392F0">Single</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">                conditions</span><span style="color:#F97583">.</span><span style="color:#B392F0">into_iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            )))</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">WhereClause</span><span style="color:#F97583">::</span><span style="color:#B392F0">And</span><span style="color:#E1E4E8">(conditions)))</span></span>
<span class="line"><span style="color:#E1E4E8">        };</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">None</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> expect_conditions</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Condition</span><span style="color:#E1E4E8">>, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> condition </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_condition</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> conditions </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Vec</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    conditions</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(condition);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    while</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">eat_if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">token</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">matches</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">TokenType</span><span style="color:#F97583">::</span><span style="color:#B392F0">Keyword</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"and"</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> condition </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_condition</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        conditions</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(condition);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(conditions)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> expect_condition</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Condition</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> column_name </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_identifier</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> operator </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_operator</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> literal </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_literal</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    match</span><span style="color:#E1E4E8"> operator {</span></span>
<span class="line"><span style="color:#B392F0">        BinaryOperator</span><span style="color:#F97583">::</span><span style="color:#B392F0">Like</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Condition</span><span style="color:#F97583">::</span><span style="color:#B392F0">like</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">column_name, literal)),</span></span>
<span class="line"><span style="color:#E1E4E8">        _ </span><span style="color:#F97583">=></span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Condition</span><span style="color:#F97583">::</span><span style="color:#B392F0">comparison</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">column_name, operator, literal)),</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>In our Rust AST, we model this using a specialized enum:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">enum</span><span style="color:#B392F0"> WhereClause</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    Single</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Condition</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    And</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Condition</span><span style="color:#E1E4E8">>),</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">enum</span><span style="color:#B392F0"> Condition</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    Comparison</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        column_name</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        operator</span><span style="color:#F97583">:</span><span style="color:#B392F0"> BinaryOperator</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        literal</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Literal</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#B392F0">    Like</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        column_name</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        literal</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Literal</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Introduction of <code>AND</code> was all about iteratively looking for more <code>AND</code> clauses.</p>
<h3 id="step-2-introducing-or-and-precedence">Step 2: Introducing OR and Precedence</h3>
<p>When we add <code>OR</code>, things get interesting. If we were to naively define <code>WHERE</code> as:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>(* BAD GRAMMAR *)</span></span>
<span class="line"><span>where = clause (("AND" | "OR") clause)*</span></span></code></pre>
<p>We’ve created an <strong>ambiguous</strong> grammar. This grammar doesn’t tell the parser which operation to perform first. In a recursive descent parser, we solve this by <strong>tiering</strong> our rules.</p>
<h4 id="how-to-think-about-precedence">How to Think About Precedence</h4>
<p>The rule is simple: <strong>The rule representing the lower-precedence operator delegates to the rule representing the higher-precedence operator.</strong></p>
<ol>
<li><strong>Expression (OR)</strong>: The entry point for logic. It handles <code>OR</code> operations and calls <code>and_expression</code>.</li>
<li><strong>And Expression</strong>: Handles <code>AND</code> operations.</li>
<li><strong>Clause</strong>: The actual comparison (<code>id = 1</code>).</li>
</ol>
<p>Here is the grammar that correctly encodes that <code>AND > OR</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>where</span></span>
<span class="line"><span>    = "WHERE" expression ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(* Encodes precedence (AND > OR) *)</span></span>
<span class="line"><span>expression</span></span>
<span class="line"><span>    = or_expression ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>or_expression</span></span>
<span class="line"><span>    = and_expression ("OR" and_expression)* ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>and_expression</span></span>
<span class="line"><span>    = clause ("AND" clause)* ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>clause</span></span>
<span class="line"><span>    = identifier operator literal</span></span></code></pre>
<p>By structuring it this way, the parser is forced to “group” <code>AND</code> operations together before it even considers an <code>OR</code>. This naturally produces an AST that respects the correct order of operations.</p>
<h4 id="walkthrough-the-precedence-ladder">Walkthrough: The Precedence Ladder</h4>
<p>How does this grammar handle <code>name = 'relop' OR language = 'rust' AND type = 'query-parsing'</code>? Instead of a flat list, let’s look at how the recursion “scoops up” tokens based on the precedence rules:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="text"><code><span class="line"><span>QUERY: name = 'relop' OR language = 'rust' AND type = 'query-parsing'</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. expect_or_expression (ENTRY POINT)</span></span>
<span class="line"><span>   └── calls expect_and_expression (Left Side)</span></span>
<span class="line"><span>       └── matches "name = 'relop'" </span></span>
<span class="line"><span>       └── does not see "AND", goes up</span></span>
<span class="line"><span>   </span></span>
<span class="line"><span>2. expect_or_expression sees the "OR" keyword</span></span>
<span class="line"><span>   └── calls expect_and_expression (Right Side)</span></span>
<span class="line"><span>       ├── matches "language = 'rust'"</span></span>
<span class="line"><span>       ├── sees "AND" keyword (HIGHER PRECEDENCE!)</span></span>
<span class="line"><span>       └── matches "type = 'query-parsing'"</span></span>
<span class="line"><span>       └── Result: AND_NODE(lang='rust', type='parsing')</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. expect_or_expression combines them:</span></span>
<span class="line"><span>   └── FINAL AST: OR_NODE(</span></span>
<span class="line"><span>                    SINGLE(name='relop'), </span></span>
<span class="line"><span>                    AND_NODE(lang='rust', type='parsing')</span></span>
<span class="line"><span>                  )</span></span></code></pre>
<p>The hierarchy forces the <code>AND</code> to finish its work (grouping the neighbor on the right) before the <code>OR</code> even gets a chance to see the tokens. This is how the parser “knows” to bind <code>AND</code> more tightly.</p>
<h3 id="deriving-the-recursive-ast">Deriving the Recursive AST</h3>
<p>How do we model this hierarchy in our AST? Let’s try to derive the structure by thinking through a complex query: <code>name = 'relop' AND language = 'rust' OR status = 'active'</code></p>
<h4 id="step-1-the-and-component">Step 1: The AND Component</h4>
<p>First, we group the high-precedence <code>AND</code> conditions. This looks like a single logical unit:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="text"><code><span class="line"><span>AND (</span></span>
<span class="line"><span>    name = 'relop',</span></span>
<span class="line"><span>    language = 'rust'</span></span>
<span class="line"><span>)</span></span></code></pre>
<h4 id="step-2-the-or-component">Step 2: The OR Component</h4>
<p>Next, we think about the <code>OR</code> operation. It joins our previous <code>AND</code> group with another condition:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="text"><code><span class="line"><span>OR (</span></span>
<span class="line"><span>    [The AND group from above],</span></span>
<span class="line"><span>    status = 'active'</span></span>
<span class="line"><span>)</span></span></code></pre>
<h4 id="step-3-the-substitution">Step 3: The Substitution</h4>
<p>When we substitute the <code>AND</code> group back into the <code>OR</code> group, we see the true structure:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="text"><code><span class="line"><span>OR (</span></span>
<span class="line"><span>    AND (</span></span>
<span class="line"><span>        name = 'relop',</span></span>
<span class="line"><span>        language = 'rust'</span></span>
<span class="line"><span>    ),</span></span>
<span class="line"><span>    status = 'active'</span></span>
<span class="line"><span>)</span></span></code></pre>
<h4 id="the-breakthrough-why-recursion">The Breakthrough: Why Recursion?</h4>
<p>This substitution shows us that an <code>OR</code> node must be able to hold an <code>AND</code> node. But if we introduce parentheses, like <code>(A OR B) AND C</code>, then an <code>AND</code> node would need to hold an <code>OR</code> node!</p>
<p>This “circular” requirement, where <code>AND</code> can contain <code>OR</code>, and <code>OR</code> can contain <code>AND</code>, tells us that we cannot use fixed types like <code>Vec&#x3C;Condition></code>. Both must instead hold a unified, <strong>Recursive Expression</strong>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> WhereClause</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">enum</span><span style="color:#B392F0"> Expression</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    /// A base comparison (e.g., id = 1)</span></span>
<span class="line"><span style="color:#B392F0">    Single</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Clause</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#6A737D">    /// A group of expressions joined by AND</span></span>
<span class="line"><span style="color:#B392F0">    And</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">>),</span></span>
<span class="line"><span style="color:#6A737D">    /// A group of expressions joined by OR</span></span>
<span class="line"><span style="color:#B392F0">    Or</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">>),</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This recursive structure allows arbitrary nesting depth. An <code>And</code> node can now hold a <code>Single(A)</code> and an <code>Or</code> node, which in turn holds <code>Single(B)</code> and <code>Single(C)</code>.</p>
<p>For example:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>name = 'relop' OR language = 'rust' AND type = 'query-parsing'</span></span></code></pre>
<p>Produces the following tree:</p>
<div class="mermaid">graph TD
    OR["OR"]
    Name["name = 'relop'"]
    AND["AND"]
    Lang["language = 'rust'"]
    Type["type = 'query-parsing'"]

    OR --> Name
    OR --> AND
    AND --> Lang
    AND --> Type</div>
<p>Notice how the recursive structure naturally reflects precedence: the <code>AND</code> expression is constructed first and then becomes a child of the <code>OR</code>.</p>
<h3 id="step-3-adding-parentheses">Step 3: Adding Parentheses</h3>
<p>Precedence rules provide a “default” behavior, but users need a way to override them. They need parentheses. Let’s try to derive how to support <code>(language = 'rust' OR language = 'go') AND status = 'active'</code> step-by-step:</p>
<h4 id="the-challenge-the-unit-mismatch">The Challenge: The Unit Mismatch</h4>
<p>Our current <code>and_expression</code> expects to join simple <strong>clauses</strong>: <code>and_expression = clause ("AND" clause)*</code></p>
<p>But in <code>(A OR B) AND C</code>, the left side of the <code>AND</code> is not a clause, it is an entire <strong>expression</strong> nested inside brackets.</p>
<h4 id="a-failed-attempt-the-naive-fix">A Failed Attempt: The Naive Fix</h4>
<p>What if we just allowed optional brackets around a clause?</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>(* WRONG *)</span></span>
<span class="line"><span>and_expression = (clause | "(" clause ")") ("AND" (clause | "(" clause ")"))*</span></span></code></pre>
<p>This fails immediately. It only allows us to wrap a <em>single</em> comparison (like <code>(id=1)</code>). It wouldn’t allow <code>(A OR B)</code> because an <code>OR</code> operation is not a <code>clause</code>.</p>
<h4 id="the-breakthrough-defining-a-primary-unit">The Breakthrough: Defining a “Primary” Unit</h4>
<p>We need a unit that can stand on its own as the base of an <code>AND</code> operation. This unit must be flexible enough to be “either a simple comparison OR a portal back to the start.”</p>
<p>We call this the <strong>Primary Expression</strong>:</p>
<ol>
<li><strong>If it’s a simple comparison</strong>, match a <code>clause</code>.</li>
<li><strong>If it starts with <code>(</code></strong>, match a full <code>expression</code> and then expect a <code>)</code>.</li>
</ol>
<p>This leads us to the final, tiered grammar:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>expression</span></span>
<span class="line"><span>    = or_expression ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>or_expression</span></span>
<span class="line"><span>    = and_expression ("OR" and_expression)* ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>and_expression</span></span>
<span class="line"><span>    = primary_expression ("AND" primary_expression)* ;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>primary_expression</span></span>
<span class="line"><span>    = clause</span></span>
<span class="line"><span>    | "(" expression ")" ;</span></span></code></pre>
<h4 id="the-recursive-magic">The Recursive Magic</h4>
<p>Notice the <strong>recursive loop</strong>: <code>expression</code> -> <code>or_expression</code> -> <code>and_expression</code> -> <code>primary_expression</code> -> <code>expression</code>.</p>
<p>When the parser is deep inside the precedence ladder and sees a <code>(</code>, it uses <code>primary_expression</code> to “reset” the logic. It jumps back to the very top, evaluates the grouped expression, and then returns to where it left off.</p>
<h3 id="from-grammar-to-code-the-implementation">From Grammar to Code: The Implementation</h3>
<p>In <a href="https://github.com/SarthakMakhija/relop/blob/main/src/query/parser/mod.rs#L233">Relop</a>, the implementation of this recursive logic is surprisingly clean. The updated AST for <code>SELECT</code> is:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">enum</span><span style="color:#B392F0"> Ast</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    /// Represents a `SELECT` statement.</span></span>
<span class="line"><span style="color:#B392F0">    Select</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">        /// The source to select from (table or join).</span></span>
<span class="line"><span style="color:#E1E4E8">        source</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TableSource</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6A737D">        /// The projection (columns or all) to select.</span></span>
<span class="line"><span style="color:#E1E4E8">        projection</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Projection</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6A737D">        /// The WHERE filter criteria.</span></span>
<span class="line"><span style="color:#E1E4E8">        where_clause</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WhereClause</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#6A737D">        /// The ORDER BY clause, defining the columns and directions used to order rows.</span></span>
<span class="line"><span style="color:#E1E4E8">        order_by</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">OrderingKey</span><span style="color:#E1E4E8">>>,</span></span>
<span class="line"><span style="color:#6A737D">        /// The LIMIT (max records) to return.</span></span>
<span class="line"><span style="color:#E1E4E8">        limit</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">usize</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">enum</span><span style="color:#B392F0"> TableSource</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    Table</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        name</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        alias</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#F97583">    ...</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/// `WhereClause` represents the filtering criteria in a SELECT statement.</span></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">struct</span><span style="color:#B392F0"> WhereClause</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Eq</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PartialEq</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">crate</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">enum</span><span style="color:#B392F0"> Expression</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    Single</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Clause</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    And</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">>),</span></span>
<span class="line"><span style="color:#B392F0">    Or</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">>),</span></span>
<span class="line"><span style="color:#B392F0">    Grouped</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">>),</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Here is a deconstructed look at how the parser handles expressions:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#B392F0"> Parser</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> expect_expression</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_or_expression</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> expect_or_expression</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> expr </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_and_expression</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> expressions </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[expr];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        while</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">eat_if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">token</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"or"</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#E1E4E8">            expressions</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_and_expression</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> expressions</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() > </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">or</span><span style="color:#E1E4E8">(expressions))</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(expressions</span><span style="color:#F97583">.</span><span style="color:#B392F0">into_iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> expect_and_expression</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> expr </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_primary_expression</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> expressions </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[expr];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        while</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">eat_if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">token</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_keyword</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"and"</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#E1E4E8">            expressions</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_primary_expression</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> expressions</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() > </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">and</span><span style="color:#E1E4E8">(expressions))</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(expressions</span><span style="color:#F97583">.</span><span style="color:#B392F0">into_iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> expect_primary_expression</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">ParseError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">eat_if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">token</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> token</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_left_parentheses</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> expr </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0" class="highlighted-word">expect_expression</span><span style="color:#E1E4E8" class="highlighted-word">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">; </span></span>
<span class="line"><span style="color:#79B8FF">            self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_right_parentheses</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">grouped</span><span style="color:#E1E4E8">(expr))</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">single</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect_clause</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="how-to-think-about-this-code">How to Think About This Code</h3>
<p>Let’s break down the transformation from grammar to code step-by-step:</p>
<ol>
<li><strong>Direct Mapping</strong>: Notice how each grammar rule (<code>expression</code>, <code>or_expression</code>, <code>and_expression</code>, <code>primary_expression</code>) has a direct 1-to-1 equivalent in Rust functions.</li>
<li><strong>The Call Hierarchy</strong>: <code>expect_or_expression</code> starts by calling <code>expect_and_expression</code>. This is the core of <strong>implicit precedence</strong>. The parser <em>must</em> satisfy a potential <code>AND</code> branch before it even considers an <code>OR</code>.</li>
<li><strong>The Collection Loop</strong>: Both <code>AND</code> and <code>OR</code> methods use a <code>while</code> loop to collect multiple operands.
<ul>
<li>It starts with one expression.</li>
<li>It looks for the operator keyword.</li>
<li>If found, it calls the <em>next highest tier</em> rule and adds the result to the list.</li>
</ul>
</li>
<li><strong>Tree Simplification</strong>: The <code>if expressions.len() > 1</code> check is a crucial optimization. If only one operand is found (e.g., <code>id=1</code>), we return it directly rather than wrapping it in a redundant <code>Expression::And</code>, <code>Expression::Or</code> node.</li>
<li><strong>The Recursive Reset</strong>: The <code>expect_primary_expression</code> method contains the “magic.” When it sees a <code>(</code>, it calls <code>expect_expression</code> (the top of the ladder). This recursion allows the entire precedence structure to be re-evaluated inside the parentheses.</li>
</ol>
<h3 id="conclusion">Conclusion</h3>
<p>Handling expressions and precedence is often the most intricate part of building a parser. By encoding precedence directly into the grammar rules and leveraging recursion, we can transform complex nested strings into a perfectly structured tree.</p>
<p>With expressions handled, our parser is now powerful enough to represent almost any logical query. In the next part, we will move beyond syntax and explore the <a href="/en/blog/inside_a_query_engine_logical_plan">Logical Plan</a>: how the engine transforms this Abstract Syntax Tree into a series of relational operations.</p>
<h3 id="references">References</h3>
<ul>
<li><a href="https://craftinginterpreters.com/contents.html">Crafting Interpreters</a>
<ul>
<li>Chapters 4,5,6</li>
</ul>
</li>
</ul> </div> <!-- Tags Section --> <div class="mt-12 pt-8 border-t border-zinc-100"> <div class="flex flex-wrap gap-3"> <div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Query </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Expressions </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Precedence </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Parsing </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> AST </div> </div> </div> <!-- Related Essays -->  <!-- Giscus Comments --> <div class="mt-16 pt-8 border-t border-zinc-100"> <script src="https://giscus.app/client.js" data-repo="SarthakMakhija/tech-lessons-comments" data-repo-id="R_kgDOJHu3mA" data-category="Announcements" data-category-id="DIC_kwDOJHu3mM4CUxhS" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script> </div> </div> <!-- Sidebar TOC (Desktop Only) --> <aside class="hidden lg:block sticky top-24 pt-8 max-h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar"> <div class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 font-sans">
On this page
</div> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#why-and-and-or-are-complicated" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Why AND and OR are Complicated </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#the-building-blocks-a-simple-starting-point" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Building Blocks: A Simple Starting Point </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#understanding-the-baseline-parser" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding the Baseline Parser </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#step-1-adding-and" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 1: Adding AND </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#overview-of-the-code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Overview of the code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#step-2-introducing-or-and-precedence" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 2: Introducing OR and Precedence </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#how-to-think-about-precedence" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> How to Think About Precedence </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#walkthrough-the-precedence-ladder" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Walkthrough: The Precedence Ladder </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#deriving-the-recursive-ast" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Deriving the Recursive AST </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#step-1-the-and-component" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 1: The AND Component </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#step-2-the-or-component" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 2: The OR Component </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#step-3-the-substitution" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 3: The Substitution </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-breakthrough-why-recursion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Breakthrough: Why Recursion? </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#step-3-adding-parentheses" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Step 3: Adding Parentheses </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-challenge-the-unit-mismatch" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Challenge: The Unit Mismatch </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#a-failed-attempt-the-naive-fix" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> A Failed Attempt: The Naive Fix </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-breakthrough-defining-a-primary-unit" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Breakthrough: Defining a “Primary” Unit </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-recursive-magic" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The Recursive Magic </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#from-grammar-to-code-the-implementation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> From Grammar to Code: The Implementation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#how-to-think-about-this-code" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> How to Think About This Code </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#conclusion" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Conclusion </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </aside> </div> </article>  </main> <footer class="border-t border-slate-800 bg-slate-900 py-8 text-center text-sm text-zinc-500"> <div class="container mx-auto px-4">
tech-lessons.in &copy; 2020 / Powered by <a href="https://astro.build" target="_blank" class="hover:text-zinc-300 transition-colors">Astro</a> </div> </footer> </div> <!-- Subtle gradient glow at the bottom/edges (optional, keeping it really subtle) --> <div class="fixed inset-0 pointer-events-none z-[-1] bg-[radial-gradient(circle_at_50%_120%,rgba(120,119,198,0.1),rgba(255,255,255,0))]"></div> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.Ci7t3JeA.js"></script> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(t=>{const e=document.createElement("button");e.className="copy-code-button",e.innerHTML=`
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
							<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
						</svg>
					`,e.ariaLabel="Copy code";const r=document.createElement("div");r.className="code-block-wrapper relative group",t.parentNode&&(t.parentNode.insertBefore(r,t),r.appendChild(t),r.appendChild(e)),e.addEventListener("click",async()=>{const o=t.querySelector("code")?.innerText||t.innerText;try{await navigator.clipboard.writeText(o),e.innerHTML=`
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
							`,setTimeout(()=>{e.innerHTML=`
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								`},2e3)}catch(n){console.error("Failed to copy:",n)}})})});</script>  </body> </html>