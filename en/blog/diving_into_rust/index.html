<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.16.11"><!-- Canonical URL --><link rel="canonical" href="https://tech-lessons.in/en/blog/diving_into_rust/"><!-- Primary Meta Tags --><title>Diving into Rust by building an assertions crate</title><meta name="title" content="Diving into Rust by building an assertions crate"><meta name="description" content="Diving into Rust by building an assertions crate"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tech-lessons.in/en/blog/diving_into_rust/"><meta property="og:title" content="Diving into Rust by building an assertions crate"><meta property="og:description" content="Diving into Rust by building an assertions crate"><meta property="og:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tech-lessons.in/en/blog/diving_into_rust/"><meta property="twitter:title" content="Diving into Rust by building an assertions crate"><meta property="twitter:description" content="Diving into Rust by building an assertions crate"><meta property="twitter:image" content="https://tech-lessons.in/blog-placeholder-1.jpg"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-9KKTKFQ2CM"></script><script>
	window.dataLayer = window.dataLayer || [];
	function gtag() {
		dataLayer.push(arguments);
	}
	gtag("js", new Date());

	gtag("config", "G-9KKTKFQ2CM");
</script><link rel="stylesheet" href="/_astro/about.Dq19AYy-.css"></head> <body class="bg-white text-zinc-900 min-h-screen flex flex-col md:flex-row selection:bg-black selection:text-white"> <header class="md:hidden sticky top-0 z-50 bg-slate-900 border-b border-slate-800 text-white"> <div class="flex items-center justify-between px-6 py-4"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="mobile-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Toggle menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="3" y1="12" x2="21" y2="12"></line> <line x1="3" y1="6" x2="21" y2="6"></line> <line x1="3" y1="18" x2="21" y2="18"></line> </svg> </button> </div> <!-- Mobile Menu Overlay --> <div id="mobile-menu" class="fixed inset-0 bg-slate-900 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-screen overflow-y-auto"> <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-full border border-slate-700 overflow-hidden bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <div class="flex flex-col"> <span class="font-bold text-sm leading-none">Sarthak Makhija</span> <span class="text-[10px] text-slate-400 mt-0.5">Databases & Storage Systems</span> </div> </div> <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white" aria-label="Close menu"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <nav class="flex flex-col p-6 gap-2"> <a href="/" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all font-medium text-lg"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <div class="mt-auto p-6 border-t border-slate-800"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3 block mb-4">Contact</span> <div class="flex flex-col gap-2"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </div> </header> <script type="module">const t=document.getElementById("mobile-menu-btn"),n=document.getElementById("close-menu-btn"),e=document.getElementById("mobile-menu");t&&n&&e&&(t.addEventListener("click",()=>{e.classList.remove("translate-x-full")}),n.addEventListener("click",()=>{e.classList.add("translate-x-full")}),e.querySelectorAll("a").forEach(l=>{l.addEventListener("click",()=>{e.classList.add("translate-x-full")})}));</script> <aside class="hidden md:flex flex-col w-[280px] h-screen sticky top-0 border-r border-slate-800 bg-slate-900 p-8 shrink-0"> <!-- Profile --> <div class="flex flex-col items-start mb-12"> <div class="w-16 h-16 rounded-full border-2 border-slate-700 shadow-sm overflow-hidden mb-4 relative bg-slate-800"> <img src="/avatar.png" alt="Sarthak Makhija" class="w-full h-full object-contain"> </div> <h2 class="font-bold text-lg text-white leading-tight">
Sarthak Makhija
</h2> <span class="text-sm text-zinc-400">Databases & Storage Systems</span> </div> <!-- Navigation --> <nav class="flex-1 flex flex-col gap-1"> <a href="/" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
Home
</a> <a href="/en/paper-notes" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path> <polyline points="14 2 14 8 20 8"></polyline> <line x1="16" y1="13" x2="8" y2="13"></line> <line x1="16" y1="17" x2="8" y2="17"></line> <polyline points="10 9 9 9 8 9"></polyline> </svg>
Paper Notes
</a> <a href="/top-essays" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"> <line x1="12" y1="20" x2="12" y2="10"></line> <line x1="18" y1="20" x2="18" y2="4"></line> <line x1="6" y1="20" x2="6" y2="16"></line> </svg>
Top Essays
</a> <a href="/tags" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
Tags
</a> <a href="/projects" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
Projects
</a> <a href="/workshops" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
Workshops
</a> <a href="/about" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-md transition-all group font-medium"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
About Me
</a> </nav> <!-- Socials --> <div class="mt-auto pt-8 border-t border-slate-800 flex flex-col gap-4"> <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider pl-3">Contact</span> <div class="flex flex-col gap-1"> <a href="https://github.com/SarthakMakhija" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2.67-5-2.67"></path></svg>
GitHub
</a> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg>
LinkedIn
</a> <a href="https://x.com/MakhijaSarthak" target="_blank" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white transition-colors text-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-12.7 12.5S.7 7 2.8 5.7c-2 2 .5 5.5.5 5.5s-.8-3-3-3l6-6s-1.3 2.5-1.5 3c-1.3-4 5-6 6-5 2.5 0 5 4 5 4Z"></path></svg>
Twitter
</a> </div> </div> </aside> <div class="flex-1 flex flex-col min-w-0"> <main class="flex-1 max-w-[1280px] mx-auto px-6 py-12 md:py-20 w-full">  <article class="max-w-[1280px] mx-auto min-w-0"> <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12 items-start"> <div class="min-w-0"> <!-- Article Header --> <header class="mb-12"> <h1 class="text-[40px] md:text-[48px] font-sans font-extrabold text-black leading-[1.2] mb-6 tracking-tight"> Diving into Rust by building an assertions crate </h1> <div class="flex items-center gap-4 text-[16px] text-zinc-500 mb-8 border-b border-zinc-100 pb-8"> <time datetime="2024-01-24T00:00:00.000Z" class="text-zinc-400"> Jan 24, 2024 </time> <span>/</span> <span>Rust, Assertions, Elegant-assertions, Clearcheck</span> </div> <div class="w-full mb-12"> <img width="1020" height="510" src="/diving-into-rust.webp" alt="" class="w-full rounded-md shadow-sm"> <p class="text-left text-zinc-500 italic mt-3 text-sm"> Background by Dana Tentis on Pexels </p> </div> </header> <!-- Table of Contents (Mobile Only) --> <div class="lg:hidden bg-gray-50 rounded-lg p-6 mb-12 border border-zinc-100"> <h2 class="text-black font-bold font-sans text-[16px] uppercase tracking-wide mb-4">
Table of contents
</h2> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introduction" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introduction </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-string-str-and-str-types" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding String, &amp;str and str types </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#beginning-with-extension-methods" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Beginning with extension methods </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-asref" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding AsRef </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#leveraging-blanket-trait-implementation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Leveraging blanket trait implementation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introducing-matchers" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introducing Matchers </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#subtle-duplication" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Subtle duplication </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-lack-of-ability-to-compose-assertions" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The lack of ability to compose assertions </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#connecting-assertions-and-matchers---using-blanket-trait-and-trait-object" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Connecting assertions and matchers - using blanket trait and trait object </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#matchers-and-lifetimes" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Matchers and lifetimes </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#matcher-composition--using-trait-objects" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Matcher composition : using trait objects </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </div> <!-- Article Content --> <div class="prose prose-lg max-w-none text-black
            [&_h1]:font-serif [&_h1]:font-bold [&_h1]:text-black [&_h1]:text-[36px] [&_h1]:mt-10 [&_h1]:mb-4
            [&_h2]:font-serif [&_h2]:font-bold [&_h2]:text-black [&_h2]:text-[30px] [&_h2]:mt-10 [&_h2]:mb-6
            [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-black [&_h3]:text-[24px] [&_h3]:mt-10 [&_h3]:mb-4
            [&_h4]:font-sans [&_h4]:font-bold [&_h4]:text-black [&_h4]:text-[18px] [&_h4]:mt-8 [&_h4]:mb-4
            [&_p]:font-sans [&_p]:text-[1.125rem] [&_p]:leading-[1.7777778] [&_p]:text-zinc-800 [&_p]:my-[1em]
            [&_a]:underline [&_a]:decoration-zinc-400 [&_a]:transition-all
            
            /* Table Styling */
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:border [&_table]:border-zinc-200 [&_table]:rounded-lg [&_table]:overflow-hidden
            [&_th]:text-left [&_th]:p-3 [&_th]:border-b [&_th]:border-zinc-200 [&_th]:bg-zinc-50 [&_th]:font-semibold [&_th]:text-zinc-900
            [&_td]:p-3 [&_td]:border-b [&_td]:border-zinc-200 [&_td]:text-zinc-700
            [&_tr:last-child_td]:border-0
            
            [&_li]:text-[1.125rem] [&_li]:leading-[1.7777778] [&_li]:text-zinc-800 [&_li]:mb-2
            [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-6
            [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-6
            [&_img]:rounded-md [&_img]:shadow-lg [&_img]:my-8
            [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-zinc-500 [&_figcaption]:italic [&_figcaption]:mt-[-20px] [&_figcaption]:mb-8
            [&_blockquote]:relative [&_blockquote]:bg-zinc-100 [&_blockquote]:text-zinc-700 [&_blockquote]:p-8 [&_blockquote]:rounded-2xl [&_blockquote]:my-10 [&_blockquote]:not-italic [&_blockquote]:text-[1.1rem] [&_blockquote]:leading-relaxed [&_blockquote]:ml-24
            [&_blockquote::before]:content-[''] [&_blockquote::before]:absolute [&_blockquote::before]:top-8 [&_blockquote::before]:-left-3 [&_blockquote::before]:border-t-[12px] [&_blockquote::before]:border-t-transparent [&_blockquote::before]:border-b-[12px] [&_blockquote::before]:border-b-transparent [&_blockquote::before]:border-r-[16px] [&_blockquote::before]:border-r-zinc-100
            [&_blockquote::after]:content-[''] [&_blockquote::after]:absolute [&_blockquote::after]:-left-32 [&_blockquote::after]:-top-2 [&_blockquote::after]:w-28 [&_blockquote::after]:h-28 [&_blockquote::after]:bg-[url('/avatar.png')] [&_blockquote::after]:bg-contain [&_blockquote::after]:bg-no-repeat [&_blockquote::after]:bg-center [&_blockquote::after]:rounded-full [&_blockquote::after]:border-4 [&_blockquote::after]:border-white [&_blockquote::after]:shadow-md
            [&_pre]:p-6 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:my-8
            [&_code]:font-mono [&_code]:text-[14px] [&_code]:leading-relaxed"> <p>As Rust projects grow in size and complexity, the need for sophisticated error handling tools becomes ever more pressing.
Traditional methods like panics and asserts, while useful, can be limited and cumbersome.</p>
<p>Let’s build an assertions crate that offers elegant and powerful assertions, while simultaneously diving into the diverse landscape of Rust features.</p>
<h3 id="introduction">Introduction</h3>
<p>Let’s define some requirements for our crate. The assertions crate should:</p>
<ol>
<li><strong>Offer Fluent API</strong>: chain assertions for a natural and readable experience.</li>
<li><strong>Have extensive assertions</strong>: variety of assertions covering common validation needs.</li>
<li><strong>Be customizable</strong>: extend with custom assertions for specific domain requirements.</li>
<li><strong>Be type-safe</strong>: leverage Rust’s type system for reliable assertions.</li>
</ol>
<p>Consider this password validation example as a glimpse into the crate’s ability to create meaningful and expressive assertions.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> pass_phrase </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "P@@sw0rd1 zebra alpha"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">pass_phrase</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_not_be_empty</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">should_have_at_least_length</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">should_contain_all_characters</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#9ECBFF">'@'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">' '</span><span style="color:#E1E4E8">])</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">should_contain_a_digit</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">should_not_contain_ignoring_case</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"pass"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">should_not_contain_ignoring_case</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"word"</span><span style="color:#E1E4E8">);</span></span></code></pre>
<h3 id="understanding-string-str-and-str-types">Understanding String, &#x26;str and str types</h3>
<p>It is important to understand various string types in Rust before we get started.</p>
<ul>
<li><strong>String</strong>: is a mutable and resizable buffer holding UTF-8 text. The buffer is allocated on heap. It can be treated as a collection of u8, <code>vec&#x3C;u8></code>.</li>
<li><strong>&#x26;str</strong>: is an immutable reference to a run of UTF-8 text owned by someone else. <mark class="author-highlight"><code>&#x26;str</code> is a fat pointer, it contains both the address of the actual string and its length.</mark></li>
<li><strong>str</strong>: is an immutable sequence of UTF-8 bytes of dynamic length somewhere in memory. It’s size in unknown, which means <mark class="author-highlight"><code>str</code> almost always
appears as <code>&#x26;str</code> in the code.</mark></li>
</ul>
<p>The below code and the visual highlights the types: <code>String</code>, and <code>&#x26;str</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> value</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> String</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"RUST"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> value_ref</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">value[</span><span style="color:#79B8FF">1</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> literal</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "TRUST"</span><span style="color:#E1E4E8">;</span></span></code></pre>
<div class="align-center-exclude-width-change">
    <img src="/string-vs-str.webp" alt="String vs &#x26;str">
    <figcaption class="figcaption">Visual from the book: Programming Rust</figcaption>
</div>
<blockquote>
<p>In Rust, the string literals are of type &#x26;str and the actual literals are allocated on pre-allocated read-only
memory.</p>
</blockquote>
<h3 id="beginning-with-extension-methods">Beginning with extension methods</h3>
<p>The first thing that we need is the ability to invoke custom methods like <code>should_contain_all_characters</code> and <code>should_be_empty</code> on the built-in
types. In the password validation example, we have methods like <code>should_contain_all_characters</code> and <code>should_contain_a_digit</code>
over <code>string</code> (or <code>&#x26;str</code>) types.</p>
<p>Such methods are called “extension” methods and <a href="https://en.wikipedia.org/wiki/Extension_method#:~:text=Extension%20methods%20are%20features%20of,an%20equally%20safe%20manner%2C%20however.">Wikipedia</a> defines extension method as
“a method added to an object after the original object was compiled”. <mark class="author-highlight">In Rust, extension methods are added using traits.</mark></p>
<p>Let’s start by defining a trait.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> trait</span><span style="color:#B392F0"> MembershipAssertion</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_empty</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>MembershipAssertion</code> defines methods: <code>should_contain_a_digit</code>, <code>should_not_contain_a_digit</code> and <code>should_not_be_empty</code>, all of which returns reference to <code>Self</code> to allow chaining.</p>
<p>Let’s implement the trait for a string slice (<code>&#x26;str</code>). <em>(I will only implement should_contain_a_digit at this stage).</em></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#B392F0"> MembershipAssertion</span><span style="color:#F97583"> for</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> contains_a_digit </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">chars</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">any</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">ch</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> ch</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_numeric</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">contains_a_digit {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"assertion failed: {:?} should contain a digit"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Time to add a few tests. <em>(I will only show a couple of tests.).</em></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#F97583"> crate::</span><span style="color:#B392F0">MembershipAssertion</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> password </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "P@@sw0rd1 zebra alpha"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        password</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_contain_a_digit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_empty_and_contain_a_digit</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> password </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "P@@sw0rd1 zebra alpha"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        password</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_not_be_empty</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">                .</span><span style="color:#B392F0">should_contain_a_digit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>It is a decent start, and we can make our first commit.</p>
<p>We have implemented the <code>MembershipAssertion</code> trait for the <code>&#x26;str</code> type. We also need the methods of the <code>MembershipAssertion</code> trait for the <code>String</code> type.</p>
<p>Let’s implement the trait for the <code>String</code> type.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#B392F0"> MembershipAssertion</span><span style="color:#F97583"> for</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> contains_a_digit </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">chars</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">any</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">ch</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> ch</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_numeric</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">contains_a_digit {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"assertion failed: {:?} should contain a digit"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> string_tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#F97583"> crate::</span><span style="color:#B392F0">MembershipAssertion</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> password </span><span style="color:#F97583">=</span><span style="color:#B392F0"> String</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"P@@sw0rd1 zebra alpha"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        password</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_contain_a_digit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_empty_and_contain_a_digit</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> password </span><span style="color:#F97583">=</span><span style="color:#B392F0"> String</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"P@@sw0rd1 zebra alpha"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        password</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_not_be_empty</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_contain_a_digit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We have simply duplicated the method <code>should_contain_a_digit</code> for <code>&#x26;str</code> and <code>String</code> types and verified that duplicated code works for both the types.</p>
<p>Let’s make an attempt to remove the duplication.</p>
<p>We can convert the <code>String</code> type to a <code>string slice -> &#x26;str</code> and invoke the respective methods on <code>&#x26;str</code> type. With this approach, the implementation
of <code>MembershipAssertion</code> on <code>String</code> looks like the following:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#B392F0"> MembershipAssertion</span><span style="color:#F97583"> for</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#79B8FF">self</span><span style="color:#F97583"> as</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_contain_a_digit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_empty</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#79B8FF">self</span><span style="color:#F97583"> as</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_not_be_empty</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This approach removes the duplication, but it is still unnecessary delegation - all the methods in the <code>String</code> implementation delegate
to the respective implementation in the <code>&#x26;str</code> type. This might not look like a huge thing but if we add a few more methods in the <code>MembershipAssertion</code>
trait, the delegation will become obvious. So the question is, can we do better?</p>
<h3 id="understanding-asref">Understanding AsRef</h3>
<p>Let’s revisit our <code>MembershipAssertion</code> trait.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> trait</span><span style="color:#B392F0"> MembershipAssertion</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_empty</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The idea is to provide an implementation of <code>MembershipAssertion</code> for all the types which can be represented as string.</p>
<p>It will be great to implement <code>MembershipAssertion</code> for any generic type <code>T</code>, where <code>T</code> that it can be represented as <code>String</code> (or <code>&#x26;str</code>).
The article explains how generics are processed in Rust <a href="#matcher-composition--using-trait-objects">here</a>.</p>
<p>Let’s give this concept a try.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">MembershipAssertion</span><span style="color:#F97583"> for</span><span style="color:#B392F0"> T</span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> AsRef</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">+</span><span style="color:#B392F0"> Debug</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> contains_a_digit </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">chars</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">any</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">ch</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> ch</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_numeric</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">contains_a_digit {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"assertion failed: {:?} should contain a digit"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We are implementing <code>MembershipAssertion</code> for any <code>T</code> where T implements <a href="https://doc.rust-lang.org/std/convert/trait.AsRef.html">AsRef<str></str></a> and <a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html">Debug</a> trait.</p>
<p>Jim Blandy, Jason Orendorff and Leonora F.S Tindall in the book <a href="https://www.oreilly.com/library/view/programming-rust-2nd/9781492052586/">Programming Rust</a> says: when a type implements <code>AsRef&#x3C;U></code>, it means we can borrow a <code>reference of U</code> from the type.
This means, <mark class="author-highlight">if a type implements <code>AsRef&#x3C;str></code> we can borrow a <code>reference of str</code> from that type.</mark></p>
<p>In Rust, both <code>String</code> and <code>&#x26;str</code> type implements <code>AsRef&#x3C;str></code> which means all the methods of <code>MembershipAssertion</code> are now available on <code>String</code>
and <code>&#x26;str</code>. Please find the reference <a href="https://doc.rust-lang.org/std/convert/trait.AsRef.html#:~:text=Since%20both%20String%20and%20%26str,accept%20both%20as%20input%20argument">here</a>.</p>
<p>We need the <code>T</code> to implement <code>Debug</code> trait because we are formatting it in the <code>panic</code> macro.</p>
<p>Quick revisit:</p>
<ul>
<li>Rust allows implementing a trait for any <code>T</code>. This is called <em>blanket trait implementation</em>. In our case, we are implementing <code>MembershipAssertion</code>
for a constrained <code>T</code>.</li>
<li>The trait <code>AsRef</code> provides a lot of flexibility in the function signature. The method <a href="https://doc.rust-lang.org/std/fs/struct.File.html#method.open">open</a> in
Rust <a href="https://doc.rust-lang.org/std/fs/struct.File.html">File</a> type takes a parameter <code>P</code> of type <code>AsRef&#x3C;Path></code>, which means any <code>P</code> that can be represented as a <a href="https://doc.rust-lang.org/std/path/struct.Path.html">Path</a>
can be passed as an argument.</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#6A737D">// open method from Rust's file type.</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> open</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">P</span><span style="color:#F97583">:</span><span style="color:#B392F0"> AsRef</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Path</span><span style="color:#E1E4E8">>>(path</span><span style="color:#F97583">:</span><span style="color:#B392F0"> P</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">File</span><span style="color:#E1E4E8">> {</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">}</span></span></code></pre>
<p>With the introduction of <code>AsRef&#x3C;str></code> change, we have taken care of the duplication in the implementation of <code>MembershipAssertion</code>, and we can
now remove our original implementation of <code>MembershipAssertion</code> for <code>String</code> and <code>&#x26;str</code> types.</p>
<h3 id="leveraging-blanket-trait-implementation">Leveraging blanket trait implementation</h3>
<p>Rust allows implementing a trait for any generic type <code>T</code>. Consider a trait <code>BoxWrap</code> as shown below:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> trait</span><span style="color:#B392F0"> BoxWrap</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> boxed</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This trait provides <code>boxed</code> method to create a <a href="https://doc.rust-lang.org/std/boxed/struct.Box.html">Box</a> representation of self. <em>Please note
the boxed method takes the ownership of <code>self</code></em>.</p>
<blockquote>
<p>In Rust, <a href="https://doc.rust-lang.org/std/boxed/struct.Box.html">Box</a> is a pointer type that uniquely owns a heap allocation of type T.
<code>Box::new(x: T)</code> allocates memory on heap and then places <code>x</code> into it.</p>
</blockquote>
<p>We can use blanket trait implementation to implement the method <code>boxed</code> over any generic type <code>T</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">BoxWrap</span><span style="color:#F97583"> for</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> boxed</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">        Box</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>That’s it, the method <code>boxed</code> is now available on all the types <code>T</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> value</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "clearcheck"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?}"</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">.</span><span style="color:#B392F0">boxed</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> id</span><span style="color:#F97583">:</span><span style="color:#B392F0"> i32</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 120</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?}"</span><span style="color:#E1E4E8">, id</span><span style="color:#F97583">.</span><span style="color:#B392F0">boxed</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This concept is very useful for our crate. Let’s see how.</p>
<p>Our crate will also offer assertions related to ordered comparisons (greater than, less than, greater than equal to, less than equal to) for various types. Let’s
provide such a trait.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> trait</span><span style="color:#B392F0"> OrderedAssertion</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PartialOrd</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other</span><span style="color:#F97583">:</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other</span><span style="color:#F97583">:</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // other methods</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The trait <code>OrderedAssertion</code> is generic over <code>T: PartialOrd</code>. <a href="https://doc.rust-lang.org/std/cmp/trait.PartialOrd.html">PartialOrd</a> trait allows ordered comparisons (>, &#x3C;, >=, &#x3C;=) between types.</p>
<p>We have an option of implementing <code>OrderedAssertion</code> for various types like <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>&#x26;str</code> etc. or we can implement <code>OrderedAssertion</code>
for a constrained <code>T</code>.</p>
<p>Let’s make an attempt to implement <code>OrderedAssertion</code> for any type <code>T</code> that implements <code>PartialOrd</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">OrderedAssertion</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">for</span><span style="color:#B392F0"> T</span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PartialOrd</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Debug</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other</span><span style="color:#F97583">:</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> self</span><span style="color:#F97583"> &#x3C;=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">other {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should be greater than {:?}"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other</span><span style="color:#F97583">:</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8"> > </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">other {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should not be greater than {:?}"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The methods <code>should_be_greater_than</code> and <code>should_not_be_greater_than</code> are now available on any <code>T</code> that implements <code>PartialOrd</code> trait.</p>
<p>Note, the operators (>=, &#x3C;) translate to a method call <a href="https://doc.rust-lang.org/std/cmp/trait.PartialOrd.html#tymethod.partial_cmp">partial_cmp</a> inside the <code>PartialOrd</code> trait.
The method <code>partial_cmp</code> takes parameters by reference for comparison. Hence, we are doing the comparisons using references <code>(self &#x3C;= &#x26;other)</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> ordering_tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#F97583"> crate::</span><span style="color:#B392F0">OrderedAssertion</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_be_greater_than_other</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> rank </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 12.90</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        rank</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10.23</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_be_greater_than_other_with_string</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "junit"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        name</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"assert"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The advantage of implementing a trait for any <code>T</code> (with or without constraint) is obvious. It removes duplication!!!</p>
<p>Time to revisit the implementation of our assertion.</p>
<h3 id="introducing-matchers">Introducing Matchers</h3>
<p>Let’s take a look at the implementation of <code>OrderedAssertion</code> again.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">OrderedAssertion</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">for</span><span style="color:#B392F0"> T</span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PartialOrd</span><span style="color:#F97583"> +</span><span style="color:#B392F0"> Debug</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other</span><span style="color:#F97583">:</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> self</span><span style="color:#F97583"> &#x3C;=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">other {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should be greater than {:?}"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_be_greater_than</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other</span><span style="color:#F97583">:</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8"> > </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">other {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should not be greater than {:?}"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, other)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>There are two issues with this implementation.</p>
<h4 id="subtle-duplication">Subtle duplication</h4>
<p>There is still subtle duplication between the implementations of <code>should_be_greater_than</code> and <code>should_not_be_greater_than</code>.</p>
<p>Let’s take a closer look to understand the duplication:</p>
<ul>
<li>In comparison: <code>self &#x3C;= &#x26;other</code> and <code>self > &#x26;other</code>, both the methods are doing comparisons which are inverted.</li>
<li>In the panic message: <code>panic!("{:?} should be greater than {:?}", self, other)</code> and <code>panic!("{:?} should not be greater than {:?}", self, other)</code>,
both the methods are causing panic with messages which are inverted.</li>
</ul>
<p>The same form of duplication will be observed between method pairs like:</p>
<ul>
<li><code>should_be_empty</code>, <code>should_not_be_empty</code></li>
<li><code>should_be_greater_than</code>, <code>should_not_be_greater_than</code></li>
<li>etc</li>
</ul>
<p>This duplication is caused because of the change in the condition for examining the data: <em>self must be <strong>less than</strong> other</em>, <em>self must be <strong>greater than</strong> other</em>.</p>
<h4 id="the-lack-of-ability-to-compose-assertions">The lack of ability to compose assertions</h4>
<p><mark class="author-highlight">Assertions are defining the contract, ensuring that each data type (/data structure) adheres to its intended behavior.</mark> They don’t provide us
with an ability to <a href="#matcher-composition--using-trait-objects">compose them</a> using operators like <strong>and</strong>, <strong>or</strong>.</p>
<p>We can deal with both these issues by introducing an abstraction that:</p>
<ul>
<li><strong>Examines the data</strong> and <strong>verifies</strong> that the data conforms to <strong>specific criteria</strong>.</li>
<li><strong>Inverts</strong> its behavior so that we <strong>won’t</strong> be required to write any <strong>additional code</strong> for implementing <strong>negative assertions</strong>.</li>
<li>Allows <strong>composition</strong></li>
</ul>
<p>The question is what would be the name of such an abstraction? In the world of assertions, such an object is called matcher. I asked <a href="https://bard.google.com/chat">bard</a> to define <em>Matcher</em>? It gave me the following definition:</p>
<p><mark class="author-highlight">Matchers provide the granular tools for carrying out the assertions. They examine the data and verify that the data conforms to specific criteria.</mark></p>
<p>Let’s introduce matchers in the code. We can introduce a set of diverse matchers, each implementing the <code>Matcher</code> trait to work with specific data types.
The important part is that we will only be implementing matchers to deal with positive assertions.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> trait</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>Matcher</code> is the base trait that works on any generic type <code>T</code>. It defines a method <code>test</code> that returns an instance of <code>MatcherResult</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> MatcherResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    passed</span><span style="color:#F97583">:</span><span style="color:#B392F0"> bool</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    failure_message</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    inverted_failure_message</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>MatcherResult</code> which will play a crucial role in inverting a matcher.</p>
<p>Let’s implement <code>MembershipMatcher</code> for the <code>String</code> type. It should be capable of asserting:</p>
<ul>
<li>if the given string contains a digit.</li>
<li>if the given string contains the specified character.</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    ADigit</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Char</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">for</span><span style="color:#B392F0"> MembershipMatcher</span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> AsRef</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        match</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">            MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">ADigit</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#F97583">::</span><span style="color:#B392F0">formatted</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">                value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">chars</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">any</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">ch</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> ch</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_numeric</span><span style="color:#E1E4E8">()),</span></span>
<span class="line"><span style="color:#B392F0">                format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should contain a digit"</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">()),</span></span>
<span class="line"><span style="color:#B392F0">                format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should not contain a digit"</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">()),</span></span>
<span class="line"><span style="color:#E1E4E8">            ),</span></span>
<span class="line"><span style="color:#B392F0">            MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">Char</span><span style="color:#E1E4E8">(ch) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#F97583">::</span><span style="color:#B392F0">formatted</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">                value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">chars</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">any</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">source</span><span style="color:#F97583">|</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">source </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> ch),</span></span>
<span class="line"><span style="color:#B392F0">                format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should contain the character {:?}"</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">(), ch),</span></span>
<span class="line"><span style="color:#B392F0">                format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should not contain the character {:?}"</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">(), ch),</span></span>
<span class="line"><span style="color:#E1E4E8">            ),</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> contain_a_digit</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">ADigit</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> contain_a_character</span><span style="color:#E1E4E8">(ch</span><span style="color:#F97583">:</span><span style="color:#B392F0"> char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">Char</span><span style="color:#E1E4E8">(ch)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>A few things to observe:</p>
<ul>
<li><code>MembershipMatcher</code> implements the trait <code>Matcher&#x3C;T></code> for any <code>T</code> which can be represented as string.</li>
<li>We use enum to represent <code>MembershipMatcher</code> because it allows logical grouping of matchers and each enum variant can hold its own data.</li>
<li>Each arm of the <code>match</code> expression returns an appropriate instance of <code>MatcherResult</code>.</li>
<li>We also provide public functions to get appropriate instances of <code>MembershipMatcher</code>.</li>
<li><code>MembershipMatcher</code> only implements positive assertions.</li>
<li><code>MembershipMatcher</code> also knows about the error messages that should be returned if the assertion(s) using this matcher fails.</li>
</ul>
<p>Time to add a few tests.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#F97583"> crate::</span><span style="color:#E1E4E8">{contain_a_character, contain_a_digit, </span><span style="color:#B392F0">Matcher</span><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> matcher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> contain_a_digit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">        assert!</span><span style="color:#E1E4E8">(matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#9ECBFF">"password@1"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_char</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> matcher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> contain_a_character</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'@'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">        assert!</span><span style="color:#E1E4E8">(matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#9ECBFF">"password@1"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>It is a decent start to matchers but we still need to answer a few questions:</p>
<ul>
<li>How to connect assertions and matchers?</li>
<li>How to invert a matcher?</li>
<li>How to compose matchers?</li>
</ul>
<h3 id="connecting-assertions-and-matchers---using-blanket-trait-and-trait-object">Connecting assertions and matchers - using blanket trait and trait object</h3>
<p>We have <strong>assertions</strong> which serve as the cornerstone of the test cases, defining the exact expectations the code must fulfill.
They act as a contract, ensuring that each data type (/data structure) adheres to its intended behavior.</p>
<p>We also have <strong>matchers</strong> which provide the granular tools for carrying out the assertions. They examine the data and
verify that the data conforms to specific criteria.</p>
<p>Let’s take a look at the relationship between assertions and matchers.</p>
<div class="align-center-exclude-width-change">
    <img src="/assertions-matchers.webp" alt="relationship between assertions and matchers">
</div>
<p>We will have positive and negative assertions both of which use positive matchers. The bridge (<em>which is yet to be built</em>) will connect matchers with assertions
and invert the matcher if a negative assertion like <code>should_not_contain_a_digit</code> is invoked.</p>
<p>Let’s build the bridge using <a href="#leveraging-blanket-trait-implementation">blanket trait</a>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> trait</span><span style="color:#B392F0"> Should</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, matcher</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">Should</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">for</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, matcher</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>) {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> matcher_result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">matcher_result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"assertion failed: {}"</span><span style="color:#E1E4E8">, matcher_result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">failure_message);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We provide a trait <code>Should</code> which is implemented for any <code>T</code>.</p>
<blockquote>
<p>We can also implement the trait <code>Should</code> for any <code>T: Assertion</code> where <code>Assertion</code> can be a base marker trait for all the assertions.</p>
</blockquote>
<p>The method <code>should</code> takes a matcher as a parameter, invokes the test method passing <code>self</code> as the argument and panics if the matcher fails.</p>
<p>The method <code>should</code> takes a parameter <code>matcher: &#x26;dyn Matcher&#x3C;T></code> which is a trait object in Rust. The <a href="https://doc.rust-lang.org/book/ch17-02-trait-objects.html">trait object</a>
points to both an instance of a type implementing a trait and a table that is used to look up trait methods on that type at runtime.
We create a trait object by specifying either <code>&#x26;</code> reference or a <code>Box&#x3C;T></code> smart pointer, then the <code>dyn</code> keyword, and then specifying the relevant trait.</p>
<blockquote>
<p>When we use trait objects, Rust must use <a href="https://doc.rust-lang.org/book/ch17-02-trait-objects.html">dynamic dispatch</a>.</p>
</blockquote>
<p>The expression <code>dyn Matcher&#x3C;T></code> refers to any <code>Matcher</code> of type <code>T</code> and is unsized. Rust compiler needs all the method parameters to have a fixed size,
hence we use <code>reference to any Matcher&#x3C;T> -> matcher: &#x26;dyn Matcher&#x3C;T></code>.</p>
<p>Similarly, we can define a trait that inverts the given matcher.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> trait</span><span style="color:#B392F0"> ShouldNot</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, matcher</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">ShouldNot</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">for</span><span style="color:#B392F0"> T</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, matcher</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>) {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> matcher_result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> passed </span><span style="color:#F97583">=</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">matcher_result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">passed {</span></span>
<span class="line"><span style="color:#B392F0">            panic!</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">                "assertion failed: {}"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                matcher_result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">inverted_failure_message</span></span>
<span class="line"><span style="color:#E1E4E8">            );</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We can now refactor the methods <code>should_contain_a_digit</code> and <code>should_not_contain_a_digit</code> of the <code>MembershipAssertion</code> to use the <code>MembershipMatcher</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">MembershipAssertion</span><span style="color:#F97583"> for</span><span style="color:#B392F0"> T</span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> AsRef</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">+</span><span style="color:#B392F0"> Debug</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">        //the method `should` passes self (which in this case is &#x26;str) </span></span>
<span class="line"><span style="color:#6A737D">        //to the test method of the matcher.</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">contain_a_digit</span><span style="color:#E1E4E8">()); </span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_not_contain_a_digit</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">        //the method `should_not` passes self (which in this case is &#x26;str) </span></span>
<span class="line"><span style="color:#6A737D">        //to the test method of the matcher.</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_not</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">contain_a_digit</span><span style="color:#E1E4E8">()); </span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>All the tests pass and we can now commit :).</p>
<p>There is a question on matchers that needs to be answered. Should our matchers take the ownership of the extra data that they may need or should they hold a reference?</p>
<p>Let’s understand this.</p>
<p>Remember our traits <code>Should</code> and <code>ShouldNot</code> pass <code>&#x26;self</code> to the <code>test</code> method of the matcher.
This means if we invoke the method <code>should_contain_a_digit</code> on the <code>String</code> type, the test method of our <code>MembershipMatcher</code> will receive
a reference to <code>String</code>.</p>
<p>Let’s consider that our string <code>MembershipMatcher</code> starts providing support for testing whether a string contains any of the given characters.
Should the matcher now hold a reference to a slice of char or a vector of char?</p>
<p><strong>Option1</strong>: <code>MembershipMatcher</code> provides an enum variant <code>AnyChars</code> which holds a reference to a slice of char.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">    ADigit</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Char</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    AnyChars</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">])</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><strong>Option2</strong>: <code>MembershipMatcher</code> provides an enum variant <code>AnyChars</code> which holds a vector of char.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    ADigit</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Char</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    AnyChars</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">>),</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Time to discuss lifetimes.</p>
<h3 id="matchers-and-lifetimes">Matchers and lifetimes</h3>
<p>Every reference in Rust has a lifetime, which is the stretch of the program for which the reference is valid. A <strong>reference</strong> can be treated as a <strong>pointer managed by Rust</strong>.
We have already seen a reference in the form of <code>&#x26;str</code>.</p>
<blockquote>
<p>Rust does not have nil or dangling references.</p>
</blockquote>
<p>Consider the below code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() { </span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> reference</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">i32</span><span style="color:#E1E4E8">;                </span><span style="color:#F97583">|</span><span style="color:#F97583"> ---</span><span style="color:#E1E4E8"> '</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8"> starts            </span></span>
<span class="line"><span style="color:#E1E4E8">    {                                   </span><span style="color:#F97583">|</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> value</span><span style="color:#F97583">:</span><span style="color:#B392F0"> i32</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">;            </span><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#F97583"> ---</span><span style="color:#E1E4E8"> '</span><span style="color:#B392F0">b</span><span style="color:#E1E4E8"> starts</span></span>
<span class="line"><span style="color:#E1E4E8">        reference </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">value;             </span><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#F97583"> ---</span><span style="color:#E1E4E8"> '</span><span style="color:#B392F0">b</span><span style="color:#E1E4E8"> ends</span></span>
<span class="line"><span style="color:#E1E4E8">    }                                   </span><span style="color:#F97583">|</span></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{}"</span><span style="color:#E1E4E8">, reference);          </span><span style="color:#F97583">|</span><span style="color:#F97583"> ---</span><span style="color:#E1E4E8"> '</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8"> ends      </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The code above creates a variable <code>reference</code> that refers to an <code>i32</code>. We use the lifetime annotations <code>'a</code> and <code>'b</code> to denote the lifetimes of
<code>reference</code> and <code>value</code>. Rust does not allow dangling references that means the variable <code>reference</code> can not outlive <code>value</code>. This can also be stated
as: “the lifetime of the variable <code>reference</code> must be less than or equal to the lifetime of the variable <code>value</code>”. <mark class="author-highlight">The lifetime of a reference must be less than or equal to the lifetime of the value it refers to.</mark></p>
<p>The above code fails with the the following error:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">    reference </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">value;</span></span>
<span class="line"><span style="color:#F97583">                ^^^^^^</span><span style="color:#E1E4E8"> borrowed value does not live long enough</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    Here</span><span style="color:#E1E4E8">, `value` is dropped </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> soon </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> the inner block ends, but `reference` lives </span></span>
<span class="line"><span style="color:#E1E4E8">    through the scope of the function</span><span style="color:#F97583">.</span><span style="color:#B392F0"> If</span><span style="color:#E1E4E8"> this were permitted, </span><span style="color:#B392F0">Rust</span><span style="color:#E1E4E8"> would end up with </span></span>
<span class="line"><span style="color:#E1E4E8">    dangling references</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">  </span></span></code></pre>
<blockquote>
<p>Lifetimes in Rust ensure that all the references and the container objects holding references are always valid.</p>
</blockquote>
<p>Let’s get back to our question: Should our matchers hold a reference to the extra data or take the ownership?</p>
<p>We will an attempt to design matchers using references (<strong>Option1</strong>), which means our <code>MembershipMatcher</code> will now have lifetime annotation.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">    ADigit</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Char</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    AnyChars</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">])</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The <code>MembershipMatcher</code> holds a reference to a slice of char for some lifetime <code>'a</code>. This means:</p>
<ul>
<li><code>MembershipMatcher</code> must live for the stretch of the program which is <strong>at most</strong> as big as the stretch defined by <code>'a</code>.</li>
<li><code>MembershipMatcher</code> must not outlive the reference</li>
</ul>
<p>This decision requires us to make the following changes:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">for</span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#F97583">    where</span><span style="color:#B392F0"> T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> AsRef</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">></span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        match</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            //skipping ADigit and Char variants</span></span>
<span class="line"><span style="color:#B392F0">            MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">AnyChars</span><span style="color:#E1E4E8">(chars) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#F97583">::</span><span style="color:#B392F0">formatted</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">                chars</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">any</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">ch</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">contains</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">ch)),</span></span>
<span class="line"><span style="color:#B392F0">                format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should contain any of the characters {:?}"</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">(), chars),</span></span>
<span class="line"><span style="color:#B392F0">                format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?} should not contain any of the characters {:?}"</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_ref</span><span style="color:#E1E4E8">(), chars),</span></span>
<span class="line"><span style="color:#E1E4E8">            )</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> contain_a_digit</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">>() </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">    MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">ADigit</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> contain_a_character</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">>(ch</span><span style="color:#F97583">:</span><span style="color:#B392F0"> char</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">    MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">Char</span><span style="color:#E1E4E8">(ch)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> contain_any_characters</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">>(chars</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">char</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MembershipMatcher</span><span style="color:#E1E4E8">&#x3C;'</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">    MembershipMatcher</span><span style="color:#F97583">::</span><span style="color:#B392F0">AnyChars</span><span style="color:#E1E4E8">(chars)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We have introduced lifetime annotation <code>'a</code> in the <code>impl</code>, the public methods <code>contain_a_digit</code>, <code>contain_a_character</code> and  <code>contain_any_characters</code>.
This lifetime annotation tells the compiler that <code>MembershipMatcher</code> lives for the duration defined by <code>'a</code>, which in turn is the lifetime
of the character slice.</p>
<blockquote>
<p>The lifetime defined in the last method <code>contain_any_characters</code> can be removed. Historically, all the rust methods with reference(s) as
parameter(s) required the developers to specify lifetime annotation(s). With time, rust developers saw some some common patterns and created
a set of lifetime elision rules. One of those rules states: if a function accepts a single reference parameter, then the
lifetime of that reference will be assigned as the lifetime of the return value.</p>
</blockquote>
<p>We can now add a test.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> matcher_tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_any_chars</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> matcher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> contain_any_characters</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#9ECBFF">'@'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'#'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'.'</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"><span style="color:#B392F0">        assert!</span><span style="color:#E1E4E8">(matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#9ECBFF">"password@1"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This works fine.</p>
<p>Let’s play with matchers and lifetimes for a bit by adding a few tests.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_any_chars</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> matcher;                                            </span></span>
<span class="line"><span style="color:#E1E4E8">        {                                                       </span></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> chars </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#9ECBFF">'@'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'#'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'.'</span><span style="color:#E1E4E8">];                       </span></span>
<span class="line"><span style="color:#E1E4E8">            matcher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> contain_any_characters</span><span style="color:#E1E4E8">(chars);            </span></span>
<span class="line"><span style="color:#E1E4E8">        }                                                           </span></span>
<span class="line"><span style="color:#B392F0">        assert!</span><span style="color:#E1E4E8">(matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#9ECBFF">"password@1"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed);            </span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>We declare a <code>matcher</code> variable in the outer block, which is initialized in the inner block. We would like the character slice to live at least as long as the matcher,
otherwise <code>matcher</code> would point to a dropped character slice.</p>
<p>It might appear that <code>chars</code> will be dropped as soon as the inner block ends, and the above code will not compile.
However, Rust extends the lifetime of <code>chars</code> to match the lifetime of the variable <code>matcher</code> which is till the end of the function.
The above code compiles just fine.</p>
<p>Let’s take another example where Rust results in compilation error. It is a slight change in the test, but an important one.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_contain_any_chars_compiler_error</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> matcher;</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> chars </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">'@'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'#'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'.'</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">            matcher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> contain_any_characters</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">chars);</span></span>
<span class="line"><span style="color:#F97583">                                             ^^^^^^</span><span style="color:#E1E4E8"> borrowed value does not live long enough</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#B392F0">        assert!</span><span style="color:#E1E4E8">(matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#9ECBFF">"password@1"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed); </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> chars dropped here </span><span style="color:#F97583">while</span><span style="color:#E1E4E8"> still borrowed</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Here, we declare <code>chars</code> as an array, and its reference is passed to the function <code>contain_any_characters</code>. Rust will drop <code>chars</code> array at the end
of the inner block, however <code>matcher</code> outlives the reference. Rust does not allow dangling references and thus it results in a compilation error.</p>
<p>Question, how do we decide if matchers should have a reference of the extra data or own the data?</p>
<p>We need to answer a few questions to take this decision:</p>
<ol>
<li>This crate will be used in testing (unit/integration/functional/any other). Is it ok if a matcher takes the ownership of extra data?</li>
<li>Do you care about the consistency of ownership vs borrow concept? Do you want all the matchers to refer to extra data or take ownership?</li>
<li>Are you going to build a concept that <a href="#matcher-composition">combines various matchers</a> and can the lifetimes of various matchers cause any problems?</li>
</ol>
<p>I recently finished an assertions crate called <a href="https://github.com/SarthakMakhija/clearcheck">clearcheck</a> and I decided to have matchers own their data. My decision was primarily
based on point 1.</p>
<h3 id="matcher-composition--using-trait-objects">Matcher composition : using trait objects</h3>
<p>We now have matcher as a citizen in the code. I think it is worth building a concept that allows composition of various matchers using operators like:
<strong>and</strong>, <strong>or</strong>.</p>
<p>We can introduce an abstraction <code>Matchers</code> that contains a collection of objects which implement <code>Matcher&#x3C;T></code> trait.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">enum</span><span style="color:#B392F0"> Kind</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    And</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    Or</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> Matchers</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">M</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>> {</span></span>
<span class="line"><span style="color:#E1E4E8">    matchers</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">M</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    kind</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Kind</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    inner</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PhantomData</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Our first attempt is to create a <code>Matchers</code> abstraction that holds a vector of <code>M</code>, where <code>M</code> is a <code>Matcher</code> that operates on a <code>T</code>.</p>
<p>We need to understand how generics are processed in Rust to understand an issue with this design. In Rust, generics undergo <a href="https://rustc-dev-guide.rust-lang.org/backend/monomorph.html">monomorphization</a> which means the compiler produces a different copy of the generic code for each concrete type needed. This means if the generic type <code>Option&#x3C;T></code> is used with <code>f64</code> and <code>i32</code>,
the compiler will produce two copies of <code>Option</code>, which would be similar to <code>Option_f64</code> and <code>Option_i32</code>.</p>
<p>Given our definition of <code>Matchers</code>, Rust will emit different copies of <code>Matchers</code> for each concrete type of <code>Matcher</code>. This also means that Rust
will not allow us to combine different types of matcher objects like <code>MembershipMatcher</code> and <code>SubstringMatcher</code> using generics, even if all of them implement the <code>Matcher&#x3C;T></code> trait for the same <code>T</code>.</p>
<p>So, we need a different way to combine matchers. We have already seen <a href="#connecting-assertions-and-matchers---using-blanket-trait-and-trait-object">trait objects</a>,
which point to both an instance of a type implementing a trait and a table that is used to look up trait methods on that type at runtime.
We create a trait object by specifying either <code>&#x26;</code> reference or a <code>Box&#x3C;T></code> smart pointer, then the <code>dyn</code> keyword, and then specifying the relevant trait.
Trait objects enable storing objects (inside a struct) regardless of their specific types, as long as they fulfill the required behavior specified by a trait.</p>
<p>We can now represent <code>Matchers</code> using a vector of trait objects, which implement the <code>Matcher&#x3C;T></code> trait.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> Matchers</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    matchers</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>>>,</span></span>
<span class="line"><span style="color:#E1E4E8">    kind</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Kind</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Let’s now implement a builder to create a <code>Matchers</code> object.</p>
<p>(<em>I am only going to describe the <strong>and</strong> operator, and <strong>positive assertions</strong></em>.
You can refer the code <a href="https://github.com/SarthakMakhija/clearcheck/blob/main/src/matchers/compose/mod.rs">here</a> for composition with inverted assertions.)</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> MatchersBuilder</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    matchers</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>>>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Debug</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">MatchersBuilder</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> start_building</span><span style="color:#E1E4E8">(matcher</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>>) </span><span style="color:#F97583">-></span><span style="color:#79B8FF"> Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        MatchersBuilder</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            matchers</span><span style="color:#F97583">:</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[matcher]</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> push</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">, matcher</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">dyn</span><span style="color:#B392F0"> Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">>>) </span><span style="color:#F97583">-></span><span style="color:#79B8FF"> Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">matchers</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(matcher);</span></span>
<span class="line"><span style="color:#79B8FF">        self</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> combine_as_and</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Matchers</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">        Matchers</span><span style="color:#F97583">::</span><span style="color:#B392F0">and</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">matchers)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>MatchersBuilder</code> allows composing multiple matchers and it can be used as following:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#B392F0">MatchersBuilder</span><span style="color:#F97583">::</span><span style="color:#B392F0">start_building</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Box</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">contain_a_digit</span><span style="color:#E1E4E8">()))</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Box</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">contain_any_characters</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#9ECBFF">'#'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'&#x26;'</span><span style="color:#E1E4E8">])))</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Box</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">contain_a_character</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'0'</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#F97583">    .</span><span style="color:#B392F0">combine_as_and</span><span style="color:#E1E4E8">()</span></span></code></pre>
<p>Finally, <code>Matchers</code> is going to implement the <code>Matcher&#x3C;T></code> trait. This is what makes the crate really powerful.
Anyone can create their custom matcher using composition and use it in the assertion(s) of their choice.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Debug</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">Matcher</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">for</span><span style="color:#B392F0"> Matchers</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> results </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> self</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#E1E4E8">matchers</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">matcher</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> matcher</span><span style="color:#F97583">.</span><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(value))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">collect</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;_>>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        match</span><span style="color:#79B8FF"> self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">kind {</span></span>
<span class="line"><span style="color:#B392F0">            Kind</span><span style="color:#F97583">::</span><span style="color:#B392F0">And</span><span style="color:#F97583"> =></span><span style="color:#B392F0"> MatcherResult</span><span style="color:#F97583">::</span><span style="color:#B392F0">formatted</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">                results</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">all</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">result</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed),</span></span>
<span class="line"><span style="color:#B392F0">                messages</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">                    &#x26;</span><span style="color:#E1E4E8">results,</span></span>
<span class="line"><span style="color:#F97583">                    |</span><span style="color:#E1E4E8">result</span><span style="color:#F97583">|</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed,</span></span>
<span class="line"><span style="color:#F97583">                    |</span><span style="color:#E1E4E8">result</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">failure_message</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                ),</span></span>
<span class="line"><span style="color:#B392F0">                messages</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">                    &#x26;</span><span style="color:#E1E4E8">results,</span></span>
<span class="line"><span style="color:#F97583">                    |</span><span style="color:#E1E4E8">result</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">passed,</span></span>
<span class="line"><span style="color:#F97583">                    |</span><span style="color:#E1E4E8">result</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> result</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">inverted_failure_message</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                ),</span></span>
<span class="line"><span style="color:#E1E4E8">            ),</span></span>
<span class="line"><span style="color:#6A737D">            //Kind::Or skipped</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> messages</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">P</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">M</span><span style="color:#E1E4E8">>(results</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">MatcherResult</span><span style="color:#E1E4E8">], predicate</span><span style="color:#F97583">:</span><span style="color:#B392F0"> P</span><span style="color:#E1E4E8">, mapper</span><span style="color:#F97583">:</span><span style="color:#B392F0"> M</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> String</span></span>
<span class="line"><span style="color:#F97583">    where</span></span>
<span class="line"><span style="color:#B392F0">        P</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Fn</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#B392F0">MatcherResult</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> bool</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">        M</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Fn</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">MatcherResult</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    results</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(predicate)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(mapper)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">collect</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;_>>()</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">join</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The <code>test</code> method runs all the matchers and collects <code>MatcherResult</code>s. It then produces an instance of <code>MatcherResult</code> based on the <code>Kind</code>.</p>
<p>Let’s see the concept of custom matchers in action.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> custom_string_matchers_tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">fmt</span><span style="color:#F97583">::</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#F97583"> crate::</span><span style="color:#E1E4E8">{contain_a_character, contain_a_digit, contain_any_characters, </span><span style="color:#B392F0">Matchers</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">MatchersBuilder</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Should</span><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> be_a_valid_password</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#F97583">:</span><span style="color:#B392F0"> AsRef</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">+</span><span style="color:#B392F0"> Debug</span><span style="color:#E1E4E8">>() </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Matchers</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#B392F0">        MatchersBuilder</span><span style="color:#F97583">::</span><span style="color:#B392F0">start_building</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Box</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">contain_a_digit</span><span style="color:#E1E4E8">()))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Box</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">contain_any_characters</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#9ECBFF">'#'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'&#x26;'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'@'</span><span style="color:#E1E4E8">])))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Box</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">contain_a_character</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'0'</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#F97583">            .</span><span style="color:#B392F0">combine_as_and</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    trait</span><span style="color:#B392F0"> PasswordAssertion</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        fn</span><span style="color:#B392F0"> should_be_a_valid_password</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    impl</span><span style="color:#B392F0"> PasswordAssertion</span><span style="color:#F97583"> for</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        fn</span><span style="color:#B392F0"> should_be_a_valid_password</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#F97583"> &#x26;</span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">            self</span><span style="color:#F97583">.</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">be_a_valid_password</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#79B8FF">            self</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> should_be_a_valid_password</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> password </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "P@@sw0rd9082"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        password</span><span style="color:#F97583">.</span><span style="color:#B392F0">should_be_a_valid_password</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This involves the following:</p>
<ul>
<li>Creating a custom password matcher.</li>
<li>Creating a custom password assertion.</li>
<li>Implementing the password assertion for <code>&#x26;str</code>.</li>
<li>Leveraging the custom matcher in the assertion using the built-in trait <code>Should</code>.</li>
</ul>
<p>That’s it folks. We have arrived at the end of the article. I hope it was worth your time.</p>
<p>I have an assertions crate called <a href="https://github.com/SarthakMakhija/clearcheck">clearcheck</a>. Do take a look if the concepts that were discussed in the article excite you.</p>
<h3 id="references">References</h3>
<ul>
<li><a href="https://doc.rust-lang.org/book/">The Rust Programming Language</a></li>
<li><a href="https://www.oreilly.com/library/view/programming-rust-2nd/9781492052586/">Programming Rust</a></li>
<li><a href="https://stackoverflow.com/questions/24158114/what-are-the-differences-between-rusts-string-and-str">String types</a></li>
</ul> </div> <!-- Tags Section --> <div class="mt-12 pt-8 border-t border-zinc-100"> <div class="flex flex-wrap gap-3"> <div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Rust </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Assertions </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Elegant-assertions </div><div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path> <path d="M7 7h.01"></path> </svg> Clearcheck </div> </div> </div> <!-- Related Essays --> <div class="mt-12 pt-8 border-t border-zinc-100"> <h2 class="text-2xl font-bold font-sans mb-6 text-black">
More from Tech Lessons
</h2> <div class="grid gap-6 md:grid-cols-2"> <a href="/en/blog/designing_lfu_cache/" class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"> <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2"> Designing an in-memory LFU cache </h3> <div class="text-sm text-zinc-500 font-sans"> <time datetime="2023-05-26T00:00:00.000Z" class="text-zinc-400"> May 26, 2023 </time> </div> </a> </div> </div> <!-- Giscus Comments --> <div class="mt-16 pt-8 border-t border-zinc-100"> <script src="https://giscus.app/client.js" data-repo="SarthakMakhija/tech-lessons-comments" data-repo-id="R_kgDOJHu3mA" data-category="Announcements" data-category-id="DIC_kwDOJHu3mM4CUxhS" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script> </div> </div> <!-- Sidebar TOC (Desktop Only) --> <aside class="hidden lg:block sticky top-24 pt-8 max-h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar"> <div class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 font-sans">
On this page
</div> <ul class="space-y-2 list-none m-0 p-0 text-zinc-600"> <li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introduction" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introduction </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-string-str-and-str-types" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding String, &amp;str and str types </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#beginning-with-extension-methods" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Beginning with extension methods </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#understanding-asref" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Understanding AsRef </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#leveraging-blanket-trait-implementation" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Leveraging blanket trait implementation </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#introducing-matchers" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Introducing Matchers </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#subtle-duplication" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Subtle duplication </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-6"> <a href="#the-lack-of-ability-to-compose-assertions" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> The lack of ability to compose assertions </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#connecting-assertions-and-matchers---using-blanket-trait-and-trait-object" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Connecting assertions and matchers - using blanket trait and trait object </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#matchers-and-lifetimes" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Matchers and lifetimes </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#matcher-composition--using-trait-objects" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> Matcher composition : using trait objects </a> </li><li class="flex gap-3 items-start text-[14px] leading-[21px] ml-3"> <a href="#references" class="hover:text-accent-600 hover:translate-x-1 transition-all duration-200 ease-in-out"> References </a> </li> </ul> </aside> </div> </article>  </main> <footer class="border-t border-slate-800 bg-slate-900 py-8 text-center text-sm text-zinc-500"> <div class="container mx-auto px-4">
tech-lessons.in &copy; 2020 / Powered by <a href="https://astro.build" target="_blank" class="hover:text-zinc-300 transition-colors">Astro</a> </div> </footer> </div> <!-- Subtle gradient glow at the bottom/edges (optional, keeping it really subtle) --> <div class="fixed inset-0 pointer-events-none z-[-1] bg-[radial-gradient(circle_at_50%_120%,rgba(120,119,198,0.1),rgba(255,255,255,0))]"></div> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.Ci7t3JeA.js"></script> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre").forEach(t=>{const e=document.createElement("button");e.className="copy-code-button",e.innerHTML=`
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
							<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
						</svg>
					`,e.ariaLabel="Copy code";const r=document.createElement("div");r.className="code-block-wrapper relative group",t.parentNode&&(t.parentNode.insertBefore(r,t),r.appendChild(t),r.appendChild(e)),e.addEventListener("click",async()=>{const o=t.querySelector("code")?.innerText||t.innerText;try{await navigator.clipboard.writeText(o),e.innerHTML=`
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500">
									<polyline points="20 6 9 17 4 12"></polyline>
								</svg>
							`,setTimeout(()=>{e.innerHTML=`
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
										<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								`},2e3)}catch(n){console.error("Failed to copy:",n)}})})});</script>  </body> </html>